
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>pynbody.snapshot.tipsy &#8212; pynbody 1.0.0 documentation</title>
    <link rel="stylesheet" href="../../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/graphviz.css" />
    <script id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />

   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

<link href="https://fonts.googleapis.com/css?family=Quicksand" rel="stylesheet">
<link href="_static/customise.css" rel="stylesheet">
<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-38063425-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for pynbody.snapshot.tipsy</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;tipsy</span>
<span class="sd">=====</span>

<span class="sd">Implements classes and functions for handling tipsy files.  You rarely</span>
<span class="sd">need to access this module directly as it will be invoked</span>
<span class="sd">automatically via pynbody.load.</span>

<span class="sd">**Input**:</span>

<span class="sd">*filename*: file name string</span>

<span class="sd">**Optional Keywords**:</span>

<span class="sd">*paramfile*: string specifying the parameter file to load. If not</span>
<span class="sd">specified, the loader will look for a file `*.param` in the current and</span>
<span class="sd">parent directories.</span>

<span class="sd">&quot;&quot;&quot;</span>

  <span class="c1"># for py2.5</span>


<span class="kn">from</span> <span class="nn">..</span> <span class="kn">import</span> <span class="n">array</span><span class="p">,</span> <span class="n">util</span>
<span class="kn">from</span> <span class="nn">..</span> <span class="kn">import</span> <span class="n">family</span>
<span class="kn">from</span> <span class="nn">..</span> <span class="kn">import</span> <span class="n">units</span>
<span class="kn">from</span> <span class="nn">..</span> <span class="kn">import</span> <span class="n">config</span><span class="p">,</span> <span class="n">config_parser</span>
<span class="kn">from</span> <span class="nn">..</span> <span class="kn">import</span> <span class="n">chunk</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">nchilada</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">SimSnap</span>

<span class="kn">import</span> <span class="nn">struct</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">gzip</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">types</span>
<span class="kn">import</span> <span class="nn">math</span>

<span class="kn">import</span> <span class="nn">logging</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;pynbody.snapshot.tipsy&#39;</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">TipsySnap</span><span class="p">(</span><span class="n">SimSnap</span><span class="p">):</span>
    <span class="n">_basic_loadable_keys</span> <span class="o">=</span> <span class="p">{</span><span class="n">family</span><span class="o">.</span><span class="n">dm</span><span class="p">:</span> <span class="nb">set</span><span class="p">([</span><span class="s1">&#39;phi&#39;</span><span class="p">,</span> <span class="s1">&#39;pos&#39;</span><span class="p">,</span> <span class="s1">&#39;eps&#39;</span><span class="p">,</span> <span class="s1">&#39;mass&#39;</span><span class="p">,</span> <span class="s1">&#39;vel&#39;</span><span class="p">]),</span>
                            <span class="n">family</span><span class="o">.</span><span class="n">gas</span><span class="p">:</span> <span class="nb">set</span><span class="p">([</span><span class="s1">&#39;phi&#39;</span><span class="p">,</span> <span class="s1">&#39;temp&#39;</span><span class="p">,</span> <span class="s1">&#39;pos&#39;</span><span class="p">,</span> <span class="s1">&#39;metals&#39;</span><span class="p">,</span> <span class="s1">&#39;eps&#39;</span><span class="p">,</span>
                                             <span class="s1">&#39;mass&#39;</span><span class="p">,</span> <span class="s1">&#39;rho&#39;</span><span class="p">,</span> <span class="s1">&#39;vel&#39;</span><span class="p">]),</span>
                            <span class="n">family</span><span class="o">.</span><span class="n">star</span><span class="p">:</span> <span class="nb">set</span><span class="p">([</span><span class="s1">&#39;phi&#39;</span><span class="p">,</span> <span class="s1">&#39;tform&#39;</span><span class="p">,</span> <span class="s1">&#39;pos&#39;</span><span class="p">,</span> <span class="s1">&#39;metals&#39;</span><span class="p">,</span>
                                              <span class="s1">&#39;eps&#39;</span><span class="p">,</span> <span class="s1">&#39;mass&#39;</span><span class="p">,</span> <span class="s1">&#39;vel&#39;</span><span class="p">]),</span>
                            <span class="kc">None</span><span class="p">:</span> <span class="nb">set</span><span class="p">([</span><span class="s1">&#39;phi&#39;</span><span class="p">,</span> <span class="s1">&#39;pos&#39;</span><span class="p">,</span> <span class="s1">&#39;eps&#39;</span><span class="p">,</span> <span class="s1">&#39;mass&#39;</span><span class="p">,</span> <span class="s1">&#39;vel&#39;</span><span class="p">])}</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

        <span class="k">global</span> <span class="n">config</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">TipsySnap</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="n">only_header</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;only_header&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">only_header</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="s2">&quot;only_header kwarg is deprecated: all loading in TipsySnap is now lazy by default&quot;</span><span class="p">,</span> <span class="ne">RuntimeWarning</span><span class="p">)</span>

        <span class="n">must_have_paramfile</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;must_have_paramfile&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">take</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;take&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">verbose</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;verbose&#39;</span><span class="p">,</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;verbose&#39;</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">partial_load</span> <span class="o">=</span> <span class="n">take</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_filename</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">cutgz</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

        <span class="n">f</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">open_</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">only_header</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Loading </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>

        <span class="n">t</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">ndim</span><span class="p">,</span> <span class="n">ng</span><span class="p">,</span> <span class="n">nd</span><span class="p">,</span> <span class="n">ns</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s2">&quot;diiiii&quot;</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">28</span><span class="p">))</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">3</span> <span class="ow">or</span> <span class="n">ndim</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_byteswap</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">f</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">t</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">ndim</span><span class="p">,</span> <span class="n">ng</span><span class="p">,</span> <span class="n">nd</span><span class="p">,</span> <span class="n">ns</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s2">&quot;&gt;diiiii&quot;</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">28</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_byteswap</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">assert</span> <span class="n">ndim</span> <span class="o">==</span> <span class="mi">3</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_header_t</span> <span class="o">=</span> <span class="n">t</span>

        <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>

        <span class="n">disk_family_slice</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">({</span><span class="n">family</span><span class="o">.</span><span class="n">gas</span><span class="p">:</span> <span class="nb">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ng</span><span class="p">),</span>
                                  <span class="n">family</span><span class="o">.</span><span class="n">dm</span><span class="p">:</span> <span class="nb">slice</span><span class="p">(</span><span class="n">ng</span><span class="p">,</span> <span class="n">nd</span> <span class="o">+</span> <span class="n">ng</span><span class="p">),</span>
                                  <span class="n">family</span><span class="o">.</span><span class="n">star</span><span class="p">:</span> <span class="nb">slice</span><span class="p">(</span><span class="n">nd</span> <span class="o">+</span> <span class="n">ng</span><span class="p">,</span> <span class="n">ng</span> <span class="o">+</span> <span class="n">nd</span> <span class="o">+</span> <span class="n">ns</span><span class="p">)})</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_load_control</span> <span class="o">=</span> <span class="n">chunk</span><span class="o">.</span><span class="n">LoadControl</span><span class="p">(</span><span class="n">disk_family_slice</span><span class="p">,</span> <span class="mi">10240</span><span class="p">,</span> <span class="n">take</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_family_slice</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_control</span><span class="o">.</span><span class="n">mem_family_slice</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_num_particles</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_control</span><span class="o">.</span><span class="n">mem_num_particles</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_paramfilename</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;paramfile&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_decorate</span><span class="p">()</span>

        <span class="c1"># describe the file structure as list of (num_parts, [list_of_properties])</span>
        <span class="c1"># by default all fields are floats -- we look at the param file to determine</span>
        <span class="c1"># whether we should expect some doubles</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_paramfile</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;bDoublePos&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span>
            <span class="n">ptype</span> <span class="o">=</span> <span class="s1">&#39;d&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ptype</span> <span class="o">=</span> <span class="s1">&#39;f&#39;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_paramfile</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;bDoubleVel&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span>
            <span class="n">vtype</span> <span class="o">=</span> <span class="s1">&#39;d&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">vtype</span> <span class="o">=</span> <span class="s1">&#39;f&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_g_dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">({</span><span class="s1">&#39;names&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;mass&quot;</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;z&quot;</span><span class="p">,</span> <span class="s2">&quot;vx&quot;</span><span class="p">,</span> <span class="s2">&quot;vy&quot;</span><span class="p">,</span> <span class="s2">&quot;vz&quot;</span><span class="p">,</span> <span class="s2">&quot;rho&quot;</span><span class="p">,</span> <span class="s2">&quot;temp&quot;</span><span class="p">,</span> <span class="s2">&quot;eps&quot;</span><span class="p">,</span> <span class="s2">&quot;metals&quot;</span><span class="p">,</span> <span class="s2">&quot;phi&quot;</span><span class="p">),</span>
                                  <span class="s1">&#39;formats&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;f&#39;</span><span class="p">,</span> <span class="n">ptype</span><span class="p">,</span> <span class="n">ptype</span><span class="p">,</span> <span class="n">ptype</span><span class="p">,</span> <span class="n">vtype</span><span class="p">,</span> <span class="n">vtype</span><span class="p">,</span> <span class="n">vtype</span><span class="p">,</span> <span class="s1">&#39;f&#39;</span><span class="p">,</span> <span class="s1">&#39;f&#39;</span><span class="p">,</span> <span class="s1">&#39;f&#39;</span><span class="p">,</span> <span class="s1">&#39;f&#39;</span><span class="p">,</span> <span class="s1">&#39;f&#39;</span><span class="p">)})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_d_dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">({</span><span class="s1">&#39;names&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;mass&quot;</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;z&quot;</span><span class="p">,</span> <span class="s2">&quot;vx&quot;</span><span class="p">,</span> <span class="s2">&quot;vy&quot;</span><span class="p">,</span> <span class="s2">&quot;vz&quot;</span><span class="p">,</span> <span class="s2">&quot;eps&quot;</span><span class="p">,</span> <span class="s2">&quot;phi&quot;</span><span class="p">),</span>
                                  <span class="s1">&#39;formats&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;f&#39;</span><span class="p">,</span> <span class="n">ptype</span><span class="p">,</span> <span class="n">ptype</span><span class="p">,</span> <span class="n">ptype</span><span class="p">,</span> <span class="n">vtype</span><span class="p">,</span> <span class="n">vtype</span><span class="p">,</span> <span class="n">vtype</span><span class="p">,</span> <span class="s1">&#39;f&#39;</span><span class="p">,</span> <span class="s1">&#39;f&#39;</span><span class="p">)})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_s_dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">({</span><span class="s1">&#39;names&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;mass&quot;</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;z&quot;</span><span class="p">,</span> <span class="s2">&quot;vx&quot;</span><span class="p">,</span> <span class="s2">&quot;vy&quot;</span><span class="p">,</span> <span class="s2">&quot;vz&quot;</span><span class="p">,</span> <span class="s2">&quot;metals&quot;</span><span class="p">,</span> <span class="s2">&quot;tform&quot;</span><span class="p">,</span> <span class="s2">&quot;eps&quot;</span><span class="p">,</span> <span class="s2">&quot;phi&quot;</span><span class="p">),</span>
                                  <span class="s1">&#39;formats&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;f&#39;</span><span class="p">,</span> <span class="n">ptype</span><span class="p">,</span> <span class="n">ptype</span><span class="p">,</span> <span class="n">ptype</span><span class="p">,</span> <span class="n">vtype</span><span class="p">,</span> <span class="n">vtype</span><span class="p">,</span> <span class="n">vtype</span><span class="p">,</span> <span class="s1">&#39;f&#39;</span><span class="p">,</span> <span class="s1">&#39;f&#39;</span><span class="p">,</span> <span class="s1">&#39;f&#39;</span><span class="p">,</span> <span class="s1">&#39;f&#39;</span><span class="p">)})</span>

        <span class="k">if</span> <span class="s1">&#39;dKpcUnit&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_paramfile</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">must_have_paramfile</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Could not find .param file for this run. Place it in the run&#39;s directory or parent directory.&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                    <span class="s2">&quot;No readable param file in the run directory or parent directory: using defaults.&quot;</span><span class="p">,</span> <span class="ne">RuntimeWarning</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_file_units_system</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">units</span><span class="o">.</span><span class="n">Unit</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;G&#39;</span><span class="p">,</span> <span class="s1">&#39;1 kpc&#39;</span><span class="p">,</span> <span class="s1">&#39;1e10 Msol&#39;</span><span class="p">)]</span>

        <span class="n">time_unit</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">time_unit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">infer_original_units</span><span class="p">(</span><span class="s1">&#39;yr&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">units</span><span class="o">.</span><span class="n">UnitsException</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="k">if</span> <span class="n">time_unit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span> <span class="o">*=</span> <span class="n">time_unit</span>

        <span class="k">del</span> <span class="n">f</span>

    <span class="k">def</span> <span class="nf">_load_main_file</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Loading data from main file </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filename</span><span class="p">)</span>

        <span class="n">f</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">open_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_filename</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span>

        <span class="n">write</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">w</span><span class="p">,</span> <span class="n">ndim</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;pos&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;vel&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;mass&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;eps&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;phi&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">w</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_create_array</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">ndim</span><span class="p">,</span> <span class="n">zeros</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">write</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="s2">&quot;rho&quot;</span><span class="p">,</span> <span class="s2">&quot;temp&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">w</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gas</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">gas</span><span class="o">.</span><span class="n">_create_array</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">zeros</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">write</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="s2">&quot;metals&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gas</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span> <span class="ow">and</span> <span class="p">(</span><span class="s2">&quot;metals&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">star</span><span class="o">.</span><span class="n">keys</span><span class="p">())):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gas</span><span class="o">.</span><span class="n">_create_array</span><span class="p">(</span><span class="s2">&quot;metals&quot;</span><span class="p">,</span> <span class="n">zeros</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">star</span><span class="o">.</span><span class="n">_create_array</span><span class="p">(</span><span class="s2">&quot;metals&quot;</span><span class="p">,</span> <span class="n">zeros</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">write</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;metals&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;tform&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">star</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">star</span><span class="o">.</span><span class="n">_create_array</span><span class="p">(</span><span class="s2">&quot;tform&quot;</span><span class="p">,</span> <span class="n">zeros</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">write</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;tform&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;temp&quot;</span> <span class="ow">in</span> <span class="n">write</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gas</span><span class="p">[</span><span class="s2">&quot;temp&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s2">&quot;K&quot;</span>

        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="s2">&quot;pos&quot;</span><span class="p">,</span> <span class="s2">&quot;vel&quot;</span><span class="p">,</span> <span class="s2">&quot;mass&quot;</span><span class="p">,</span> <span class="s2">&quot;eps&quot;</span><span class="p">,</span> <span class="s2">&quot;phi&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">write</span><span class="p">:</span>
                <span class="bp">self</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">set_default_units</span><span class="p">(</span><span class="n">quiet</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># only do this for cosmo runs</span>
        <span class="k">if</span> <span class="s2">&quot;phi&quot;</span> <span class="ow">in</span> <span class="n">write</span> <span class="ow">and</span> <span class="s1">&#39;h&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;phi&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;phi&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">units</span> <span class="o">*</span> <span class="n">units</span><span class="o">.</span><span class="n">a</span> <span class="o">**</span> <span class="o">-</span><span class="mi">3</span>  <span class="c1"># messy :-(</span>

        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="s2">&quot;rho&quot;</span><span class="p">,</span> <span class="s2">&quot;temp&quot;</span><span class="p">,</span> <span class="s2">&quot;metals&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">write</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">gas</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">set_default_units</span><span class="p">(</span><span class="n">quiet</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="s2">&quot;metals&quot;</span><span class="p">,</span> <span class="s2">&quot;tform&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">write</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">star</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">set_default_units</span><span class="p">(</span><span class="n">quiet</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;pos&quot;</span> <span class="ow">in</span> <span class="n">write</span><span class="p">:</span>
            <span class="n">write</span> <span class="o">+=</span> <span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;z&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="s2">&quot;vel&quot;</span> <span class="ow">in</span> <span class="n">write</span><span class="p">:</span>
            <span class="n">write</span> <span class="o">+=</span> <span class="p">[</span><span class="s1">&#39;vx&#39;</span><span class="p">,</span> <span class="s1">&#39;vy&#39;</span><span class="p">,</span> <span class="s1">&#39;vz&#39;</span><span class="p">]</span>

        <span class="n">max_item_size</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span>
            <span class="p">[</span><span class="n">q</span><span class="o">.</span><span class="n">itemsize</span> <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_g_dtype</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_d_dtype</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_s_dtype</span><span class="p">)])</span>
        <span class="n">tbuf</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="n">max_item_size</span> <span class="o">*</span> <span class="mi">10240</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">fam</span><span class="p">,</span> <span class="n">dtype</span> <span class="ow">in</span> <span class="p">((</span><span class="n">family</span><span class="o">.</span><span class="n">gas</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_g_dtype</span><span class="p">),</span> <span class="p">(</span><span class="n">family</span><span class="o">.</span><span class="n">dm</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_d_dtype</span><span class="p">),</span> <span class="p">(</span><span class="n">family</span><span class="o">.</span><span class="n">star</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_s_dtype</span><span class="p">)):</span>
            <span class="n">self_fam</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">fam</span><span class="p">]</span>
            <span class="n">st_len</span> <span class="o">=</span> <span class="n">dtype</span><span class="o">.</span><span class="n">itemsize</span>
            <span class="k">for</span> <span class="n">readlen</span><span class="p">,</span> <span class="n">buf_index</span><span class="p">,</span> <span class="n">mem_index</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_control</span><span class="o">.</span><span class="n">iterate</span><span class="p">([</span><span class="n">fam</span><span class="p">],</span> <span class="p">[</span><span class="n">fam</span><span class="p">],</span> <span class="n">multiskip</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
                <span class="c1"># Read in the block</span>

                <span class="k">if</span> <span class="n">mem_index</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">st_len</span> <span class="o">*</span> <span class="n">readlen</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="k">continue</span>

                <span class="n">buf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fromstring</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">st_len</span> <span class="o">*</span> <span class="n">readlen</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_byteswap</span><span class="p">:</span>
                    <span class="n">buf</span> <span class="o">=</span> <span class="n">buf</span><span class="o">.</span><span class="n">byteswap</span><span class="p">()</span>

                <span class="k">if</span> <span class="n">mem_index</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="c1"># Copy into the correct arrays</span>
                    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">dtype</span><span class="o">.</span><span class="n">names</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">write</span><span class="p">:</span>
                            <span class="n">self_fam</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="n">mem_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="n">buf_index</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_update_loadable_keys</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">is_readable_array</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">f</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">open_</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
                <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">())</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="c1"># could be a binary file</span>
                <span class="n">f</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">open_</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span>

                <span class="n">header</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">header</span><span class="p">)</span><span class="o">!=</span><span class="mi">4</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">False</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_byteswap</span><span class="p">:</span>
                    <span class="n">buflen</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s2">&quot;&gt;i&quot;</span><span class="p">,</span> <span class="n">header</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">buflen</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s2">&quot;i&quot;</span><span class="p">,</span> <span class="n">header</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

                <span class="n">ourlen_1</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_load_control</span><span class="o">.</span><span class="n">disk_num_particles</span><span class="p">)</span><span class="o">&amp;</span> <span class="mh">0xffffffff</span>
                <span class="n">ourlen_3</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_load_control</span><span class="o">.</span><span class="n">disk_num_particles</span><span class="o">*</span><span class="mi">3</span><span class="p">)</span><span class="o">&amp;</span> <span class="mh">0xffffffff</span>

                <span class="k">if</span> <span class="n">buflen</span> <span class="o">==</span> <span class="n">ourlen_1</span><span class="p">:</span>  <span class="c1"># it&#39;s a vector</span>
                    <span class="k">return</span> <span class="kc">True</span>
                <span class="k">elif</span> <span class="n">buflen</span> <span class="o">==</span> <span class="n">ourlen_3</span><span class="p">:</span>  <span class="c1"># it&#39;s an array</span>
                    <span class="k">return</span> <span class="kc">True</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">False</span>

            <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>

        <span class="kn">import</span> <span class="nn">glob</span>

        <span class="n">fs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">util</span><span class="o">.</span><span class="n">cutgz</span><span class="p">,</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_filename</span> <span class="o">+</span> <span class="s2">&quot;.*&quot;</span><span class="p">)))</span>
        <span class="n">res</span> <span class="o">=</span> <span class="p">[</span><span class="n">q</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_filename</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:]</span> <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="n">is_readable_array</span><span class="p">,</span> <span class="n">fs</span><span class="p">))]</span>

        <span class="c1"># Create an empty dictionary of sets to store the loadable</span>
        <span class="c1"># arrays for each family</span>
        <span class="n">rdict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">([(</span><span class="n">x</span><span class="p">,</span> <span class="nb">set</span><span class="p">())</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">families</span><span class="p">()])</span>
        <span class="n">rdict</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">dict</span><span class="p">([</span><span class="n">a</span><span class="p">,</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">b</span><span class="p">)]</span>
                          <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_basic_loadable_keys</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">a</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">))</span>
        <span class="c1"># Now work out which families can load which arrays</span>
        <span class="c1"># according to the stored metadata</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">res</span><span class="p">:</span>
            <span class="n">fams</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_loadable_array_metadata</span><span class="p">(</span><span class="n">r</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">fams</span> <span class="ow">or</span> <span class="nb">list</span><span class="p">(</span><span class="n">rdict</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                <span class="n">rdict</span><span class="p">[</span><span class="n">x</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_loadable_keys_registry</span> <span class="o">=</span> <span class="n">rdict</span>

    <span class="k">def</span> <span class="nf">loadable_keys</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fam</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Produce and return a list of loadable arrays for this TIPSY file.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_loadable_keys_registry</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_update_loadable_keys</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">fam</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Return what is loadable for this family</span>
            <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_loadable_keys_registry</span><span class="p">[</span><span class="n">fam</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Return what is loadable to all families</span>
            <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="o">*</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_loadable_keys_registry</span><span class="o">.</span><span class="n">values</span><span class="p">())))</span>

    <span class="k">def</span> <span class="nf">_update_snapshot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arrays</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fam_out</span><span class="o">=</span><span class="p">[</span><span class="n">family</span><span class="o">.</span><span class="n">gas</span><span class="p">,</span> <span class="n">family</span><span class="o">.</span><span class="n">dm</span><span class="p">,</span> <span class="n">family</span><span class="o">.</span><span class="n">star</span><span class="p">]):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Write a TIPSY file, but only updating the requested information and leaving the</span>
<span class="sd">        rest intact on disk.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">partial_load</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Writing back to partially loaded files not yet supported&quot;</span><span class="p">)</span>

        <span class="k">global</span> <span class="n">config</span>

        <span class="c1"># make arrays be a list</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arrays</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">arrays</span> <span class="o">=</span> <span class="p">[</span><span class="n">arrays</span><span class="p">]</span>

        <span class="c1"># check if arrays includes a 3D array</span>
        <span class="k">if</span> <span class="s1">&#39;pos&#39;</span> <span class="ow">in</span> <span class="n">arrays</span><span class="p">:</span>
            <span class="n">arrays</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;pos&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">arr</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;z&#39;</span><span class="p">]:</span>
                <span class="n">arrays</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;vel&#39;</span> <span class="ow">in</span> <span class="n">arrays</span><span class="p">:</span>
            <span class="n">arrays</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;vel&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">arr</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;vx&#39;</span><span class="p">,</span> <span class="s1">&#39;vy&#39;</span><span class="p">,</span> <span class="s1">&#39;vz&#39;</span><span class="p">]:</span>
                <span class="n">arrays</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">lazy_off</span><span class="p">:</span>
            <span class="n">fin</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">open_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span>
            <span class="n">fout</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">open_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">+</span> <span class="s2">&quot;.tmp&quot;</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_byteswap</span><span class="p">:</span>
                <span class="n">t</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">ndim</span><span class="p">,</span> <span class="n">ng</span><span class="p">,</span> <span class="n">nd</span><span class="p">,</span> <span class="n">ns</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s2">&quot;&gt;diiiii&quot;</span><span class="p">,</span> <span class="n">fin</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">28</span><span class="p">))</span>
                <span class="n">fout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s2">&quot;&gt;diiiiii&quot;</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">ndim</span><span class="p">,</span> <span class="n">ng</span><span class="p">,</span> <span class="n">nd</span><span class="p">,</span> <span class="n">ns</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">t</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">ndim</span><span class="p">,</span> <span class="n">ng</span><span class="p">,</span> <span class="n">nd</span><span class="p">,</span> <span class="n">ns</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s2">&quot;diiiii&quot;</span><span class="p">,</span> <span class="n">fin</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">28</span><span class="p">))</span>
                <span class="n">fout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s2">&quot;diiiiii&quot;</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">ndim</span><span class="p">,</span> <span class="n">ng</span><span class="p">,</span> <span class="n">nd</span><span class="p">,</span> <span class="n">ns</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>

            <span class="n">fin</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">family</span><span class="o">.</span><span class="n">gas</span> <span class="ow">in</span> <span class="n">fam_out</span><span class="p">:</span>
                <span class="k">assert</span><span class="p">(</span><span class="n">ng</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">family</span><span class="o">.</span><span class="n">gas</span><span class="p">]))</span>
            <span class="k">if</span> <span class="n">family</span><span class="o">.</span><span class="n">dm</span> <span class="ow">in</span> <span class="n">fam_out</span><span class="p">:</span>
                <span class="k">assert</span><span class="p">(</span><span class="n">nd</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">family</span><span class="o">.</span><span class="n">dm</span><span class="p">]))</span>
            <span class="k">if</span> <span class="n">family</span><span class="o">.</span><span class="n">star</span> <span class="ow">in</span> <span class="n">fam_out</span><span class="p">:</span>
                <span class="k">assert</span><span class="p">(</span><span class="n">ns</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">family</span><span class="o">.</span><span class="n">star</span><span class="p">]))</span>

            <span class="n">max_block_size</span> <span class="o">=</span> <span class="mi">1024</span> <span class="o">**</span> <span class="mi">2</span>  <span class="c1"># particles</span>

            <span class="c1"># describe the file structure as list of (num_parts,</span>
            <span class="c1"># [list_of_properties])</span>
            <span class="n">file_structure</span> <span class="o">=</span> <span class="p">((</span><span class="n">ng</span><span class="p">,</span> <span class="n">family</span><span class="o">.</span><span class="n">gas</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;mass&quot;</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;z&quot;</span><span class="p">,</span> <span class="s2">&quot;vx&quot;</span><span class="p">,</span> <span class="s2">&quot;vy&quot;</span><span class="p">,</span> <span class="s2">&quot;vz&quot;</span><span class="p">,</span> <span class="s2">&quot;rho&quot;</span><span class="p">,</span> <span class="s2">&quot;temp&quot;</span><span class="p">,</span> <span class="s2">&quot;eps&quot;</span><span class="p">,</span> <span class="s2">&quot;metals&quot;</span><span class="p">,</span> <span class="s2">&quot;phi&quot;</span><span class="p">]),</span>
                              <span class="p">(</span><span class="n">nd</span><span class="p">,</span> <span class="n">family</span><span class="o">.</span><span class="n">dm</span><span class="p">,</span> <span class="p">[</span>
                               <span class="s2">&quot;mass&quot;</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;z&quot;</span><span class="p">,</span> <span class="s2">&quot;vx&quot;</span><span class="p">,</span> <span class="s2">&quot;vy&quot;</span><span class="p">,</span> <span class="s2">&quot;vz&quot;</span><span class="p">,</span> <span class="s2">&quot;eps&quot;</span><span class="p">,</span> <span class="s2">&quot;phi&quot;</span><span class="p">]),</span>
                              <span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="n">family</span><span class="o">.</span><span class="n">star</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;mass&quot;</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;z&quot;</span><span class="p">,</span> <span class="s2">&quot;vx&quot;</span><span class="p">,</span> <span class="s2">&quot;vy&quot;</span><span class="p">,</span> <span class="s2">&quot;vz&quot;</span><span class="p">,</span> <span class="s2">&quot;metals&quot;</span><span class="p">,</span> <span class="s2">&quot;tform&quot;</span><span class="p">,</span> <span class="s2">&quot;eps&quot;</span><span class="p">,</span> <span class="s2">&quot;phi&quot;</span><span class="p">]))</span>

            <span class="c1"># do the read/write -- at each block, replace the relevant array</span>

            <span class="k">for</span> <span class="n">n_left</span><span class="p">,</span> <span class="n">fam</span><span class="p">,</span> <span class="n">st</span> <span class="ow">in</span> <span class="n">file_structure</span><span class="p">:</span>
                <span class="n">n_done</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">self_fam</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">fam</span><span class="p">]</span>
                <span class="k">while</span> <span class="n">n_left</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">n_block</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">n_left</span><span class="p">,</span> <span class="n">max_block_size</span><span class="p">)</span>

                    <span class="c1"># Read in the block</span>
                    <span class="k">if</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_byteswap</span><span class="p">):</span>
                        <span class="n">g</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fromstring</span><span class="p">(</span>
                            <span class="n">fin</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">st</span><span class="p">)</span> <span class="o">*</span> <span class="n">n_block</span> <span class="o">*</span> <span class="mi">4</span><span class="p">),</span> <span class="s1">&#39;f&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">byteswap</span><span class="p">()</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">n_block</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">st</span><span class="p">)))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">g</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fromstring</span><span class="p">(</span>
                            <span class="n">fin</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">st</span><span class="p">)</span> <span class="o">*</span> <span class="n">n_block</span> <span class="o">*</span> <span class="mi">4</span><span class="p">),</span> <span class="s1">&#39;f&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">n_block</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">st</span><span class="p">)))</span>

                    <span class="k">if</span> <span class="n">fam</span> <span class="ow">in</span> <span class="n">fam_out</span><span class="p">:</span>
                        <span class="n">self_sub</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">fam</span><span class="p">][</span><span class="n">n_done</span><span class="p">:</span><span class="n">n_done</span> <span class="o">+</span> <span class="n">n_block</span><span class="p">]</span>
                        <span class="c1"># write over the relevant data</span>
                        <span class="k">with</span> <span class="n">self_sub</span><span class="o">.</span><span class="n">immediate_mode</span><span class="p">:</span>
                            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">st</span><span class="p">):</span>

                                <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">arrays</span><span class="p">:</span>
                                    <span class="n">ar</span> <span class="o">=</span> <span class="n">self_sub</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
                                    <span class="k">try</span><span class="p">:</span>
                                        <span class="k">if</span> <span class="n">ar</span><span class="o">.</span><span class="n">units</span> <span class="o">!=</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">ar</span><span class="o">.</span><span class="n">units</span> <span class="o">!=</span> <span class="n">units</span><span class="o">.</span><span class="n">NoUnit</span><span class="p">():</span>
                                            <span class="n">g</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ar</span><span class="o">.</span><span class="n">in_original_units</span><span class="p">()</span><span class="o">.</span><span class="n">view</span><span class="p">(</span>
                                                <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span>
                                        <span class="k">else</span><span class="p">:</span>
                                            <span class="n">g</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ar</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span>
                                    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                                        <span class="k">pass</span>

                    <span class="c1"># Write out the block</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_byteswap</span><span class="p">:</span>
                        <span class="n">g</span><span class="o">.</span><span class="n">byteswap</span><span class="p">()</span><span class="o">.</span><span class="n">tofile</span><span class="p">(</span><span class="n">fout</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">g</span><span class="o">.</span><span class="n">tofile</span><span class="p">(</span><span class="n">fout</span><span class="p">)</span>

                    <span class="c1"># Increment total ptcls read in, decrement ptcls left of</span>
                    <span class="c1"># this type</span>
                    <span class="n">n_left</span> <span class="o">-=</span> <span class="n">n_block</span>
                    <span class="n">n_done</span> <span class="o">+=</span> <span class="n">n_block</span>

            <span class="n">fin</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">fout</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

            <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&quot;mv &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">+</span> <span class="s2">&quot;.tmp &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">double_pos</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">double_vel</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">binary_aux_arrays</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cosmological</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Write a TIPSY (standard) formatted file.</span>

<span class="sd">        Additionally, you can specify whether you want position and/or</span>
<span class="sd">        velocity arrays written out in double precision. If you are</span>
<span class="sd">        writing out a snapshot that was originally in tipsy format and</span>
<span class="sd">        the bDoublePos/bDoubleVel flags are set in the parameter file,</span>
<span class="sd">        then the write routine will follow those choices. If you are</span>
<span class="sd">        writing a snapshot other than a tipsy snapshot, then you have</span>
<span class="sd">        to specify these by hand.</span>

<span class="sd">        **Optional Keywords**</span>

<span class="sd">        *filename* (None): name of the file to be written out. If</span>
<span class="sd">                           None, the original file is overwritten.</span>

<span class="sd">        *double_pos* (False): set to &#39;True&#39; if you want to write out positions as doubles</span>

<span class="sd">        *double_vel* (False): set to &#39;True&#39; if you want to write out velocities as doubles</span>

<span class="sd">        *binary_aux_arrays* (None): set to &#39;True&#39; to write auxiliary</span>
<span class="sd">                                    arrays in binary format; if left &#39;None&#39;, the preference is</span>
<span class="sd">                                    taken from the param file</span>

<span class="sd">        *cosmological* (True): if True (default), the header will store the self.properties[&#39;a&#39;];</span>
<span class="sd">                               otherwise it will store self.properties[&#39;time&#39;]</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">global</span> <span class="n">config</span>

        <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filename</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Writing main file </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>

        <span class="n">f</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">open_</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span>

        <span class="n">t</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">cosmological</span><span class="p">:</span>
                <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="s2">&quot;Time is unknown: writing zero in header&quot;</span><span class="p">,</span> <span class="ne">RuntimeWarning</span><span class="p">)</span>

        <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">ndim</span> <span class="o">=</span> <span class="mi">3</span>
        <span class="n">ng</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gas</span><span class="p">)</span>
        <span class="n">nd</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dark</span><span class="p">)</span>
        <span class="n">ns</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">star</span><span class="p">)</span>

        <span class="n">byteswap</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_byteswap&quot;</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">byteorder</span> <span class="o">==</span> <span class="s2">&quot;little&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">byteswap</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s2">&quot;&gt;diiiiii&quot;</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">ndim</span><span class="p">,</span> <span class="n">ng</span><span class="p">,</span> <span class="n">nd</span><span class="p">,</span> <span class="n">ns</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s2">&quot;diiiiii&quot;</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">ndim</span><span class="p">,</span> <span class="n">ng</span><span class="p">,</span> <span class="n">nd</span><span class="p">,</span> <span class="n">ns</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>

        <span class="c1"># needs to be done in blocks like reading</span>
        <span class="c1"># describe the file structure as list of (num_parts,</span>
        <span class="c1"># [list_of_properties])</span>

        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">TipsySnap</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">double_pos</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">double_pos</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="n">double_vel</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">double_vel</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">ptype</span> <span class="o">=</span> <span class="s1">&#39;d&#39;</span> <span class="k">if</span> <span class="n">double_pos</span> <span class="k">else</span> <span class="s1">&#39;f&#39;</span>
            <span class="n">vtype</span> <span class="o">=</span> <span class="s1">&#39;d&#39;</span> <span class="k">if</span> <span class="n">double_vel</span> <span class="k">else</span> <span class="s1">&#39;f&#39;</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">dpos_param</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_paramfile</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;bDoublePos&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
            <span class="n">dvel_param</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_paramfile</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;bDoubleVel&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">double_pos</span><span class="p">:</span>
                <span class="n">ptype</span> <span class="o">=</span> <span class="s1">&#39;d&#39;</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="n">double_pos</span><span class="p">:</span>
                <span class="n">ptype</span> <span class="o">=</span> <span class="s1">&#39;f&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ptype</span> <span class="o">=</span> <span class="s1">&#39;d&#39;</span> <span class="k">if</span> <span class="n">dpos_param</span> <span class="k">else</span> <span class="s1">&#39;f&#39;</span>

            <span class="k">if</span> <span class="n">double_vel</span><span class="p">:</span>
                <span class="n">vtype</span> <span class="o">=</span> <span class="s1">&#39;d&#39;</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="n">double_vel</span><span class="p">:</span>
                <span class="n">vtype</span> <span class="o">=</span> <span class="s1">&#39;f&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">vtype</span> <span class="o">=</span> <span class="s1">&#39;d&#39;</span> <span class="k">if</span> <span class="n">dvel_param</span> <span class="k">else</span> <span class="s1">&#39;f&#39;</span>

        <span class="n">g_dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">({</span><span class="s1">&#39;names&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;mass&quot;</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;z&quot;</span><span class="p">,</span> <span class="s2">&quot;vx&quot;</span><span class="p">,</span> <span class="s2">&quot;vy&quot;</span><span class="p">,</span> <span class="s2">&quot;vz&quot;</span><span class="p">,</span> <span class="s2">&quot;rho&quot;</span><span class="p">,</span> <span class="s2">&quot;temp&quot;</span><span class="p">,</span> <span class="s2">&quot;eps&quot;</span><span class="p">,</span> <span class="s2">&quot;metals&quot;</span><span class="p">,</span> <span class="s2">&quot;phi&quot;</span><span class="p">),</span>
                            <span class="s1">&#39;formats&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;f&#39;</span><span class="p">,</span> <span class="n">ptype</span><span class="p">,</span> <span class="n">ptype</span><span class="p">,</span> <span class="n">ptype</span><span class="p">,</span> <span class="n">vtype</span><span class="p">,</span> <span class="n">vtype</span><span class="p">,</span> <span class="n">vtype</span><span class="p">,</span> <span class="s1">&#39;f&#39;</span><span class="p">,</span> <span class="s1">&#39;f&#39;</span><span class="p">,</span> <span class="s1">&#39;f&#39;</span><span class="p">,</span> <span class="s1">&#39;f&#39;</span><span class="p">,</span> <span class="s1">&#39;f&#39;</span><span class="p">)})</span>
        <span class="n">d_dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">({</span><span class="s1">&#39;names&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;mass&quot;</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;z&quot;</span><span class="p">,</span> <span class="s2">&quot;vx&quot;</span><span class="p">,</span> <span class="s2">&quot;vy&quot;</span><span class="p">,</span> <span class="s2">&quot;vz&quot;</span><span class="p">,</span> <span class="s2">&quot;eps&quot;</span><span class="p">,</span> <span class="s2">&quot;phi&quot;</span><span class="p">),</span>
                            <span class="s1">&#39;formats&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;f&#39;</span><span class="p">,</span> <span class="n">ptype</span><span class="p">,</span> <span class="n">ptype</span><span class="p">,</span> <span class="n">ptype</span><span class="p">,</span> <span class="n">vtype</span><span class="p">,</span> <span class="n">vtype</span><span class="p">,</span> <span class="n">vtype</span><span class="p">,</span> <span class="s1">&#39;f&#39;</span><span class="p">,</span> <span class="s1">&#39;f&#39;</span><span class="p">)})</span>
        <span class="n">s_dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">({</span><span class="s1">&#39;names&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;mass&quot;</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;z&quot;</span><span class="p">,</span> <span class="s2">&quot;vx&quot;</span><span class="p">,</span> <span class="s2">&quot;vy&quot;</span><span class="p">,</span> <span class="s2">&quot;vz&quot;</span><span class="p">,</span> <span class="s2">&quot;metals&quot;</span><span class="p">,</span> <span class="s2">&quot;tform&quot;</span><span class="p">,</span> <span class="s2">&quot;eps&quot;</span><span class="p">,</span> <span class="s2">&quot;phi&quot;</span><span class="p">),</span>
                            <span class="s1">&#39;formats&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;f&#39;</span><span class="p">,</span> <span class="n">ptype</span><span class="p">,</span> <span class="n">ptype</span><span class="p">,</span> <span class="n">ptype</span><span class="p">,</span> <span class="n">vtype</span><span class="p">,</span> <span class="n">vtype</span><span class="p">,</span> <span class="n">vtype</span><span class="p">,</span> <span class="s1">&#39;f&#39;</span><span class="p">,</span> <span class="s1">&#39;f&#39;</span><span class="p">,</span> <span class="s1">&#39;f&#39;</span><span class="p">,</span> <span class="s1">&#39;f&#39;</span><span class="p">)})</span>

        <span class="n">file_structure</span> <span class="o">=</span> <span class="p">((</span><span class="n">ng</span><span class="p">,</span> <span class="n">family</span><span class="o">.</span><span class="n">gas</span><span class="p">,</span> <span class="n">g_dtype</span><span class="p">),</span>
                          <span class="p">(</span><span class="n">nd</span><span class="p">,</span> <span class="n">family</span><span class="o">.</span><span class="n">dm</span><span class="p">,</span> <span class="n">d_dtype</span><span class="p">),</span>
                          <span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="n">family</span><span class="o">.</span><span class="n">star</span><span class="p">,</span> <span class="n">s_dtype</span><span class="p">))</span>

        <span class="n">max_block_size</span> <span class="o">=</span> <span class="mi">1024</span> <span class="o">**</span> <span class="mi">2</span>  <span class="c1"># particles</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">lazy_derive_off</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">n_left</span><span class="p">,</span> <span class="n">fam</span><span class="p">,</span> <span class="n">dtype</span> <span class="ow">in</span> <span class="n">file_structure</span><span class="p">:</span>
                <span class="n">n_done</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">self_type</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">fam</span><span class="p">]</span>
                <span class="k">while</span> <span class="n">n_left</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">n_block</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">n_left</span><span class="p">,</span> <span class="n">max_block_size</span><span class="p">)</span>

                <span class="c1">#g = np.zeros((n_block,len(st)),dtype=np.float32)</span>

                    <span class="n">g</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">n_block</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>

                    <span class="n">self_type_block</span> <span class="o">=</span> <span class="n">self_type</span><span class="p">[</span><span class="n">n_done</span><span class="p">:</span><span class="n">n_done</span> <span class="o">+</span> <span class="n">n_block</span><span class="p">]</span>

                    <span class="k">with</span> <span class="n">self_type_block</span><span class="o">.</span><span class="n">immediate_mode</span><span class="p">:</span>
                        <span class="c1"># Copy from the correct arrays</span>
                        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dtype</span><span class="o">.</span><span class="n">names</span><span class="p">):</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">g</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">self_type_block</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
                            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                                <span class="k">pass</span>

                    <span class="c1"># Write out the block</span>
                    <span class="k">if</span> <span class="n">byteswap</span><span class="p">:</span>
                        <span class="n">g</span><span class="o">.</span><span class="n">byteswap</span><span class="p">()</span><span class="o">.</span><span class="n">tofile</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">g</span><span class="o">.</span><span class="n">tofile</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

                    <span class="c1"># Increment total ptcls written, decrement ptcls left of</span>
                    <span class="c1"># this type</span>
                    <span class="n">n_left</span> <span class="o">-=</span> <span class="n">n_block</span>
                    <span class="n">n_done</span> <span class="o">+=</span> <span class="n">n_block</span>

        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Writing auxiliary arrays&quot;</span><span class="p">)</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">lazy_off</span><span class="p">:</span>  <span class="c1"># prevent any lazy reading or evaluation</span>

            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">family_keys</span><span class="p">()):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_derived_array</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="ow">and</span> <span class="n">x</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;mass&quot;</span><span class="p">,</span> <span class="s2">&quot;pos&quot;</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;z&quot;</span><span class="p">,</span> <span class="s2">&quot;vel&quot;</span><span class="p">,</span> <span class="s2">&quot;vx&quot;</span><span class="p">,</span> <span class="s2">&quot;vy&quot;</span><span class="p">,</span> <span class="s2">&quot;vz&quot;</span><span class="p">,</span> <span class="s2">&quot;rho&quot;</span><span class="p">,</span> <span class="s2">&quot;temp&quot;</span><span class="p">,</span>
                                                              <span class="s2">&quot;eps&quot;</span><span class="p">,</span> <span class="s2">&quot;metals&quot;</span><span class="p">,</span> <span class="s2">&quot;phi&quot;</span><span class="p">,</span> <span class="s2">&quot;tform&quot;</span><span class="p">]:</span>
                    <span class="n">TipsySnap</span><span class="o">.</span><span class="n">_write_array</span><span class="p">(</span>
                        <span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="n">filename</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="n">x</span><span class="p">,</span> <span class="n">binary</span><span class="o">=</span><span class="n">binary_aux_arrays</span><span class="p">)</span>


    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">__get_write_dtype</span><span class="p">(</span><span class="n">stored_dtype</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">stored_dtype</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">integer</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">__write_block</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">ar</span><span class="p">,</span> <span class="n">binary</span><span class="p">,</span> <span class="n">byteswap</span><span class="p">):</span>

        <span class="n">ar</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">TipsySnap</span><span class="o">.</span><span class="n">__get_write_dtype</span><span class="p">(</span><span class="n">ar</span><span class="o">.</span><span class="n">dtype</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">binary</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">byteswap</span><span class="p">:</span>
                <span class="n">ar</span><span class="o">.</span><span class="n">byteswap</span><span class="p">()</span><span class="o">.</span><span class="n">tofile</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ar</span><span class="o">.</span><span class="n">tofile</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">ar</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">integer</span><span class="p">):</span>
                <span class="n">fmt</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%d</span><span class="s2">&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">fmt</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%e</span><span class="s2">&quot;</span>
            <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">ar</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="n">fmt</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_loadable_array_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">array_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Given an array name, returns the metadata consisting of</span>
<span class="sd">        the tuple units, families.</span>

<span class="sd">        Returns:</span>
<span class="sd">         *units*: the units of this data on disk</span>
<span class="sd">         *families*: a list of family objects for which data is on disk</span>
<span class="sd">                     for this array, or None if this cannot be determined&quot;&quot;&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="n">array_name</span> <span class="o">+</span> <span class="s2">&quot;.pynbody-meta&quot;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_default_units_for</span><span class="p">(</span><span class="n">array_name</span><span class="p">),</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>

        <span class="n">res</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>

            <span class="n">X</span> <span class="o">=</span> <span class="n">l</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">res</span><span class="p">[</span><span class="n">X</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">u</span> <span class="o">=</span> <span class="n">units</span><span class="o">.</span><span class="n">Unit</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">])</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">u</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">fams</span> <span class="o">=</span> <span class="p">[</span><span class="n">family</span><span class="o">.</span><span class="n">get_family</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
                    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">res</span><span class="p">[</span><span class="s1">&#39;families&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)]</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">fams</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="s1">&#39;dtype&#39;</span><span class="p">])</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">dtype</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">return</span> <span class="n">u</span><span class="p">,</span> <span class="n">fams</span><span class="p">,</span> <span class="n">dtype</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_write_array_metafile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">units</span><span class="p">,</span> <span class="n">families</span><span class="p">,</span> <span class="n">dtype</span><span class="p">):</span>

        <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span> <span class="o">+</span> <span class="s2">&quot;.pynbody-meta&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;# This file automatically created by pynbody&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">f</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">units</span><span class="p">,</span> <span class="s2">&quot;_no_unit&quot;</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;units:&quot;</span><span class="p">,</span> <span class="n">units</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">f</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;families:&quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">f</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">families</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">f</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">file</span><span class="o">=</span><span class="n">f</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dtype</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;dtype:&quot;</span><span class="p">,</span> <span class="n">TipsySnap</span><span class="o">.</span><span class="n">__get_write_dtype</span><span class="p">(</span><span class="n">dtype</span><span class="p">),</span> <span class="n">file</span><span class="o">=</span><span class="n">f</span><span class="p">)</span>

        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">TipsySnap</span><span class="p">):</span>
            <span class="c1"># update the loadable keys if this operation is likely to have</span>
            <span class="c1"># changed them</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_update_loadable_keys</span><span class="p">()</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_families_in_main_file</span><span class="p">(</span><span class="n">array_name</span><span class="p">,</span> <span class="n">fam</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">fam_for_default</span> <span class="o">=</span> <span class="p">[</span><span class="n">fX</span> <span class="k">for</span> <span class="n">fX</span><span class="p">,</span> <span class="n">ars</span> <span class="ow">in</span> <span class="n">TipsySnap</span><span class="o">.</span><span class="n">_basic_loadable_keys</span><span class="o">.</span><span class="n">items</span><span class="p">(</span>
        <span class="p">)</span> <span class="k">if</span> <span class="n">array_name</span> <span class="ow">in</span> <span class="n">ars</span> <span class="ow">and</span> <span class="n">fX</span> <span class="ow">in</span> <span class="n">fam</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">fam_for_default</span>

    <span class="k">def</span> <span class="nf">_update_array</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">array_name</span><span class="p">,</span> <span class="n">fam</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                      <span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">binary</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">byteswap</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">fam</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">partial_load</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Writing back to partially loaded files not yet supported&quot;</span><span class="p">)</span>

        <span class="n">fam_in_main</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_families_in_main_file</span><span class="p">(</span><span class="n">array_name</span><span class="p">,</span> <span class="n">fam</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">fam_in_main</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_update_snapshot</span><span class="p">(</span><span class="n">array_name</span><span class="p">,</span> <span class="n">fam_out</span><span class="o">=</span><span class="n">fam_in_main</span><span class="p">)</span>
            <span class="n">fam</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">fam</span><span class="p">)</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">fam_in_main</span><span class="p">))</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">fam</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span>

        <span class="c1"># If we have disk units for this array, check we can convert into them</span>

        <span class="n">aux_u</span><span class="p">,</span> <span class="n">aux_f</span><span class="p">,</span> <span class="n">aux_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_loadable_array_metadata</span><span class="p">(</span><span class="n">array_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">aux_f</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">aux_f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">families</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">aux_u</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fam</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">array_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">[</span><span class="n">f</span><span class="p">]:</span>
                    <span class="c1"># check convertible</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="bp">self</span><span class="p">[</span><span class="n">f</span><span class="p">][</span><span class="n">array_name</span><span class="p">]</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">in_units</span><span class="p">(</span><span class="n">aux_u</span><span class="p">)</span>
                    <span class="k">except</span> <span class="n">units</span><span class="o">.</span><span class="n">UnitsException</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span>
                            <span class="s2">&quot;Units must match the existing auxiliary array on disk.&quot;</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__read_array_from_disk</span><span class="p">(</span><span class="n">array_name</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
            <span class="c1"># doesn&#39;t really exist, probably because the other data on disk was</span>
            <span class="c1"># in the main snapshot</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_write_array</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">array_name</span><span class="p">,</span> <span class="n">fam</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">,</span> <span class="n">binary</span><span class="o">=</span><span class="n">binary</span><span class="p">,</span>
                              <span class="n">byteswap</span><span class="o">=</span><span class="n">byteswap</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fam</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">aux_u</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_family_slice</span><span class="p">(</span><span class="n">f</span><span class="p">)]</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">f</span><span class="p">][</span>
                    <span class="n">array_name</span><span class="p">]</span><span class="o">.</span><span class="n">in_units</span><span class="p">(</span><span class="n">aux_u</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_family_slice</span><span class="p">(</span><span class="n">f</span><span class="p">)]</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">f</span><span class="p">][</span><span class="n">array_name</span><span class="p">]</span>

        <span class="n">fam</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">aux_f</span><span class="p">)</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">fam</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_write_array</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">array_name</span><span class="p">,</span> <span class="n">fam</span><span class="o">=</span><span class="n">fam</span><span class="p">,</span> <span class="n">contents</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">binary</span><span class="o">=</span><span class="n">binary</span><span class="p">,</span>
                          <span class="n">byteswap</span><span class="o">=</span><span class="n">byteswap</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_write_array</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">array_name</span><span class="p">,</span> <span class="n">fam</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">contents</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                     <span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">binary</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">byteswap</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Write the array to file.&quot;&quot;&quot;</span>

        <span class="n">fam_in_main</span> <span class="o">=</span> <span class="n">TipsySnap</span><span class="o">.</span><span class="n">_families_in_main_file</span><span class="p">(</span><span class="n">array_name</span><span class="p">,</span> <span class="n">fam</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">fam_in_main</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">TipsySnap</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_update_snapshot</span><span class="p">(</span><span class="n">array_name</span><span class="p">,</span> <span class="n">fam_out</span><span class="o">=</span><span class="n">fam_in_main</span><span class="p">)</span>
                <span class="n">fam</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">fam</span><span class="p">)</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">fam_in_main</span><span class="p">))</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">fam</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">return</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Cannot call static _write_array to write into main tipsy file.&quot;</span><span class="p">)</span>

        <span class="n">units_out</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">dtype</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">binary</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">binary</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ancestor</span><span class="p">,</span> <span class="s2">&quot;_tipsy_arrays_binary&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">binary</span> <span class="ow">and</span> <span class="p">(</span><span class="n">byteswap</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">byteswap</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ancestor</span><span class="p">,</span> <span class="s2">&quot;_byteswap&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">lazy_off</span><span class="p">:</span>  <span class="c1"># prevent any lazy reading or evaluation</span>
            <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filename</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">:]</span> <span class="o">==</span> <span class="s1">&#39;.gz&#39;</span><span class="p">:</span>
                    <span class="n">filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filename</span><span class="p">[:</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="n">array_name</span> <span class="o">+</span> <span class="s2">&quot;.gz&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filename</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="n">array_name</span>

            <span class="k">if</span> <span class="n">binary</span><span class="p">:</span>
                <span class="n">fhand</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">open_</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">byteswap</span><span class="p">:</span>
                    <span class="n">fhand</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s2">&quot;&gt;i&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)))</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="n">fhand</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s2">&quot;i&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)))</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">fhand</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">open_</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span>
                <span class="n">fhand</span><span class="o">.</span><span class="n">write</span><span class="p">((</span><span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">contents</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">array_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">family_keys</span><span class="p">():</span>
                    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="p">[</span><span class="n">family</span><span class="o">.</span><span class="n">gas</span><span class="p">,</span> <span class="n">family</span><span class="o">.</span><span class="n">dm</span><span class="p">,</span> <span class="n">family</span><span class="o">.</span><span class="n">star</span><span class="p">]:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">dtype</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">f</span><span class="p">][</span><span class="n">array_name</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span>
                            <span class="n">ar</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">f</span><span class="p">][</span><span class="n">array_name</span><span class="p">]</span>
                            <span class="n">units_out</span> <span class="o">=</span> <span class="n">ar</span><span class="o">.</span><span class="n">units</span>

                        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                            <span class="n">ar</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">f</span><span class="p">]),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>

                        <span class="n">TipsySnap</span><span class="o">.</span><span class="n">__write_block</span><span class="p">(</span><span class="n">fhand</span><span class="p">,</span> <span class="n">ar</span><span class="p">,</span> <span class="n">binary</span><span class="p">,</span> <span class="n">byteswap</span><span class="p">)</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ar</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">array_name</span><span class="p">]</span>
                    <span class="n">dtype</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">array_name</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span>
                    <span class="n">units_out</span> <span class="o">=</span> <span class="n">ar</span><span class="o">.</span><span class="n">units</span>
                    <span class="n">TipsySnap</span><span class="o">.</span><span class="n">__write_block</span><span class="p">(</span><span class="n">fhand</span><span class="p">,</span> <span class="n">ar</span><span class="p">,</span> <span class="n">binary</span><span class="p">,</span> <span class="n">byteswap</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">TipsySnap</span><span class="o">.</span><span class="n">__write_block</span><span class="p">(</span><span class="n">fhand</span><span class="p">,</span> <span class="n">contents</span><span class="p">,</span> <span class="n">binary</span><span class="p">,</span> <span class="n">byteswap</span><span class="p">)</span>
                <span class="n">units_out</span> <span class="o">=</span> <span class="n">contents</span><span class="o">.</span><span class="n">units</span>

        <span class="n">fhand</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">fam</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fam</span> <span class="o">=</span> <span class="p">[</span><span class="n">family</span><span class="o">.</span><span class="n">gas</span><span class="p">,</span> <span class="n">family</span><span class="o">.</span><span class="n">dm</span><span class="p">,</span> <span class="n">family</span><span class="o">.</span><span class="n">star</span><span class="p">]</span>

        <span class="n">TipsySnap</span><span class="o">.</span><span class="n">_write_array_metafile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">units_out</span><span class="p">,</span> <span class="n">fam</span><span class="p">,</span> <span class="n">dtype</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_load_array</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">array_name</span><span class="p">,</span> <span class="n">fam</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">packed_vector</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">array_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_basic_loadable_keys</span><span class="p">[</span><span class="n">fam</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_load_main_file</span><span class="p">()</span>
            <span class="k">return</span>

        <span class="n">fams</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_loadable_array_metadata</span><span class="p">(</span>
            <span class="n">array_name</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">families</span><span class="p">()</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">fam</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">fams</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">fams</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">families</span><span class="p">()))</span> <span class="ow">or</span> \
                <span class="p">(</span><span class="n">fam</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">fam</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">fams</span><span class="p">):</span>
            <span class="c1"># Top line says &#39;you requested all families but at least one isn&#39;t available&#39;</span>
            <span class="c1"># Bottom line says &#39;you requested one family, but that one&#39;s not</span>
            <span class="c1"># available&#39;</span>

            <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s2">&quot;This array is marked as available only for families </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">fams</span><span class="p">)</span>

        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__read_array_from_disk</span><span class="p">(</span><span class="n">array_name</span><span class="p">,</span> <span class="n">fam</span><span class="o">=</span><span class="n">fam</span><span class="p">,</span>
                                           <span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">,</span>
                                           <span class="n">packed_vector</span><span class="o">=</span><span class="n">packed_vector</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">fam</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">[</span><span class="n">array_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">[</span><span class="n">fam</span><span class="p">][</span><span class="n">array_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span>

    <span class="k">def</span> <span class="nf">__read_array_from_disk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">array_name</span><span class="p">,</span> <span class="n">fam</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                               <span class="n">packed_vector</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Read a TIPSY-ASCII or TIPSY-BINARY auxiliary file with the</span>
<span class="sd">        specified name. If fam is not None, read only the particles of</span>
<span class="sd">        the specified family.&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">array_name</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;massform&#39;</span><span class="p">,</span> <span class="s1">&#39;rhoform&#39;</span><span class="p">,</span> <span class="s1">&#39;tempform&#39;</span><span class="p">,</span> <span class="s1">&#39;phiform&#39;</span><span class="p">,</span> <span class="s1">&#39;nsmooth&#39;</span><span class="p">,</span>
                                               <span class="s1">&#39;xform&#39;</span><span class="p">,</span> <span class="s1">&#39;yform&#39;</span><span class="p">,</span> <span class="s1">&#39;zform&#39;</span><span class="p">,</span> <span class="s1">&#39;vxform&#39;</span><span class="p">,</span> <span class="s1">&#39;vyform&#39;</span><span class="p">,</span> <span class="s1">&#39;vzform&#39;</span><span class="p">,</span>
                                               <span class="s1">&#39;posform&#39;</span><span class="p">,</span> <span class="s1">&#39;velform&#39;</span><span class="p">,</span><span class="s1">&#39;h2form&#39;</span><span class="p">]:</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">read_starlog</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">fam</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">return</span> <span class="bp">self</span><span class="p">[</span><span class="n">fam</span><span class="p">][</span><span class="n">array_name</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="bp">self</span><span class="p">[</span><span class="n">array_name</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
                <span class="k">pass</span>

        <span class="kn">import</span> <span class="nn">sys</span>
        <span class="kn">import</span> <span class="nn">os</span>

        <span class="c1"># N.B. this code is a bit inefficient for loading</span>
        <span class="c1"># family-specific arrays, because it reads in the whole array</span>
        <span class="c1"># then slices it.  But of course the memory is only wasted</span>
        <span class="c1"># while still inside this routine, so it&#39;s only really the</span>
        <span class="c1"># wasted time that&#39;s a problem.</span>

        <span class="c1"># determine whether the array exists in a file</span>

        <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filename</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">:]</span> <span class="o">==</span> <span class="s1">&#39;.gz&#39;</span><span class="p">:</span>
                <span class="n">filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filename</span><span class="p">[:</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="n">array_name</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filename</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="n">array_name</span>

        <span class="n">f</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">open_</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Attempting to load auxiliary array </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
        <span class="c1"># if we get here, we&#39;ve got the file - try loading it</span>

        <span class="n">units</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_loadable_array_metadata</span><span class="p">(</span><span class="n">array_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dtype</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dtype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_preferred_dtype</span><span class="p">(</span><span class="n">array_name</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">l</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">())</span>
            <span class="n">binary</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="n">l</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_control</span><span class="o">.</span><span class="n">disk_num_particles</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s2">&quot;Incorrect file format&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">dtype</span><span class="p">:</span>
                <span class="c1"># Inspect the first line to see whether it&#39;s float or int</span>
                <span class="n">l</span> <span class="o">=</span> <span class="s2">&quot;0</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="k">while</span> <span class="n">l</span> <span class="o">==</span> <span class="s2">&quot;0</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">:</span>
                    <span class="n">l</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
                <span class="k">if</span> <span class="s2">&quot;.&quot;</span> <span class="ow">in</span> <span class="n">l</span> <span class="ow">or</span> <span class="s2">&quot;e&quot;</span> <span class="ow">in</span> <span class="n">l</span> <span class="ow">or</span> <span class="n">l</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;inf&quot;</span><span class="p">:</span>
                    <span class="n">dtype</span> <span class="o">=</span> <span class="nb">float</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">dtype</span> <span class="o">=</span> <span class="nb">int</span>

                <span class="c1"># Restart at head of file</span>
                <span class="n">f</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>

            <span class="n">loadblock</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">count</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">fromfile</span><span class="p">(</span>
                <span class="n">f</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="n">count</span><span class="p">)</span>
            <span class="c1"># data = np.fromfile(f, dtype=tp, sep=&quot;\n&quot;)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="c1"># this is probably a binary file</span>
            <span class="n">binary</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">open_</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span>

            <span class="c1"># Read header and check endianness</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_byteswap</span><span class="p">:</span>
                <span class="n">l</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s2">&quot;&gt;i&quot;</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">4</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">l</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s2">&quot;i&quot;</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">4</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">l</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_control</span><span class="o">.</span><span class="n">disk_num_particles</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s2">&quot;Incorrect file format&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">dtype</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># Set data format to be read (float or int) based on config</span>
                <span class="n">int_arrays</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span>
                    <span class="nb">str</span><span class="o">.</span><span class="n">strip</span><span class="p">,</span> <span class="n">config_parser</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tipsy&#39;</span><span class="p">,</span> <span class="s1">&#39;binary-int-arrays&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)))</span>
                <span class="k">if</span> <span class="n">array_name</span> <span class="ow">in</span> <span class="n">int_arrays</span><span class="p">:</span>
                    <span class="n">dtype</span> <span class="o">=</span> <span class="s1">&#39;i&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">dtype</span> <span class="o">=</span> <span class="s1">&#39;f&#39;</span>

            <span class="c1"># Read longest data array possible.</span>
            <span class="c1"># Assume byteswap since most will be.</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_byteswap</span><span class="p">:</span>
                <span class="n">loadblock</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">count</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">fromstring</span><span class="p">(</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">count</span> <span class="o">*</span> <span class="mi">4</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="n">count</span><span class="p">)</span><span class="o">.</span><span class="n">byteswap</span><span class="p">()</span>
                <span class="c1"># data = np.fromstring(f.read(3*len(self)*4),dtype).byteswap()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">loadblock</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">count</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">fromstring</span><span class="p">(</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">count</span> <span class="o">*</span> <span class="mi">4</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="n">count</span><span class="p">)</span>
                <span class="c1"># data = np.fromstring(f.read(3*len(self)*4),dtype)</span>

        <span class="n">ndim</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ancestor</span><span class="o">.</span><span class="n">_tipsy_arrays_binary</span> <span class="o">=</span> <span class="n">binary</span>

        <span class="n">all_fam</span> <span class="o">=</span> <span class="p">[</span><span class="n">family</span><span class="o">.</span><span class="n">dm</span><span class="p">,</span> <span class="n">family</span><span class="o">.</span><span class="n">gas</span><span class="p">,</span> <span class="n">family</span><span class="o">.</span><span class="n">star</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">fam</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fam</span> <span class="o">=</span> <span class="n">all_fam</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">array</span><span class="o">.</span><span class="n">SimArray</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">fam</span><span class="p">]),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">array</span><span class="o">.</span><span class="n">SimArray</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">readlen</span><span class="p">,</span> <span class="n">buf_index</span><span class="p">,</span> <span class="n">mem_index</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_control</span><span class="o">.</span><span class="n">iterate</span><span class="p">(</span><span class="n">all_fam</span><span class="p">,</span> <span class="n">fam</span><span class="p">):</span>
            <span class="n">buf</span> <span class="o">=</span> <span class="n">loadblock</span><span class="p">(</span><span class="n">readlen</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">mem_index</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">r</span><span class="p">[</span><span class="n">mem_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="n">buf_index</span><span class="p">]</span>


        <span class="k">if</span> <span class="n">units</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">r</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="n">units</span>

        <span class="k">return</span> <span class="n">r</span>

    <span class="k">def</span> <span class="nf">read_starlog</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fam</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Read a TIPSY-starlog file.&quot;&quot;&quot;</span>

        <span class="kn">import</span> <span class="nn">sys</span>
        <span class="kn">import</span> <span class="nn">os</span>
        <span class="kn">import</span> <span class="nn">glob</span>
        <span class="kn">import</span> <span class="nn">pynbody.bridge</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_filename</span><span class="p">)</span>
        <span class="n">done</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="c1"># Attempt the loading of information</span>
        <span class="n">l</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="s2">&quot;*.starlog&quot;</span><span class="p">))</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">l</span><span class="p">)):</span>
            <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">l</span><span class="p">:</span>
                <span class="n">sl</span> <span class="o">=</span> <span class="n">StarLog</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">l</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="s2">&quot;../*.starlog&quot;</span><span class="p">))</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">l</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s2">&quot;Couldn&#39;t find starlog file&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">l</span><span class="p">:</span>
                <span class="n">sl</span> <span class="o">=</span> <span class="n">StarLog</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Bridging starlog into SimSnap&quot;</span><span class="p">)</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">pynbody</span><span class="o">.</span><span class="n">bridge</span><span class="o">.</span><span class="n">OrderBridge</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sl</span><span class="p">)</span>
        <span class="n">b</span><span class="p">(</span><span class="n">b</span><span class="p">(</span><span class="n">b</span><span class="p">(</span><span class="n">sl</span><span class="p">)))</span><span class="o">.</span><span class="n">star</span><span class="p">[</span><span class="s1">&#39;iorderGas&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">b</span><span class="p">(</span><span class="n">b</span><span class="p">(</span><span class="n">sl</span><span class="p">))</span><span class="o">.</span><span class="n">star</span><span class="p">[</span><span class="s1">&#39;iorderGas&#39;</span><span class="p">]</span>
        <span class="n">b</span><span class="p">(</span><span class="n">b</span><span class="p">(</span><span class="n">b</span><span class="p">(</span><span class="n">sl</span><span class="p">)))</span><span class="o">.</span><span class="n">star</span><span class="p">[</span><span class="s1">&#39;massform&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">b</span><span class="p">(</span><span class="n">b</span><span class="p">(</span><span class="n">sl</span><span class="p">))</span><span class="o">.</span><span class="n">star</span><span class="p">[</span><span class="s1">&#39;massform&#39;</span><span class="p">]</span>
        <span class="n">b</span><span class="p">(</span><span class="n">b</span><span class="p">(</span><span class="n">b</span><span class="p">(</span><span class="n">sl</span><span class="p">)))</span><span class="o">.</span><span class="n">star</span><span class="p">[</span><span class="s1">&#39;rhoform&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">b</span><span class="p">(</span><span class="n">b</span><span class="p">(</span><span class="n">sl</span><span class="p">))</span><span class="o">.</span><span class="n">star</span><span class="p">[</span><span class="s1">&#39;rhoform&#39;</span><span class="p">]</span>
        <span class="n">b</span><span class="p">(</span><span class="n">b</span><span class="p">(</span><span class="n">b</span><span class="p">(</span><span class="n">sl</span><span class="p">)))</span><span class="o">.</span><span class="n">star</span><span class="p">[</span><span class="s1">&#39;tempform&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">b</span><span class="p">(</span><span class="n">b</span><span class="p">(</span><span class="n">sl</span><span class="p">))</span><span class="o">.</span><span class="n">star</span><span class="p">[</span><span class="s1">&#39;tempform&#39;</span><span class="p">]</span>
        <span class="n">b</span><span class="p">(</span><span class="n">b</span><span class="p">(</span><span class="n">b</span><span class="p">(</span><span class="n">sl</span><span class="p">)))[</span><span class="s1">&#39;posform&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">b</span><span class="p">(</span><span class="n">b</span><span class="p">(</span><span class="n">sl</span><span class="p">))[</span><span class="s1">&#39;pos&#39;</span><span class="p">]</span>
        <span class="n">b</span><span class="p">(</span><span class="n">b</span><span class="p">(</span><span class="n">b</span><span class="p">(</span><span class="n">sl</span><span class="p">)))[</span><span class="s1">&#39;velform&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">b</span><span class="p">(</span><span class="n">b</span><span class="p">(</span><span class="n">sl</span><span class="p">))[</span><span class="s1">&#39;vel&#39;</span><span class="p">]</span>
        <span class="c1">#b(sl).star[&#39;iorderGas&#39;] = sl.star[&#39;iorderGas&#39;][:len(self.star)]</span>
        <span class="c1">#b(sl).star[&#39;massform&#39;] = sl.star[&#39;massform&#39;][:len(self.star)]</span>
        <span class="c1">#b(sl).star[&#39;rhoform&#39;] = sl.star[&#39;rhoform&#39;][:len(self.star)]</span>
        <span class="c1">#b(sl).star[&#39;tempform&#39;] = sl.star[&#39;tempform&#39;][:len(self.star)]</span>
        <span class="c1">#b(sl)[&#39;posform&#39;] = sl[&#39;pos&#39;][:len(self.star), :]</span>
        <span class="c1">#b(sl)[&#39;velform&#39;] = sl[&#39;vel&#39;][:len(self.star), :]</span>
        <span class="k">if</span> <span class="s1">&#39;h2form&#39;</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">sl</span><span class="o">.</span><span class="n">star</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="n">b</span><span class="p">(</span><span class="n">b</span><span class="p">(</span><span class="n">b</span><span class="p">(</span><span class="n">sl</span><span class="p">)))</span><span class="o">.</span><span class="n">star</span><span class="p">[</span><span class="s1">&#39;h2form&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">b</span><span class="p">(</span><span class="n">b</span><span class="p">(</span><span class="n">sl</span><span class="p">))</span><span class="o">.</span><span class="n">star</span><span class="p">[</span><span class="s1">&#39;h2form&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No H2 data found in StarLog file&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">([</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;z&#39;</span><span class="p">]):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_arrays</span><span class="p">[</span><span class="n">x</span> <span class="o">+</span> <span class="s1">&#39;form&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;posform&#39;</span><span class="p">][:,</span> <span class="n">i</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">([</span><span class="s1">&#39;vx&#39;</span><span class="p">,</span> <span class="s1">&#39;vy&#39;</span><span class="p">,</span> <span class="s1">&#39;vz&#39;</span><span class="p">]):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_arrays</span><span class="p">[</span><span class="n">x</span> <span class="o">+</span> <span class="s1">&#39;form&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;velform&#39;</span><span class="p">][:,</span> <span class="n">i</span><span class="p">]</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_can_load</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">check</span> <span class="o">=</span> <span class="n">TipsySnap</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">del</span> <span class="n">check</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">return</span> <span class="kc">True</span>

<span class="c1"># caculate the number fraction YH, YHe as a function of metalicity. Cosmic</span>
<span class="c1"># production rate of helium relative to metals (in mass)</span>
<span class="c1"># delta Y/delta Z = 2.1 and primordial He Yp = 0.236 (Jimenez et al. 2003,</span>
<span class="c1"># Science 299, 5612.</span>
<span class="c1">#  piecewise linear</span>
<span class="c1">#  Y = Yp + dY/dZ*ZMetal up to ZMetal = 0.1, then linear decrease to 0 at Z=1)</span>

<span class="c1">#  SUM_Metal = sum(ni/nH *mi),it is a fixed number for cloudy abundance.</span>
<span class="c1">#  Massfraction fmetal = Z*SUM_metal/(1 + 4*nHe/nH + Z*SUM_metal) (1)</span>
<span class="c1">#  4*nHe/nH = mHe/mH = fHe/fH</span>
<span class="c1">#  also fH + fHe + fMetal = 1  (2)</span>
<span class="c1">#  if fHe specified, combining the 2 eq above will solve for</span>
<span class="c1">#  fH and fMetal</span>


<span class="k">def</span> <span class="nf">_abundance_estimator</span><span class="p">(</span><span class="n">metal</span><span class="p">):</span>

    <span class="n">Y_He</span> <span class="o">=</span> <span class="p">((</span><span class="mf">0.236</span> <span class="o">+</span> <span class="mf">2.1</span> <span class="o">*</span> <span class="n">metal</span><span class="p">)</span> <span class="o">/</span> <span class="mf">4.0</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">metal</span> <span class="o">&lt;=</span> <span class="mf">0.1</span><span class="p">)</span>
    <span class="n">Y_He</span> <span class="o">+=</span> <span class="p">((</span><span class="o">-</span><span class="mf">0.446</span> <span class="o">*</span> <span class="p">(</span><span class="n">metal</span> <span class="o">-</span> <span class="mf">0.1</span><span class="p">)</span> <span class="o">/</span> <span class="mf">0.9</span> <span class="o">+</span> <span class="mf">0.446</span><span class="p">)</span> <span class="o">/</span> <span class="mf">4.0</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">metal</span> <span class="o">&gt;</span> <span class="mf">0.1</span><span class="p">)</span>
    <span class="n">Y_H</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="n">Y_He</span> <span class="o">*</span> <span class="mf">4.</span> <span class="o">-</span> <span class="n">metal</span>

    <span class="k">return</span> <span class="n">Y_H</span><span class="p">,</span> <span class="n">Y_He</span>


<div class="viewcode-block" id="HII"><a class="viewcode-back" href="../../../reference/derived.html#pynbody.snapshot.tipsy.HII">[docs]</a><span class="nd">@TipsySnap</span><span class="o">.</span><span class="n">derived_quantity</span>
<span class="k">def</span> <span class="nf">HII</span><span class="p">(</span><span class="n">sim</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Number of HII ions per proton mass&quot;&quot;&quot;</span>
    <span class="n">Y_H</span><span class="p">,</span> <span class="n">Y_He</span> <span class="o">=</span> <span class="n">_abundance_estimator</span><span class="p">(</span><span class="n">sim</span><span class="p">[</span><span class="s2">&quot;metals&quot;</span><span class="p">])</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">Y_H</span> <span class="o">-</span> <span class="n">sim</span><span class="p">[</span><span class="s2">&quot;HI&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">sim</span><span class="p">[</span><span class="s2">&quot;H2&quot;</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">Y_H</span> <span class="o">-</span> <span class="n">sim</span><span class="p">[</span><span class="s2">&quot;HI&quot;</span><span class="p">]</span></div>


<div class="viewcode-block" id="HeIII"><a class="viewcode-back" href="../../../reference/derived.html#pynbody.snapshot.tipsy.HeIII">[docs]</a><span class="nd">@TipsySnap</span><span class="o">.</span><span class="n">derived_quantity</span>
<span class="k">def</span> <span class="nf">HeIII</span><span class="p">(</span><span class="n">sim</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Number of HeIII ions per proton mass&quot;&quot;&quot;</span>
    <span class="n">Y_H</span><span class="p">,</span> <span class="n">Y_He</span> <span class="o">=</span> <span class="n">_abundance_estimator</span><span class="p">(</span><span class="n">sim</span><span class="p">[</span><span class="s2">&quot;metals&quot;</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">Y_He</span> <span class="o">-</span> <span class="n">sim</span><span class="p">[</span><span class="s2">&quot;HeII&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">sim</span><span class="p">[</span><span class="s2">&quot;HeI&quot;</span><span class="p">]</span></div>


<div class="viewcode-block" id="ne"><a class="viewcode-back" href="../../../reference/derived.html#pynbody.snapshot.tipsy.ne">[docs]</a><span class="nd">@TipsySnap</span><span class="o">.</span><span class="n">derived_quantity</span>
<span class="k">def</span> <span class="nf">ne</span><span class="p">(</span><span class="n">sim</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Number of electrons per proton mass&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">sim</span><span class="p">[</span><span class="s2">&quot;HII&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">sim</span><span class="p">[</span><span class="s2">&quot;HeII&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">sim</span><span class="p">[</span><span class="s2">&quot;HeIII&quot;</span><span class="p">]</span></div>


<div class="viewcode-block" id="hetot"><a class="viewcode-back" href="../../../reference/derived.html#pynbody.snapshot.tipsy.hetot">[docs]</a><span class="nd">@TipsySnap</span><span class="o">.</span><span class="n">derived_quantity</span>
<span class="k">def</span> <span class="nf">hetot</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Helium mass fraction including correction based on metallicity&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="mf">0.236</span> <span class="o">+</span> <span class="p">(</span><span class="mf">2.1</span> <span class="o">*</span> <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;metals&#39;</span><span class="p">])</span></div>


<div class="viewcode-block" id="hydrogen"><a class="viewcode-back" href="../../../reference/derived.html#pynbody.snapshot.tipsy.hydrogen">[docs]</a><span class="nd">@TipsySnap</span><span class="o">.</span><span class="n">derived_quantity</span>
<span class="k">def</span> <span class="nf">hydrogen</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Hydrogen mass fraction including correction based on metallicity&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;metals&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;hetot&#39;</span><span class="p">]</span></div>

<span class="c1">#from .tipsy import TipsySnap</span>
<span class="c1"># Asplund et al (2009) ARA&amp;A solar abundances (Table 1)</span>
<span class="c1"># m_frac = 10.0^([X/H] - 12)*M_X/M_H*0.74</span>
<span class="c1"># OR</span>
<span class="c1"># http://en.wikipedia.org/wiki/Abundance_of_the_chemical_elements</span>
<span class="c1"># puts stuff more straighforwardly cites Arnett (1996)</span>
<span class="c1"># A+G from http://www.t4.lanl.gov/opacity/grevand1.html</span>
<span class="c1"># Anders + Grev (1989)    Asplund</span>
<span class="n">XSOLFe</span> <span class="o">=</span> <span class="mf">0.125E-2</span>         <span class="c1"># 1.31e-3</span>
<span class="c1"># Looks very wrong ([O/Fe] ~ 0.2-0.3 higher than solar),</span>
<span class="c1"># probably because SN ejecta are calculated with</span>
<span class="c1"># Woosley + Weaver (1995) based on Anders + Grevesse (1989)</span>
<span class="c1"># XSOLO=0.59E-2           # 5.8e-2</span>
<span class="n">XSOLO</span> <span class="o">=</span> <span class="mf">0.84E-2</span>
<span class="n">XSOLH</span> <span class="o">=</span> <span class="mf">0.706</span>             <span class="c1"># 0.74</span>
<span class="n">XSOLC</span> <span class="o">=</span> <span class="mf">3.03e-3</span>           <span class="c1"># 2.39e-3</span>
<span class="n">XSOLN</span> <span class="o">=</span> <span class="mf">9.2e-4</span>          <span class="c1"># 7e-4</span>
<span class="n">XSOLNe</span> <span class="o">=</span> <span class="mf">1.66e-3</span>          <span class="c1"># 1.26e-3</span>
<span class="n">XSOLMg</span> <span class="o">=</span> <span class="mf">6.44e-4</span>          <span class="c1"># 7e-4</span>
<span class="n">XSOLSi</span> <span class="o">=</span> <span class="mf">7e-4</span>          <span class="c1"># 6.7e-4</span>


<div class="viewcode-block" id="feh"><a class="viewcode-back" href="../../../reference/derived.html#pynbody.snapshot.tipsy.feh">[docs]</a><span class="nd">@TipsySnap</span><span class="o">.</span><span class="n">derived_quantity</span>
<span class="k">def</span> <span class="nf">feh</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Iron abundance [Fe/H] derived from tipsy array FeMassFrac, with solar</span>
<span class="sd">    values from Asplund et al 09&quot;&quot;&quot;</span>
    <span class="n">minfe</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">amin</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="s1">&#39;FeMassFrac&#39;</span><span class="p">][</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="s1">&#39;FeMassFrac&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)])</span>
    <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;FeMassFrac&#39;</span><span class="p">][</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="s1">&#39;FeMassFrac&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)]</span> <span class="o">=</span> <span class="n">minfe</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="s1">&#39;FeMassFrac&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;hydrogen&#39;</span><span class="p">])</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">XSOLFe</span> <span class="o">/</span> <span class="n">XSOLH</span><span class="p">)</span></div>


<div class="viewcode-block" id="oxh"><a class="viewcode-back" href="../../../reference/derived.html#pynbody.snapshot.tipsy.oxh">[docs]</a><span class="nd">@TipsySnap</span><span class="o">.</span><span class="n">derived_quantity</span>
<span class="k">def</span> <span class="nf">oxh</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Oxygen abundance [O/H] derived from tipsy array FeMassFrac, with solar</span>
<span class="sd">    values from Asplund et al 09&quot;&quot;&quot;</span>
    <span class="n">minox</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">amin</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="s1">&#39;OxMassFrac&#39;</span><span class="p">][</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="s1">&#39;OxMassFrac&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)])</span>
    <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;OxMassFrac&#39;</span><span class="p">][</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="s1">&#39;OxMassFrac&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)]</span> <span class="o">=</span> <span class="n">minox</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="s1">&#39;OxMassFrac&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;hydrogen&#39;</span><span class="p">])</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">XSOLO</span> <span class="o">/</span> <span class="n">XSOLH</span><span class="p">)</span></div>


<div class="viewcode-block" id="ofe"><a class="viewcode-back" href="../../../reference/derived.html#pynbody.snapshot.tipsy.ofe">[docs]</a><span class="nd">@TipsySnap</span><span class="o">.</span><span class="n">derived_quantity</span>
<span class="k">def</span> <span class="nf">ofe</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Oxygen-to-iron ratio [O/Fe] derived from tipsy arrays OxMassFrac and FeMassFrac</span>
<span class="sd">    with solar values from Asplund et al 09&quot;&quot;&quot;</span>
    <span class="n">minox</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">amin</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="s1">&#39;OxMassFrac&#39;</span><span class="p">][</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="s1">&#39;OxMassFrac&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)])</span>
    <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;OxMassFrac&#39;</span><span class="p">][</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="s1">&#39;OxMassFrac&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)]</span> <span class="o">=</span> <span class="n">minox</span>
    <span class="n">minfe</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">amin</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="s1">&#39;FeMassFrac&#39;</span><span class="p">][</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="s1">&#39;FeMassFrac&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)])</span>
    <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;FeMassFrac&#39;</span><span class="p">][</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="s1">&#39;FeMassFrac&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)]</span> <span class="o">=</span> <span class="n">minfe</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="s1">&#39;OxMassFrac&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;FeMassFrac&#39;</span><span class="p">])</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">XSOLO</span> <span class="o">/</span> <span class="n">XSOLFe</span><span class="p">)</span></div>


<div class="viewcode-block" id="mgfe"><a class="viewcode-back" href="../../../reference/derived.html#pynbody.snapshot.tipsy.mgfe">[docs]</a><span class="nd">@TipsySnap</span><span class="o">.</span><span class="n">derived_quantity</span>
<span class="k">def</span> <span class="nf">mgfe</span><span class="p">(</span><span class="n">sim</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Magnesium-to-iron ratio [Mg/Fe] derived from tipsy arrays MgMassFrac and FeMassFrac</span>
<span class="sd">    with solar values from Asplund et al 09&quot;&quot;&quot;</span>
    <span class="n">minmg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">amin</span><span class="p">(</span><span class="n">sim</span><span class="p">[</span><span class="s1">&#39;MgMassFrac&#39;</span><span class="p">][</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">sim</span><span class="p">[</span><span class="s1">&#39;MgMassFrac&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)])</span>
    <span class="n">sim</span><span class="p">[</span><span class="s1">&#39;MgMassFrac&#39;</span><span class="p">][</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">sim</span><span class="p">[</span><span class="s1">&#39;MgMassFrac&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)]</span> <span class="o">=</span> <span class="n">minmg</span>
    <span class="n">minfe</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">amin</span><span class="p">(</span><span class="n">sim</span><span class="p">[</span><span class="s1">&#39;FeMassFrac&#39;</span><span class="p">][</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">sim</span><span class="p">[</span><span class="s1">&#39;FeMassFrac&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)])</span>
    <span class="n">sim</span><span class="p">[</span><span class="s1">&#39;FeMassFrac&#39;</span><span class="p">][</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">sim</span><span class="p">[</span><span class="s1">&#39;FeMassFrac&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)]</span> <span class="o">=</span> <span class="n">minfe</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">sim</span><span class="p">[</span><span class="s1">&#39;MgMassFrac&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">sim</span><span class="p">[</span><span class="s1">&#39;FeMassFrac&#39;</span><span class="p">])</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">XSOLMg</span> <span class="o">/</span> <span class="n">XSOLFe</span><span class="p">)</span></div>


<div class="viewcode-block" id="nefe"><a class="viewcode-back" href="../../../reference/derived.html#pynbody.snapshot.tipsy.nefe">[docs]</a><span class="nd">@TipsySnap</span><span class="o">.</span><span class="n">derived_quantity</span>
<span class="k">def</span> <span class="nf">nefe</span><span class="p">(</span><span class="n">sim</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Neon-to-iron ratio [Ne/Fe] derived from tipsy arrays MgMassFrac and FeMassFrac</span>
<span class="sd">    with solar values from Asplund et al 09&quot;&quot;&quot;</span>
    <span class="n">minne</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">amin</span><span class="p">(</span><span class="n">sim</span><span class="p">[</span><span class="s1">&#39;NeMassFrac&#39;</span><span class="p">][</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">sim</span><span class="p">[</span><span class="s1">&#39;NeMassFrac&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)])</span>
    <span class="n">sim</span><span class="p">[</span><span class="s1">&#39;NeMassFrac&#39;</span><span class="p">][</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">sim</span><span class="p">[</span><span class="s1">&#39;NeMassFrac&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)]</span> <span class="o">=</span> <span class="n">minne</span>
    <span class="n">minfe</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">amin</span><span class="p">(</span><span class="n">sim</span><span class="p">[</span><span class="s1">&#39;FeMassFrac&#39;</span><span class="p">][</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">sim</span><span class="p">[</span><span class="s1">&#39;FeMassFrac&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)])</span>
    <span class="n">sim</span><span class="p">[</span><span class="s1">&#39;FeMassFrac&#39;</span><span class="p">][</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">sim</span><span class="p">[</span><span class="s1">&#39;FeMassFrac&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)]</span> <span class="o">=</span> <span class="n">minfe</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">sim</span><span class="p">[</span><span class="s1">&#39;NeMassFrac&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">sim</span><span class="p">[</span><span class="s1">&#39;FeMassFrac&#39;</span><span class="p">])</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">XSOLNe</span> <span class="o">/</span> <span class="n">XSOLFe</span><span class="p">)</span></div>


<div class="viewcode-block" id="sife"><a class="viewcode-back" href="../../../reference/derived.html#pynbody.snapshot.tipsy.sife">[docs]</a><span class="nd">@TipsySnap</span><span class="o">.</span><span class="n">derived_quantity</span>
<span class="k">def</span> <span class="nf">sife</span><span class="p">(</span><span class="n">sim</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Silicon-to-iron ratio [Si/Fe] derived from tipsy arrays MgMassFrac and FeMassFrac</span>
<span class="sd">    with solar values from Asplund et al 09&quot;&quot;&quot;</span>
    <span class="n">minsi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">amin</span><span class="p">(</span><span class="n">sim</span><span class="p">[</span><span class="s1">&#39;SiMassFrac&#39;</span><span class="p">][</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">sim</span><span class="p">[</span><span class="s1">&#39;SiMassFrac&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)])</span>
    <span class="n">sim</span><span class="p">[</span><span class="s1">&#39;SiMassFrac&#39;</span><span class="p">][</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">sim</span><span class="p">[</span><span class="s1">&#39;SiMassFrac&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)]</span> <span class="o">=</span> <span class="n">minsi</span>
    <span class="n">minfe</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">amin</span><span class="p">(</span><span class="n">sim</span><span class="p">[</span><span class="s1">&#39;FeMassFrac&#39;</span><span class="p">][</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">sim</span><span class="p">[</span><span class="s1">&#39;FeMassFrac&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)])</span>
    <span class="n">sim</span><span class="p">[</span><span class="s1">&#39;FeMassFrac&#39;</span><span class="p">][</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">sim</span><span class="p">[</span><span class="s1">&#39;FeMassFrac&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)]</span> <span class="o">=</span> <span class="n">minfe</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">sim</span><span class="p">[</span><span class="s1">&#39;SiMassFrac&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">sim</span><span class="p">[</span><span class="s1">&#39;FeMassFrac&#39;</span><span class="p">])</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">XSOLSi</span> <span class="o">/</span> <span class="n">XSOLFe</span><span class="p">)</span></div>


<div class="viewcode-block" id="c_s"><a class="viewcode-back" href="../../../reference/derived.html#pynbody.snapshot.tipsy.c_s">[docs]</a><span class="nd">@TipsySnap</span><span class="o">.</span><span class="n">derived_quantity</span>
<span class="k">def</span> <span class="nf">c_s</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Ideal gas sound speed based on pressure and density&quot;&quot;&quot;</span>
    <span class="c1">#x = np.sqrt(5./3.*units.k*self[&#39;temp&#39;]*self[&#39;mu&#39;])</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">5.</span> <span class="o">/</span> <span class="mf">3.</span> <span class="o">*</span> <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;p&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;rho&#39;</span><span class="p">])</span>
    <span class="n">x</span><span class="o">.</span><span class="n">convert_units</span><span class="p">(</span><span class="s1">&#39;km s^-1&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">x</span></div>


<div class="viewcode-block" id="c_s_turb"><a class="viewcode-back" href="../../../reference/derived.html#pynbody.snapshot.tipsy.c_s_turb">[docs]</a><span class="nd">@TipsySnap</span><span class="o">.</span><span class="n">derived_quantity</span>
<span class="k">def</span> <span class="nf">c_s_turb</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Turbulent sound speed (from Mac Low &amp; Klessen 2004)&quot;&quot;&quot;</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="s1">&#39;c_s&#39;</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="mf">1.</span> <span class="o">/</span> <span class="mi">3</span> <span class="o">*</span> <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;v_disp&#39;</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">x</span><span class="o">.</span><span class="n">convert_units</span><span class="p">(</span><span class="s1">&#39;km s^-1&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">x</span></div>


<div class="viewcode-block" id="mjeans"><a class="viewcode-back" href="../../../reference/derived.html#pynbody.snapshot.tipsy.mjeans">[docs]</a><span class="nd">@TipsySnap</span><span class="o">.</span><span class="n">derived_quantity</span>
<span class="k">def</span> <span class="nf">mjeans</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Classical Jeans mass&quot;&quot;&quot;</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">**</span> <span class="p">(</span><span class="mf">5.</span> <span class="o">/</span> <span class="mf">2.</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;c_s&#39;</span><span class="p">]</span> <span class="o">**</span> <span class="mi">3</span> <span class="o">/</span> \
        <span class="p">(</span><span class="mf">6.</span> <span class="o">*</span> <span class="n">units</span><span class="o">.</span><span class="n">G</span> <span class="o">**</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;rho&#39;</span><span class="p">]</span> <span class="o">**</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
    <span class="n">x</span><span class="o">.</span><span class="n">convert_units</span><span class="p">(</span><span class="s1">&#39;Msol&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">x</span></div>


<div class="viewcode-block" id="mjeans_turb"><a class="viewcode-back" href="../../../reference/derived.html#pynbody.snapshot.tipsy.mjeans_turb">[docs]</a><span class="nd">@TipsySnap</span><span class="o">.</span><span class="n">derived_quantity</span>
<span class="k">def</span> <span class="nf">mjeans_turb</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Turbulent Jeans mass&quot;&quot;&quot;</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">**</span> <span class="p">(</span><span class="mf">5.</span> <span class="o">/</span> <span class="mf">2.</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;c_s_turb&#39;</span><span class="p">]</span> <span class="o">**</span> <span class="mi">3</span> <span class="o">/</span> \
        <span class="p">(</span><span class="mf">6.</span> <span class="o">*</span> <span class="n">units</span><span class="o">.</span><span class="n">G</span> <span class="o">**</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;rho&#39;</span><span class="p">]</span> <span class="o">**</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
    <span class="n">x</span><span class="o">.</span><span class="n">convert_units</span><span class="p">(</span><span class="s1">&#39;Msol&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">x</span></div>


<div class="viewcode-block" id="ljeans"><a class="viewcode-back" href="../../../reference/derived.html#pynbody.snapshot.tipsy.ljeans">[docs]</a><span class="nd">@TipsySnap</span><span class="o">.</span><span class="n">derived_quantity</span>
<span class="k">def</span> <span class="nf">ljeans</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Jeans length&quot;&quot;&quot;</span>
    <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;c_s&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="p">(</span><span class="n">units</span><span class="o">.</span><span class="n">G</span> <span class="o">*</span> <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;rho&#39;</span><span class="p">]))</span>
    <span class="n">x</span><span class="o">.</span><span class="n">convert_units</span><span class="p">(</span><span class="s1">&#39;kpc&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">x</span></div>


<div class="viewcode-block" id="ljeans_turb"><a class="viewcode-back" href="../../../reference/derived.html#pynbody.snapshot.tipsy.ljeans_turb">[docs]</a><span class="nd">@TipsySnap</span><span class="o">.</span><span class="n">derived_quantity</span>
<span class="k">def</span> <span class="nf">ljeans_turb</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Turbulent Jeans length&quot;&quot;&quot;</span>
    <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;c_s_turb&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="p">(</span><span class="n">units</span><span class="o">.</span><span class="n">G</span> <span class="o">*</span> <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;rho&#39;</span><span class="p">]))</span>
    <span class="n">x</span><span class="o">.</span><span class="n">convert_units</span><span class="p">(</span><span class="s1">&#39;kpc&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">x</span></div>


<span class="k">class</span> <span class="nc">StarLog</span><span class="p">(</span><span class="n">SimSnap</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">paramfile</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">os</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">StarLog</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_filename</span> <span class="o">=</span> <span class="n">filename</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_paramfilename</span> <span class="o">=</span> <span class="n">paramfile</span>

        <span class="n">f</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">open_</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">properties</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">bigstarlog</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">molecH</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">bigIOrds</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="n">file_structure</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">({</span><span class="s1">&#39;names&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;iord&quot;</span><span class="p">,</span> <span class="s2">&quot;iorderGas&quot;</span><span class="p">,</span> <span class="s2">&quot;tform&quot;</span><span class="p">,</span>
                                             <span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;z&quot;</span><span class="p">,</span>
                                             <span class="s2">&quot;vx&quot;</span><span class="p">,</span> <span class="s2">&quot;vy&quot;</span><span class="p">,</span> <span class="s2">&quot;vz&quot;</span><span class="p">,</span>
                                             <span class="s2">&quot;massform&quot;</span><span class="p">,</span> <span class="s2">&quot;rhoform&quot;</span><span class="p">,</span> <span class="s2">&quot;tempform&quot;</span><span class="p">),</span>
                                   <span class="s1">&#39;formats&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;i4&#39;</span><span class="p">,</span> <span class="s1">&#39;i4&#39;</span><span class="p">,</span> <span class="s1">&#39;f8&#39;</span><span class="p">,</span>
                                               <span class="s1">&#39;f8&#39;</span><span class="p">,</span> <span class="s1">&#39;f8&#39;</span><span class="p">,</span> <span class="s1">&#39;f8&#39;</span><span class="p">,</span>
                                               <span class="s1">&#39;f8&#39;</span><span class="p">,</span> <span class="s1">&#39;f8&#39;</span><span class="p">,</span> <span class="s1">&#39;f8&#39;</span><span class="p">,</span>
                                               <span class="s1">&#39;f8&#39;</span><span class="p">,</span> <span class="s1">&#39;f8&#39;</span><span class="p">,</span> <span class="s1">&#39;f8&#39;</span><span class="p">)})</span>

        <span class="n">size</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s2">&quot;i&quot;</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1000</span> <span class="ow">or</span> <span class="n">size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_byteswap</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">f</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">size</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s2">&quot;&gt;i&quot;</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>
        <span class="n">iSize</span> <span class="o">=</span> <span class="n">size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">iSize</span> <span class="o">&gt;</span> <span class="n">file_structure</span><span class="o">.</span><span class="n">itemsize</span><span class="p">):</span>
            <span class="n">file_structure</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">({</span><span class="s1">&#39;names&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;iord&quot;</span><span class="p">,</span> <span class="s2">&quot;iorderGas&quot;</span><span class="p">,</span> <span class="s2">&quot;tform&quot;</span><span class="p">,</span>
                                             <span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;z&quot;</span><span class="p">,</span>
                                             <span class="s2">&quot;vx&quot;</span><span class="p">,</span> <span class="s2">&quot;vy&quot;</span><span class="p">,</span> <span class="s2">&quot;vz&quot;</span><span class="p">,</span>
                                             <span class="s2">&quot;massform&quot;</span><span class="p">,</span> <span class="s2">&quot;rhoform&quot;</span><span class="p">,</span> <span class="s2">&quot;tempform&quot;</span><span class="p">,</span><span class="s2">&quot;h2form&quot;</span><span class="p">),</span>
                                   <span class="s1">&#39;formats&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;i4&#39;</span><span class="p">,</span> <span class="s1">&#39;i4&#39;</span><span class="p">,</span> <span class="s1">&#39;f8&#39;</span><span class="p">,</span>
                                               <span class="s1">&#39;f8&#39;</span><span class="p">,</span> <span class="s1">&#39;f8&#39;</span><span class="p">,</span> <span class="s1">&#39;f8&#39;</span><span class="p">,</span>
                                               <span class="s1">&#39;f8&#39;</span><span class="p">,</span> <span class="s1">&#39;f8&#39;</span><span class="p">,</span> <span class="s1">&#39;f8&#39;</span><span class="p">,</span>
                                               <span class="s1">&#39;f8&#39;</span><span class="p">,</span> <span class="s1">&#39;f8&#39;</span><span class="p">,</span> <span class="s1">&#39;f8&#39;</span><span class="p">,</span><span class="s1">&#39;f8&#39;</span><span class="p">)})</span>
            <span class="n">molecH</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="c1"># Unfortunately molecularH with small iOrders has the same as</span>
            <span class="c1"># no moleculuarH with big iOrders.  Attempt to distinguish here</span>
            <span class="k">if</span><span class="p">(</span><span class="n">iSize</span> <span class="o">==</span> <span class="n">file_structure</span><span class="o">.</span><span class="n">itemsize</span><span class="p">):</span>
                <span class="k">if</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_byteswap</span><span class="p">):</span>
                    <span class="n">testread</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fromstring</span><span class="p">(</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">iSize</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">file_structure</span><span class="p">)</span><span class="o">.</span><span class="n">byteswap</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">testread</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fromstring</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">iSize</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">file_structure</span><span class="p">)</span>
                <span class="c1"># All star iorders are greater than any gas iorder</span>
                <span class="c1"># so this indicates a bad format. (N.B. there is the</span>
                <span class="c1"># possibility of a false negative)</span>
                <span class="k">if</span><span class="p">(</span><span class="n">testread</span><span class="p">[</span><span class="s1">&#39;iord&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">testread</span><span class="p">[</span><span class="s1">&#39;iorderGas&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]):</span> 
                    <span class="n">file_structure</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">({</span><span class="s1">&#39;names&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;iord&quot;</span><span class="p">,</span> <span class="s2">&quot;iorderGas&quot;</span><span class="p">,</span>
                                             <span class="s2">&quot;tform&quot;</span><span class="p">,</span>
                                             <span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;z&quot;</span><span class="p">,</span>
                                             <span class="s2">&quot;vx&quot;</span><span class="p">,</span> <span class="s2">&quot;vy&quot;</span><span class="p">,</span> <span class="s2">&quot;vz&quot;</span><span class="p">,</span>
                                             <span class="s2">&quot;massform&quot;</span><span class="p">,</span> <span class="s2">&quot;rhoform&quot;</span><span class="p">,</span> <span class="s2">&quot;tempform&quot;</span><span class="p">),</span>
                                       <span class="s1">&#39;formats&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;i8&#39;</span><span class="p">,</span> <span class="s1">&#39;i8&#39;</span><span class="p">,</span> <span class="s1">&#39;f8&#39;</span><span class="p">,</span>
                                                   <span class="s1">&#39;f8&#39;</span><span class="p">,</span> <span class="s1">&#39;f8&#39;</span><span class="p">,</span> <span class="s1">&#39;f8&#39;</span><span class="p">,</span>
                                                   <span class="s1">&#39;f8&#39;</span><span class="p">,</span> <span class="s1">&#39;f8&#39;</span><span class="p">,</span> <span class="s1">&#39;f8&#39;</span><span class="p">,</span>
                                                   <span class="s1">&#39;f8&#39;</span><span class="p">,</span> <span class="s1">&#39;f8&#39;</span><span class="p">,</span> <span class="s1">&#39;f8&#39;</span><span class="p">)})</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Using 64 bit iOrders&quot;</span><span class="p">)</span>
                    <span class="n">molecH</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="n">bigIOrds</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">iSize</span> <span class="o">!=</span> <span class="n">file_structure</span><span class="o">.</span><span class="n">itemsize</span><span class="p">):</span>
            <span class="n">file_structure</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">({</span><span class="s1">&#39;names&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;iord&quot;</span><span class="p">,</span> <span class="s2">&quot;iorderGas&quot;</span><span class="p">,</span> <span class="s2">&quot;tform&quot;</span><span class="p">,</span>
                                                 <span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;z&quot;</span><span class="p">,</span>
                                                 <span class="s2">&quot;vx&quot;</span><span class="p">,</span> <span class="s2">&quot;vy&quot;</span><span class="p">,</span> <span class="s2">&quot;vz&quot;</span><span class="p">,</span>
                                                 <span class="s2">&quot;massform&quot;</span><span class="p">,</span> <span class="s2">&quot;rhoform&quot;</span><span class="p">,</span> <span class="s2">&quot;tempform&quot;</span><span class="p">,</span>
                                                 <span class="s2">&quot;phiform&quot;</span><span class="p">,</span> <span class="s2">&quot;nsmooth&quot;</span><span class="p">),</span>
                                       <span class="s1">&#39;formats&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;i4&#39;</span><span class="p">,</span> <span class="s1">&#39;i4&#39;</span><span class="p">,</span> <span class="s1">&#39;f8&#39;</span><span class="p">,</span>
                                                   <span class="s1">&#39;f8&#39;</span><span class="p">,</span> <span class="s1">&#39;f8&#39;</span><span class="p">,</span> <span class="s1">&#39;f8&#39;</span><span class="p">,</span>
                                                   <span class="s1">&#39;f8&#39;</span><span class="p">,</span> <span class="s1">&#39;f8&#39;</span><span class="p">,</span> <span class="s1">&#39;f8&#39;</span><span class="p">,</span>
                                                   <span class="s1">&#39;f8&#39;</span><span class="p">,</span> <span class="s1">&#39;f8&#39;</span><span class="p">,</span> <span class="s1">&#39;f8&#39;</span><span class="p">,</span>
                                                   <span class="s1">&#39;f8&#39;</span><span class="p">,</span> <span class="s1">&#39;i4&#39;</span><span class="p">)})</span>
            <span class="n">molecH</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">iSize</span> <span class="o">!=</span> <span class="n">file_structure</span><span class="o">.</span><span class="n">itemsize</span> <span class="ow">and</span> <span class="n">iSize</span> <span class="o">!=</span> <span class="mi">104</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s2">&quot;Unknown starlog structure iSize:&quot;</span> <span class="o">+</span> \
                    <span class="nb">str</span><span class="p">(</span><span class="n">iSize</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;, file_structure itemsize:&quot;</span> <span class="o">+</span> \
                    <span class="nb">str</span><span class="p">(</span><span class="n">file_structure</span><span class="o">.</span><span class="n">itemsize</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">bigstarlog</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="n">molecH</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;h2 information found in StarLog!&quot;</span><span class="p">)</span>
        <span class="n">datasize</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getsize</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span> <span class="o">-</span> <span class="n">f</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span>

        <span class="c1"># check whether datasize is a multiple of iSize. If it is not,</span>
        <span class="c1"># the starlog is likely corrupted, but try to read it anyway</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">datasize</span> <span class="o">%</span> <span class="n">iSize</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">iSize</span> <span class="o">!=</span> <span class="mi">104</span><span class="p">):</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="s2">&quot;The size of the starlog file does not make sense -- it is likely corrupted. Pynbody will read it anyway, but use with caution.&quot;</span><span class="p">)</span>
            <span class="n">datasize</span> <span class="o">-=</span> <span class="n">datasize</span> <span class="o">%</span> <span class="n">iSize</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Reading starlog file </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
        <span class="k">if</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_byteswap</span><span class="p">):</span>
            <span class="n">g</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fromstring</span><span class="p">(</span>
                <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">datasize</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">file_structure</span><span class="p">)</span><span class="o">.</span><span class="n">byteswap</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">g</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fromstring</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">datasize</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">file_structure</span><span class="p">)</span>

        <span class="c1"># hoping to provide backward compatibility for np.unique by</span>
        <span class="c1"># copying relavent part of current numpy source:</span>
        <span class="c1"># numpy/lib/arraysetops.py:192 (on 22nd March 2011)</span>

        <span class="k">if</span> <span class="n">sort</span><span class="p">:</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="n">g</span><span class="p">[</span><span class="s1">&#39;iord&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
            <span class="c1"># mergesort for stability</span>
            <span class="n">perm</span> <span class="o">=</span> <span class="n">tmp</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;mergesort&#39;</span><span class="p">)</span>
            <span class="n">aux</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">[</span><span class="n">perm</span><span class="p">]</span>
            <span class="n">flag</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">aux</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">!=</span> <span class="n">aux</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="kc">True</span><span class="p">]))</span>
            <span class="n">iord</span> <span class="o">=</span> <span class="n">aux</span><span class="p">[</span><span class="n">flag</span><span class="p">]</span>
            <span class="n">indices</span> <span class="o">=</span> <span class="n">perm</span><span class="p">[</span><span class="n">flag</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_num_particles</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_num_particles</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">g</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_family_slice</span><span class="p">[</span><span class="n">family</span><span class="o">.</span><span class="n">star</span><span class="p">]</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_num_particles</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_create_arrays</span><span class="p">([</span><span class="s2">&quot;pos&quot;</span><span class="p">,</span> <span class="s2">&quot;vel&quot;</span><span class="p">],</span> <span class="mi">3</span><span class="p">)</span>
        <span class="k">if</span><span class="p">(</span><span class="n">bigIOrds</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_create_arrays</span><span class="p">([</span><span class="s2">&quot;iord&quot;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int64&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_create_arrays</span><span class="p">([</span><span class="s2">&quot;iord&quot;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int32&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_create_arrays</span><span class="p">([</span><span class="s2">&quot;iord&quot;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int32&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_create_arrays</span><span class="p">(</span>
            <span class="p">[</span><span class="s2">&quot;iorderGas&quot;</span><span class="p">,</span> <span class="s2">&quot;massform&quot;</span><span class="p">,</span> <span class="s2">&quot;rhoform&quot;</span><span class="p">,</span> <span class="s2">&quot;tempform&quot;</span><span class="p">,</span> <span class="s2">&quot;metals&quot;</span><span class="p">,</span> <span class="s2">&quot;tform&quot;</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">molecH</span><span class="o">==</span><span class="kc">True</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_create_arrays</span><span class="p">([</span><span class="s2">&quot;h2form&quot;</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">bigstarlog</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_create_arrays</span><span class="p">([</span><span class="s2">&quot;phiform&quot;</span><span class="p">,</span> <span class="s2">&quot;nsmooth&quot;</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_decorate</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">sort</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">file_structure</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">star</span><span class="p">[</span><span class="n">name</span><span class="p">][:]</span> <span class="o">=</span> <span class="n">g</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="n">indices</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">file_structure</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">star</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">g</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Write the starlog file. &quot;&quot;&quot;</span>

        <span class="k">global</span> <span class="n">config</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">lazy_off</span><span class="p">:</span>

            <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filename</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Writing starlog file as </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>

            <span class="n">f</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">open_</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="s1">&#39;phiform&#39;</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>  <span class="c1"># long starlog format</span>
                <span class="n">file_structure</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">({</span><span class="s1">&#39;names&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;iord&quot;</span><span class="p">,</span> <span class="s2">&quot;iorderGas&quot;</span><span class="p">,</span> <span class="s2">&quot;tform&quot;</span><span class="p">,</span>
                                                     <span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;z&quot;</span><span class="p">,</span>
                                                     <span class="s2">&quot;vx&quot;</span><span class="p">,</span> <span class="s2">&quot;vy&quot;</span><span class="p">,</span> <span class="s2">&quot;vz&quot;</span><span class="p">,</span>
                                                     <span class="s2">&quot;massform&quot;</span><span class="p">,</span> <span class="s2">&quot;rhoform&quot;</span><span class="p">,</span> <span class="s2">&quot;tempform&quot;</span><span class="p">,</span>
                                                     <span class="s2">&quot;phiform&quot;</span><span class="p">,</span> <span class="s2">&quot;nsmooth&quot;</span><span class="p">),</span>
                                           <span class="s1">&#39;formats&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;i4&#39;</span><span class="p">,</span> <span class="s1">&#39;i4&#39;</span><span class="p">,</span> <span class="s1">&#39;f8&#39;</span><span class="p">,</span>
                                                       <span class="s1">&#39;f8&#39;</span><span class="p">,</span> <span class="s1">&#39;f8&#39;</span><span class="p">,</span> <span class="s1">&#39;f8&#39;</span><span class="p">,</span>
                                                       <span class="s1">&#39;f8&#39;</span><span class="p">,</span> <span class="s1">&#39;f8&#39;</span><span class="p">,</span> <span class="s1">&#39;f8&#39;</span><span class="p">,</span>
                                                       <span class="s1">&#39;f8&#39;</span><span class="p">,</span> <span class="s1">&#39;f8&#39;</span><span class="p">,</span> <span class="s1">&#39;f8&#39;</span><span class="p">,</span>
                                                       <span class="s1">&#39;f8&#39;</span><span class="p">,</span> <span class="s1">&#39;i4&#39;</span><span class="p">)})</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># short (old) starlog format</span>
                <span class="n">file_structure</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">({</span><span class="s1">&#39;names&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;iord&quot;</span><span class="p">,</span> <span class="s2">&quot;iorderGas&quot;</span><span class="p">,</span> <span class="s2">&quot;tform&quot;</span><span class="p">,</span>
                                                     <span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;z&quot;</span><span class="p">,</span>
                                                     <span class="s2">&quot;vx&quot;</span><span class="p">,</span> <span class="s2">&quot;vy&quot;</span><span class="p">,</span> <span class="s2">&quot;vz&quot;</span><span class="p">,</span>
                                                     <span class="s2">&quot;massform&quot;</span><span class="p">,</span> <span class="s2">&quot;rhoform&quot;</span><span class="p">,</span> <span class="s2">&quot;tempform&quot;</span><span class="p">),</span>
                                           <span class="s1">&#39;formats&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;i4&#39;</span><span class="p">,</span> <span class="s1">&#39;i4&#39;</span><span class="p">,</span> <span class="s1">&#39;f8&#39;</span><span class="p">,</span>
                                                       <span class="s1">&#39;f8&#39;</span><span class="p">,</span> <span class="s1">&#39;f8&#39;</span><span class="p">,</span> <span class="s1">&#39;f8&#39;</span><span class="p">,</span>
                                                       <span class="s1">&#39;f8&#39;</span><span class="p">,</span> <span class="s1">&#39;f8&#39;</span><span class="p">,</span> <span class="s1">&#39;f8&#39;</span><span class="p">,</span>
                                                       <span class="s1">&#39;f8&#39;</span><span class="p">,</span> <span class="s1">&#39;f8&#39;</span><span class="p">,</span> <span class="s1">&#39;f8&#39;</span><span class="p">)})</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_byteswap</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s2">&quot;&gt;i&quot;</span><span class="p">,</span> <span class="n">file_structure</span><span class="o">.</span><span class="n">itemsize</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s2">&quot;i&quot;</span><span class="p">,</span> <span class="n">file_structure</span><span class="o">.</span><span class="n">itemsize</span><span class="p">))</span>

            <span class="n">max_block_size</span> <span class="o">=</span> <span class="mi">1024</span>  <span class="c1"># particles</span>

            <span class="n">n_left</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="n">n_done</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="k">while</span> <span class="n">n_left</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">n_block</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">n_left</span><span class="p">,</span> <span class="n">max_block_size</span><span class="p">)</span>

                <span class="n">g</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_block</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">file_structure</span><span class="p">)</span>

                <span class="k">for</span> <span class="n">arr</span> <span class="ow">in</span> <span class="n">file_structure</span><span class="o">.</span><span class="n">names</span><span class="p">:</span>
                    <span class="n">g</span><span class="p">[</span><span class="n">arr</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">arr</span><span class="p">][</span><span class="n">n_done</span><span class="p">:</span><span class="n">n_done</span> <span class="o">+</span> <span class="n">n_block</span><span class="p">]</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_byteswap</span><span class="p">:</span>
                    <span class="n">g</span><span class="o">.</span><span class="n">byteswap</span><span class="p">()</span><span class="o">.</span><span class="n">tofile</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">g</span><span class="o">.</span><span class="n">tofile</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

                <span class="n">n_left</span> <span class="o">-=</span> <span class="n">n_block</span>
                <span class="n">n_done</span> <span class="o">+=</span> <span class="n">n_block</span>

        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>


<span class="nd">@TipsySnap</span><span class="o">.</span><span class="n">decorator</span>
<span class="nd">@StarLog</span><span class="o">.</span><span class="n">decorator</span>
<span class="nd">@nchilada</span><span class="o">.</span><span class="n">NchiladaSnap</span><span class="o">.</span><span class="n">decorator</span>
<span class="k">def</span> <span class="nf">load_paramfile</span><span class="p">(</span><span class="n">sim</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">sys</span>
    <span class="kn">import</span> <span class="nn">os</span>
    <span class="kn">import</span> <span class="nn">glob</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">sim</span><span class="o">.</span><span class="n">_filename</span><span class="p">)</span>
    <span class="n">done</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">sim</span><span class="o">.</span><span class="n">_paramfile</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">f</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">sim</span><span class="o">.</span><span class="n">_paramfilename</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="n">l</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span>
                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="s2">&quot;*.param&quot;</span><span class="p">))</span> <span class="k">if</span> <span class="s2">&quot;mpeg&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">x</span><span class="p">]</span>

            <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">l</span><span class="p">:</span>
                <span class="c1"># Attempt the loading of information</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
                    <span class="n">done</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">break</span>  <span class="c1"># the file is there, break out of the loop</span>
                <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
                    <span class="n">l</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="s2">&quot;../*.param&quot;</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">l</span> <span class="o">==</span> <span class="p">[]:</span>
                        <span class="k">continue</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">l</span><span class="p">:</span>
                            <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
                            <span class="k">break</span>  <span class="c1"># the file is there, break out of the loop</span>
                    <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
                        <span class="k">continue</span>
            <span class="k">if</span> <span class="n">done</span><span class="p">:</span>
                <span class="k">break</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">sim</span><span class="o">.</span><span class="n">_paramfilename</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s2">&quot;The parameter filename you supplied is invalid&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">f</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span>

    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;#&quot;</span><span class="p">:</span>
                <span class="n">s</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;#&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                <span class="n">sim</span><span class="o">.</span><span class="n">_paramfile</span><span class="p">[</span><span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="mi">2</span><span class="p">:])</span>

        <span class="k">except</span> <span class="ne">IndexError</span> <span class="k">as</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sim</span><span class="o">.</span><span class="n">_paramfile</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">sim</span><span class="o">.</span><span class="n">_paramfile</span><span class="p">[</span><span class="s2">&quot;filename&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">filename</span>


<span class="nd">@TipsySnap</span><span class="o">.</span><span class="n">decorator</span>
<span class="nd">@StarLog</span><span class="o">.</span><span class="n">decorator</span>
<span class="nd">@nchilada</span><span class="o">.</span><span class="n">NchiladaSnap</span><span class="o">.</span><span class="n">decorator</span>
<span class="k">def</span> <span class="nf">param2units</span><span class="p">(</span><span class="n">sim</span><span class="p">):</span>
    <span class="k">with</span> <span class="n">sim</span><span class="o">.</span><span class="n">lazy_off</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">sys</span>
        <span class="kn">import</span> <span class="nn">math</span>
        <span class="kn">import</span> <span class="nn">os</span>
        <span class="kn">import</span> <span class="nn">glob</span>

        <span class="n">munit</span> <span class="o">=</span> <span class="n">dunit</span> <span class="o">=</span> <span class="n">hub</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">hub</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">sim</span><span class="o">.</span><span class="n">_paramfile</span><span class="p">[</span><span class="s2">&quot;dHubble0&quot;</span><span class="p">])</span>
            <span class="n">sim</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s1">&#39;omegaM0&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">sim</span><span class="o">.</span><span class="n">_paramfile</span><span class="p">[</span><span class="s2">&quot;dOmega0&quot;</span><span class="p">])</span>
            <span class="n">sim</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s1">&#39;omegaL0&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">sim</span><span class="o">.</span><span class="n">_paramfile</span><span class="p">[</span><span class="s2">&quot;dLambda&quot;</span><span class="p">])</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">munit_st</span> <span class="o">=</span> <span class="n">sim</span><span class="o">.</span><span class="n">_paramfile</span><span class="p">[</span><span class="s2">&quot;dMsolUnit&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot; Msol&quot;</span>
            <span class="n">munit</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">sim</span><span class="o">.</span><span class="n">_paramfile</span><span class="p">[</span><span class="s2">&quot;dMsolUnit&quot;</span><span class="p">])</span>
            <span class="n">dunit_st</span> <span class="o">=</span> <span class="n">sim</span><span class="o">.</span><span class="n">_paramfile</span><span class="p">[</span><span class="s2">&quot;dKpcUnit&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot; kpc&quot;</span>
            <span class="n">dunit</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">sim</span><span class="o">.</span><span class="n">_paramfile</span><span class="p">[</span><span class="s2">&quot;dKpcUnit&quot;</span><span class="p">])</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="k">if</span> <span class="n">munit</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">dunit</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">hub</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">sim</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s1">&#39;h&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">hub</span>
            <span class="k">return</span>

        <span class="n">denunit</span> <span class="o">=</span> <span class="n">munit</span> <span class="o">/</span> <span class="n">dunit</span> <span class="o">**</span> <span class="mi">3</span>
        <span class="n">denunit_st</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">denunit</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; Msol kpc^-3&quot;</span>

        <span class="c1">#</span>
        <span class="c1"># the obvious way:</span>
        <span class="c1">#</span>
        <span class="c1">#denunit_cgs = denunit * 6.7696e-32</span>
        <span class="c1">#kpc_in_km = 3.0857e16</span>
        <span class="c1">#secunit = 1./math.sqrt(denunit_cgs*6.67e-8)</span>
        <span class="c1">#velunit = dunit*kpc_in_km/secunit</span>

        <span class="c1"># the sensible way:</span>
        <span class="c1"># avoid numerical accuracy problems by concatinating factors:</span>
        <span class="n">velunit</span> <span class="o">=</span> <span class="mf">8.0285</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">6.6743e-8</span> <span class="o">*</span> <span class="n">denunit</span><span class="p">)</span> <span class="o">*</span> <span class="n">dunit</span>
        <span class="n">velunit_st</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">%.5g</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">velunit</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; km s^-1&quot;</span>

        <span class="c1"># You have: kpc s / km</span>
        <span class="c1"># You want: Gyr</span>
        <span class="c1">#* 0.97781311</span>
        <span class="n">timeunit</span> <span class="o">=</span> <span class="n">dunit</span> <span class="o">/</span> <span class="n">velunit</span> <span class="o">*</span> <span class="mf">0.97781311</span>
        <span class="n">timeunit_st</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">%.5g</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">timeunit</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; Gyr&quot;</span>

        <span class="c1">#  Assuming G=1 in code units, phi is actually vel^2/a^3.</span>
        <span class="c1"># See also gasoline&#39;s master.c:5511.</span>
        <span class="c1"># Or should we be calculating phi as GM/R units (which</span>
        <span class="c1"># is the same for G=1 runs)?</span>
        <span class="n">potunit_st</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%.5g</span><span class="s2"> km^2 s^-2&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">velunit</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>

        <span class="k">if</span> <span class="s1">&#39;bComove&#39;</span> <span class="ow">in</span> <span class="n">sim</span><span class="o">.</span><span class="n">_paramfile</span> <span class="ow">and</span> <span class="nb">int</span><span class="p">(</span><span class="n">sim</span><span class="o">.</span><span class="n">_paramfile</span><span class="p">[</span><span class="s1">&#39;bComove&#39;</span><span class="p">])</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">hubunit</span> <span class="o">=</span> <span class="mf">10.</span> <span class="o">*</span> <span class="n">velunit</span> <span class="o">/</span> <span class="n">dunit</span>
            <span class="n">hubunit_st</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">%.3f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">hubunit</span> <span class="o">*</span> <span class="n">hub</span><span class="p">))</span>
            <span class="n">sim</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s1">&#39;h&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">hub</span> <span class="o">*</span> <span class="n">hubunit</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sim</span><span class="p">,</span> <span class="n">StarLog</span><span class="p">):</span>
                <span class="n">a</span> <span class="o">=</span> <span class="s2">&quot;aform&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">a</span> <span class="o">=</span> <span class="s2">&quot;a&quot;</span>

            <span class="c1"># append dependence on &#39;a&#39; for cosmological runs</span>
            <span class="n">dunit_st</span> <span class="o">+=</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">a</span>
            <span class="n">denunit_st</span> <span class="o">+=</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">a</span> <span class="o">+</span> <span class="s2">&quot;^-3&quot;</span>
            <span class="n">velunit_st</span> <span class="o">+=</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">a</span>
            <span class="n">potunit_st</span> <span class="o">+=</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">a</span> <span class="o">+</span> <span class="s2">&quot;^-1&quot;</span>

            <span class="c1"># Assume the box size is equal to the length unit</span>
            <span class="n">sim</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s1">&#39;boxsize&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">units</span><span class="o">.</span><span class="n">Unit</span><span class="p">(</span><span class="n">dunit_st</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">sim</span><span class="p">[</span><span class="s2">&quot;vel&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="n">velunit_st</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">sim</span><span class="p">[</span><span class="s2">&quot;phi&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="n">potunit_st</span>
            <span class="n">sim</span><span class="p">[</span><span class="s2">&quot;eps&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="n">dunit_st</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">sim</span><span class="p">[</span><span class="s2">&quot;pos&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="n">dunit_st</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">sim</span><span class="o">.</span><span class="n">gas</span><span class="p">[</span><span class="s2">&quot;rho&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="n">denunit_st</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">sim</span><span class="p">[</span><span class="s2">&quot;mass&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="n">munit_st</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">sim</span><span class="o">.</span><span class="n">star</span><span class="p">[</span><span class="s2">&quot;tform&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="n">timeunit_st</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">sim</span><span class="o">.</span><span class="n">gas</span><span class="p">[</span><span class="s2">&quot;metals&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">sim</span><span class="o">.</span><span class="n">star</span><span class="p">[</span><span class="s2">&quot;metals&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">sim</span><span class="o">.</span><span class="n">_file_units_system</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">sim</span><span class="p">[</span><span class="s2">&quot;vel&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">units</span><span class="p">,</span> <span class="n">sim</span><span class="o">.</span><span class="n">star</span><span class="p">[</span><span class="s2">&quot;mass&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">units</span><span class="p">,</span> <span class="n">sim</span><span class="p">[</span><span class="s2">&quot;pos&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">units</span><span class="p">,</span> <span class="n">units</span><span class="o">.</span><span class="n">K</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">sim</span><span class="o">.</span><span class="n">_file_units_system</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">sim</span><span class="p">[</span><span class="s2">&quot;vel&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">units</span><span class="p">,</span> <span class="n">sim</span><span class="o">.</span><span class="n">star</span><span class="p">[</span><span class="s2">&quot;massform&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">units</span><span class="p">,</span> <span class="n">sim</span><span class="p">[</span><span class="s2">&quot;pos&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">units</span><span class="p">,</span> <span class="n">units</span><span class="o">.</span><span class="n">K</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">sim</span><span class="o">.</span><span class="n">_file_units_system</span> <span class="o">=</span> <span class="p">[</span><span class="n">units</span><span class="o">.</span><span class="n">Unit</span><span class="p">(</span><span class="n">velunit_st</span><span class="p">),</span>
                                              <span class="n">units</span><span class="o">.</span><span class="n">Unit</span><span class="p">(</span><span class="n">munit_st</span><span class="p">),</span>
                                              <span class="n">units</span><span class="o">.</span><span class="n">Unit</span><span class="p">(</span><span class="n">dunit_st</span><span class="p">),</span> <span class="n">units</span><span class="o">.</span><span class="n">K</span><span class="p">]</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">pass</span>

    <span class="n">sim</span><span class="o">.</span><span class="n">_override_units_system</span><span class="p">()</span>


<span class="nd">@TipsySnap</span><span class="o">.</span><span class="n">decorator</span>
<span class="k">def</span> <span class="nf">settime</span><span class="p">(</span><span class="n">sim</span><span class="p">):</span>
    <span class="k">if</span> <span class="s1">&#39;bComove&#39;</span> <span class="ow">in</span> <span class="n">sim</span><span class="o">.</span><span class="n">_paramfile</span> <span class="ow">and</span> <span class="nb">int</span><span class="p">(</span><span class="n">sim</span><span class="o">.</span><span class="n">_paramfile</span><span class="p">[</span><span class="s1">&#39;bComove&#39;</span><span class="p">])</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">sim</span><span class="o">.</span><span class="n">_header_t</span>
        <span class="n">sim</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">t</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">sim</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">t</span> <span class="o">-</span> <span class="mf">1.0</span>
        <span class="k">except</span> <span class="ne">ZeroDivisionError</span><span class="p">:</span>
            <span class="c1"># no sensible redshift</span>
            <span class="k">pass</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">sim</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span>
                <span class="s1">&#39;dMsolUnit&#39;</span> <span class="ow">in</span> <span class="n">sim</span><span class="o">.</span><span class="n">_paramfile</span> <span class="ow">and</span>
                <span class="s1">&#39;dKpcUnit&#39;</span> <span class="ow">in</span> <span class="n">sim</span><span class="o">.</span><span class="n">_paramfile</span><span class="p">):</span>
            <span class="kn">from</span> <span class="nn">..analysis</span> <span class="kn">import</span> <span class="n">cosmology</span>
            <span class="n">sim</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cosmology</span><span class="o">.</span><span class="n">age</span><span class="p">(</span>
                <span class="n">sim</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="n">sim</span><span class="o">.</span><span class="n">infer_original_units</span><span class="p">(</span><span class="s1">&#39;yr&#39;</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># something has gone wrong with the cosmological side of</span>
            <span class="c1"># things</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="s2">&quot;Paramfile suggests time is cosmological, but header values are not sensible in this context.&quot;</span><span class="p">,</span> <span class="ne">RuntimeWarning</span><span class="p">)</span>
            <span class="n">sim</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">t</span>

        <span class="n">sim</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">t</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Assume a non-cosmological run</span>
        <span class="n">sim</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sim</span><span class="o">.</span><span class="n">_header_t</span>

<span class="nd">@nchilada</span><span class="o">.</span><span class="n">NchiladaSnap</span><span class="o">.</span><span class="n">decorator</span>
<span class="k">def</span> <span class="nf">settimeN</span><span class="p">(</span><span class="n">sim</span><span class="p">):</span>
    <span class="k">if</span> <span class="s1">&#39;bComove&#39;</span> <span class="ow">in</span> <span class="n">sim</span><span class="o">.</span><span class="n">_paramfile</span> <span class="ow">and</span> <span class="nb">int</span><span class="p">(</span><span class="n">sim</span><span class="o">.</span><span class="n">_paramfile</span><span class="p">[</span><span class="s1">&#39;bComove&#39;</span><span class="p">])</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="c1">#t = sim._header_t</span>
        <span class="c1">#sim.properties[&#39;a&#39;] = t</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">sim</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">sim</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mf">1.0</span>
        <span class="k">except</span> <span class="ne">ZeroDivisionError</span><span class="p">:</span>
            <span class="c1"># no sensible redshift</span>
            <span class="k">pass</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">sim</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span>
                <span class="s1">&#39;dMsolUnit&#39;</span> <span class="ow">in</span> <span class="n">sim</span><span class="o">.</span><span class="n">_paramfile</span> <span class="ow">and</span>
                <span class="s1">&#39;dKpcUnit&#39;</span> <span class="ow">in</span> <span class="n">sim</span><span class="o">.</span><span class="n">_paramfile</span><span class="p">):</span>
            <span class="kn">from</span> <span class="nn">..analysis</span> <span class="kn">import</span> <span class="n">cosmology</span>
            <span class="n">sim</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cosmology</span><span class="o">.</span><span class="n">age</span><span class="p">(</span>
                <span class="n">sim</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="n">sim</span><span class="o">.</span><span class="n">infer_original_units</span><span class="p">(</span><span class="s1">&#39;yr&#39;</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># something has gone wrong with the cosmological side of</span>
            <span class="c1"># things</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="s2">&quot;Paramfile suggests time is cosmological, but header values are not sensible in this context.&quot;</span><span class="p">,</span> <span class="ne">RuntimeWarning</span><span class="p">)</span>
            <span class="n">sim</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sim</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">]</span>

        <span class="c1">#sim.properties[&#39;a&#39;] = t</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Assume a non-cosmological run</span>
        <span class="n">sim</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sim</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">]</span>

    <span class="n">time_unit</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">time_unit</span> <span class="o">=</span> <span class="n">sim</span><span class="o">.</span><span class="n">infer_original_units</span><span class="p">(</span><span class="s1">&#39;yr&#39;</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">units</span><span class="o">.</span><span class="n">UnitsException</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="k">if</span> <span class="n">time_unit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">sim</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span> <span class="o">*=</span> <span class="n">time_unit</span>


<span class="nd">@StarLog</span><span class="o">.</span><span class="n">decorator</span>
<span class="k">def</span> <span class="nf">slparam2units</span><span class="p">(</span><span class="n">sim</span><span class="p">):</span>
    <span class="k">with</span> <span class="n">sim</span><span class="o">.</span><span class="n">lazy_off</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">sys</span>
        <span class="kn">import</span> <span class="nn">math</span>
        <span class="kn">import</span> <span class="nn">os</span>
        <span class="kn">import</span> <span class="nn">glob</span>

        <span class="n">munit</span> <span class="o">=</span> <span class="n">dunit</span> <span class="o">=</span> <span class="n">hub</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">munit_st</span> <span class="o">=</span> <span class="n">sim</span><span class="o">.</span><span class="n">_paramfile</span><span class="p">[</span><span class="s2">&quot;dMsolUnit&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot; Msol&quot;</span>
            <span class="n">munit</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">sim</span><span class="o">.</span><span class="n">_paramfile</span><span class="p">[</span><span class="s2">&quot;dMsolUnit&quot;</span><span class="p">])</span>
            <span class="n">dunit_st</span> <span class="o">=</span> <span class="n">sim</span><span class="o">.</span><span class="n">_paramfile</span><span class="p">[</span><span class="s2">&quot;dKpcUnit&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot; kpc&quot;</span>
            <span class="n">dunit</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">sim</span><span class="o">.</span><span class="n">_paramfile</span><span class="p">[</span><span class="s2">&quot;dKpcUnit&quot;</span><span class="p">])</span>
            <span class="n">hub</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">sim</span><span class="o">.</span><span class="n">_paramfile</span><span class="p">[</span><span class="s2">&quot;dHubble0&quot;</span><span class="p">])</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="k">if</span> <span class="n">munit</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">dunit</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">denunit</span> <span class="o">=</span> <span class="n">munit</span> <span class="o">/</span> <span class="n">dunit</span> <span class="o">**</span> <span class="mi">3</span>
        <span class="n">denunit_st</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">denunit</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; Msol kpc^-3&quot;</span>
        <span class="n">velunit</span> <span class="o">=</span> <span class="mf">8.0285</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">6.6743e-8</span> <span class="o">*</span> <span class="n">denunit</span><span class="p">)</span> <span class="o">*</span> <span class="n">dunit</span>
        <span class="n">velunit_st</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">%.5g</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">velunit</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; km s^-1&quot;</span>

        <span class="c1"># You have: kpc s / km</span>
        <span class="c1"># You want: Gyr</span>
        <span class="c1">#* 0.97781311</span>
        <span class="n">timeunit</span> <span class="o">=</span> <span class="n">dunit</span> <span class="o">/</span> <span class="n">velunit</span> <span class="o">*</span> <span class="mf">0.97781311</span>
        <span class="n">timeunit_st</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">%.5g</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">timeunit</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; Gyr&quot;</span>


        <span class="k">if</span> <span class="n">hub</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># append dependence on &#39;a&#39; for cosmological runs</span>
            <span class="n">dunit_st</span> <span class="o">+=</span> <span class="s2">&quot; aform&quot;</span>

            <span class="c1"># denunit_st += &quot; a^-3&quot;</span>
            <span class="c1"># N.B. density comoving -&gt; physical conversion is done by Gasoline</span>
            <span class="c1"># itself</span>

        <span class="n">sim</span><span class="o">.</span><span class="n">star</span><span class="p">[</span><span class="s2">&quot;rhoform&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="n">denunit_st</span>
        <span class="n">sim</span><span class="o">.</span><span class="n">star</span><span class="p">[</span><span class="s2">&quot;massform&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="n">munit_st</span>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<p class="logo">
  <a href="../../../index.html">
    <img class="logo" src="../../../_static/logo.svg" alt="Logo"/>
    
  </a>
</p>








<h3>Navigation</h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorials/tutorials.html">Tutorials &amp; walkthroughs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../reference/index.html">Reference</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../index.html">Documentation overview</a><ul>
  <li><a href="../../index.html">Module code</a><ul>
  <li><a href="../snapshot.html">pynbody.snapshot</a><ul>
  </ul></li>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2011-20, pynbody team.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 3.1.2</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>