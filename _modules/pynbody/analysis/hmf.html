
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>pynbody.analysis.hmf &#8212; pynbody 1.0.0 documentation</title>
    <link rel="stylesheet" href="../../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/graphviz.css" />
    <script id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />

   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

<link href="https://fonts.googleapis.com/css?family=Quicksand" rel="stylesheet">
<link href="_static/customise.css" rel="stylesheet">
<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-38063425-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for pynbody.analysis.hmf</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">halo mass function (hmf)</span>
<span class="sd">========================</span>

<span class="sd">Various halo mass function routines. </span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">cosmology</span>
<span class="kn">from</span> <span class="nn">..</span> <span class="kn">import</span> <span class="n">units</span>
<span class="kn">from</span> <span class="nn">..</span> <span class="kn">import</span> <span class="n">util</span>
<span class="kn">import</span> <span class="nn">pynbody</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">scipy</span>
    <span class="kn">import</span> <span class="nn">scipy.interpolate</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="k">pass</span>

<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">import</span> <span class="nn">cmath</span>
<span class="kn">import</span> <span class="nn">tempfile</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;pynbody.analysis.hmf&#39;</span><span class="p">)</span>


<span class="c1">#######################################################################</span>
<span class="c1"># Filters</span>
<span class="c1">#######################################################################</span>

<span class="k">class</span> <span class="nc">FieldFilter</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Cannot instantiate directly, use a subclass instead&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">M_to_R</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">M</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the mass scale (Msol h^-1) for a given length (Mpc h^-1 comoving)&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">M</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gammaF</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">rho_bar</span><span class="p">))</span> <span class="o">**</span> <span class="mf">0.3333</span>

    <span class="k">def</span> <span class="nf">R_to_M</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">R</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the length scale (Mpc h^-1 comoving) for a given spherical mass (Msol h^-1)&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">gammaF</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">rho_bar</span> <span class="o">*</span> <span class="n">R</span> <span class="o">**</span> <span class="mi">3</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">Wk</span><span class="p">(</span><span class="n">kR</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Not implemented&quot;</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">TophatFilter</span><span class="p">(</span><span class="n">FieldFilter</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gammaF</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">3</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rho_bar</span> <span class="o">=</span> <span class="n">cosmology</span><span class="o">.</span><span class="n">rho_M</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;Msol Mpc^-3 h^2 a^-3&quot;</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">Wk</span><span class="p">(</span><span class="n">kR</span><span class="p">):</span>
        <span class="k">return</span> <span class="mi">3</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">kR</span><span class="p">)</span> <span class="o">-</span> <span class="n">kR</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">kR</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="n">kR</span><span class="p">)</span> <span class="o">**</span> <span class="mi">3</span>


<span class="k">class</span> <span class="nc">GaussianFilter</span><span class="p">(</span><span class="n">FieldFilter</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gammaF</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">**</span> <span class="mf">1.5</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rho_bar</span> <span class="o">=</span> <span class="n">cosmology</span><span class="o">.</span><span class="n">rho_M</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;Msol Mpc^-3 h^2 a^-3&quot;</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">Wk</span><span class="p">(</span><span class="n">kR</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">kR</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">HarmonicStepFilter</span><span class="p">(</span><span class="n">FieldFilter</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gammaF</span> <span class="o">=</span> <span class="mi">6</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span> <span class="o">**</span> <span class="mi">2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rho_bar</span> <span class="o">=</span> <span class="n">cosmology</span><span class="o">.</span><span class="n">rho_M</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;Msol Mpc^-3 h^2 a^-3&quot;</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">Wk</span><span class="p">(</span><span class="n">kR</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">kR</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span>

<span class="c1">#######################################################################</span>
<span class="c1"># Power spectrum management / normalization</span>
<span class="c1">#######################################################################</span>


<span class="k">class</span> <span class="nc">PowerSpectrumCAMB</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">log_interpolation</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="s2">&quot;Using the default power-spectrum spectrum which assumes ns=0.96 and WMAP7+H0+BAO transfer function.&quot;</span><span class="p">,</span> <span class="ne">RuntimeWarning</span><span class="p">)</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">),</span> <span class="s2">&quot;CAMB_WMAP7&quot;</span><span class="p">)</span>

        <span class="n">k</span><span class="p">,</span> <span class="n">Pk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">unpack</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_orig_k_min</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_orig_k_max</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>

        <span class="n">bot_k</span> <span class="o">=</span> <span class="mf">1.e-5</span>

        <span class="k">if</span> <span class="n">k</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">bot_k</span><span class="p">:</span>
            <span class="c1"># extrapolate out</span>
            <span class="n">n</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">Pk</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">Pk</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="n">math</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">k</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">k</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

            <span class="n">Pkinterp</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">**</span> <span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">Pk</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">-</span> <span class="n">math</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">k</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">bot_k</span><span class="p">)</span> <span class="o">*</span> <span class="n">n</span><span class="p">)</span>
            <span class="n">k</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">bot_k</span><span class="p">,</span> <span class="n">k</span><span class="p">))</span>
            <span class="n">Pk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">Pkinterp</span><span class="p">,</span> <span class="n">Pk</span><span class="p">))</span>

        <span class="n">top_k</span> <span class="o">=</span> <span class="mf">1.e7</span>

        <span class="k">if</span> <span class="n">k</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">top_k</span><span class="p">:</span>
            <span class="c1"># extrapolate out</span>
            <span class="n">n</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">Pk</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">Pk</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span> <span class="o">/</span> <span class="n">math</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">k</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">k</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span>

            <span class="n">Pkinterp</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">**</span> <span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">Pk</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                                         <span class="p">)</span> <span class="o">-</span> <span class="n">math</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">k</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">top_k</span><span class="p">)</span> <span class="o">*</span> <span class="n">n</span><span class="p">)</span>
            <span class="n">k</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">k</span><span class="p">,</span> <span class="n">top_k</span><span class="p">))</span>
            <span class="n">Pk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">Pk</span><span class="p">,</span> <span class="n">Pkinterp</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">k</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">pynbody</span><span class="o">.</span><span class="n">array</span><span class="o">.</span><span class="n">SimArray</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s2">&quot;Mpc^-1 h a^-1&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">Pk</span> <span class="o">=</span> <span class="n">Pk</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">pynbody</span><span class="o">.</span><span class="n">array</span><span class="o">.</span><span class="n">SimArray</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Pk</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s2">&quot;Mpc^3 h^-3&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="o">.</span><span class="n">sim</span> <span class="o">=</span> <span class="n">context</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Pk</span><span class="o">.</span><span class="n">sim</span> <span class="o">=</span> <span class="n">context</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_lingrowth</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="n">context</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_lingrowth</span> <span class="o">=</span> <span class="n">cosmology</span><span class="o">.</span><span class="n">linear_growth_factor</span><span class="p">(</span><span class="n">context</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_default_filter</span> <span class="o">=</span> <span class="n">TophatFilter</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">min_k</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_k</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_norm</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_log_interp</span> <span class="o">=</span> <span class="n">log_interpolation</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_init_interpolation</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">set_sigma8</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s1">&#39;sigma8&#39;</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">_init_interpolation</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_log_interp</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_interp</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">interpolate</span><span class="o">.</span><span class="n">interp1d</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Pk</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_interp</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">interpolate</span><span class="o">.</span><span class="n">interp1d</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">Pk</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">set_sigma8</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sigma8</span><span class="p">):</span>
        <span class="n">current_sigma8_2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_sigma8</span><span class="p">()</span> <span class="o">**</span> <span class="mi">2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_norm</span> <span class="o">*=</span> <span class="n">sigma8</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">/</span> <span class="n">current_sigma8_2</span>

    <span class="k">def</span> <span class="nf">get_sigma8</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">current_sigma8</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span>
            <span class="n">variance</span><span class="p">(</span><span class="mf">8.0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_default_filter</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lingrowth</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">current_sigma8</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">k</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_orig_k_min</span><span class="p">):</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="s2">&quot;Power spectrum does not extend to low enough k; using power-law extrapolation (this is likely to be fine)&quot;</span><span class="p">,</span> <span class="ne">RuntimeWarning</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">k</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_orig_k_max</span><span class="p">):</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="s2">&quot;Power spectrum does not extend to high enough k; using power-law extrapolation. This is bad but your results are unlikely to be sensitive to it unless they relate directly to very small scales or you have run CAMB with inappropriate settings.&quot;</span><span class="p">,</span> <span class="ne">RuntimeWarning</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_log_interp</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_norm</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lingrowth</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_interp</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">k</span><span class="p">)))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_norm</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lingrowth</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_interp</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">k</span><span class="p">))</span>


<span class="k">class</span> <span class="nc">PowerSpectrumCAMBLive</span><span class="p">(</span><span class="n">PowerSpectrumCAMB</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">use_context</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">camb_params</span><span class="o">=</span><span class="p">{},</span> <span class="n">log_interpolation</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Run CAMB to get out a power spectrum. The default parameters are in cambtemplate.ini.</span>
<span class="sd">        Any of these can be modified by passing the appropriate kwarg.&quot;&quot;&quot;</span>

        <span class="kn">from</span> <span class="nn">..</span> <span class="kn">import</span> <span class="n">config_parser</span>
        <span class="n">path_to_camb</span> <span class="o">=</span> <span class="n">config_parser</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;camb&#39;</span><span class="p">,</span> <span class="s1">&#39;path&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">path_to_camb</span> <span class="o">==</span> <span class="s1">&#39;/path/to/camb&#39;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;You need to compile CAMB and set up the executable path in your pynbody configuration file.&quot;</span><span class="p">)</span>

        <span class="n">file_in</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">),</span> <span class="s2">&quot;cambtemplate.ini&quot;</span><span class="p">),</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span>
        <span class="n">folder_out</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkdtemp</span><span class="p">()</span>
        <span class="n">file_out</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder_out</span><span class="p">,</span> <span class="s2">&quot;camb.ini&quot;</span><span class="p">),</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">use_context</span><span class="p">:</span>
            <span class="n">h0</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s1">&#39;h&#39;</span><span class="p">]</span>
            <span class="n">omB0</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s1">&#39;omegaB0&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">h0</span> <span class="o">**</span> <span class="mi">2</span>
            <span class="n">omM0</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s1">&#39;omegaM0&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">h0</span> <span class="o">**</span> <span class="mi">2</span>
            <span class="n">omC0</span> <span class="o">=</span> <span class="n">omM0</span> <span class="o">-</span> <span class="n">omB0</span>
            <span class="n">ns</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s1">&#39;ns&#39;</span><span class="p">]</span>
            <span class="n">running</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s1">&#39;running&#39;</span><span class="p">]</span>
            <span class="n">camb_params</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;ombh2&#39;</span><span class="p">:</span> <span class="n">omB0</span><span class="p">,</span> <span class="s1">&#39;omch2&#39;</span><span class="p">:</span> <span class="n">omC0</span><span class="p">,</span> <span class="s1">&#39;hubble&#39;</span><span class="p">:</span> <span class="n">h0</span> <span class="o">*</span>
                                <span class="mi">100</span><span class="p">,</span> <span class="s1">&#39;scalar_nrun(1)&#39;</span><span class="p">:</span> <span class="n">running</span><span class="p">,</span> <span class="s1">&#39;scalar_spectral_index(1)&#39;</span><span class="p">:</span> <span class="n">ns</span><span class="p">})</span>

        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">file_in</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;=&quot;</span> <span class="ow">in</span> <span class="n">line</span> <span class="ow">and</span> <span class="s2">&quot;#&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                <span class="n">name</span><span class="p">,</span> <span class="n">val</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="p">)</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">camb_params</span><span class="p">:</span>
                    <span class="n">val</span> <span class="o">=</span> <span class="n">camb_params</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s2">&quot;=&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">file_out</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span> <span class="n">file</span><span class="o">=</span><span class="n">file_out</span><span class="p">)</span>

        <span class="n">file_out</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Running </span><span class="si">%s</span><span class="s2"> on </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span>
                    <span class="p">(</span><span class="n">path_to_camb</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder_out</span><span class="p">,</span> <span class="s2">&quot;camb.ini&quot;</span><span class="p">)))</span>
        <span class="n">subprocess</span><span class="o">.</span><span class="n">check_output</span><span class="p">(</span><span class="s2">&quot;cd </span><span class="si">%s</span><span class="s2">; </span><span class="si">%s</span><span class="s2"> camb.ini&quot;</span> <span class="o">%</span>
                                <span class="p">(</span><span class="n">folder_out</span><span class="p">,</span> <span class="n">path_to_camb</span><span class="p">),</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">PowerSpectrumCAMB</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">folder_out</span><span class="p">,</span> <span class="s2">&quot;test_matterpower.dat&quot;</span><span class="p">),</span> <span class="n">log_interpolation</span><span class="o">=</span><span class="n">log_interpolation</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">BiasedPowerSpectrum</span><span class="p">(</span><span class="n">PowerSpectrumCAMB</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bias</span><span class="p">,</span> <span class="n">pspec</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set up a biased power spectrum.</span>

<span class="sd">        **args**</span>
<span class="sd">          bias: either a number for a fixed bias, or a function taking</span>
<span class="sd">                the wavenumber k in Mpc/h and returning the bias</span>

<span class="sd">          pspec: the underlying power spectrum</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">bias</span><span class="p">,</span> <span class="s1">&#39;__call__&#39;</span><span class="p">):</span>
            <span class="n">bias</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">bias</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_bias</span> <span class="o">=</span> <span class="n">bias</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pspec</span> <span class="o">=</span> <span class="n">pspec</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_norm</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">min_k</span> <span class="o">=</span> <span class="n">pspec</span><span class="o">.</span><span class="n">min_k</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_k</span> <span class="o">=</span> <span class="n">pspec</span><span class="o">.</span><span class="n">max_k</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">k</span> <span class="o">=</span> <span class="n">pspec</span><span class="o">.</span><span class="n">k</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Pk</span> <span class="o">=</span> <span class="n">pspec</span><span class="o">.</span><span class="n">Pk</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bias</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_norm</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pspec</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bias</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>


<span class="c1">#######################################################################</span>
<span class="c1"># Variance calculation</span>
<span class="c1">#######################################################################</span>

<span class="k">def</span> <span class="nf">variance</span><span class="p">(</span><span class="n">M</span><span class="p">,</span> <span class="n">f_filter</span><span class="o">=</span><span class="n">TophatFilter</span><span class="p">,</span> <span class="n">powspec</span><span class="o">=</span><span class="n">PowerSpectrumCAMB</span><span class="p">,</span> <span class="n">arg_is_R</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">M</span><span class="p">,</span> <span class="s1">&#39;__len__&#39;</span><span class="p">):</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">pynbody</span><span class="o">.</span><span class="n">array</span><span class="o">.</span><span class="n">SimArray</span><span class="p">(</span>
            <span class="p">[</span><span class="n">variance</span><span class="p">(</span><span class="n">Mi</span><span class="p">,</span> <span class="n">f_filter</span><span class="p">,</span> <span class="n">powspec</span><span class="p">,</span> <span class="n">arg_is_R</span><span class="p">)</span> <span class="k">for</span> <span class="n">Mi</span> <span class="ow">in</span> <span class="n">M</span><span class="p">])</span>
        <span class="c1"># hopefully dimensionless</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="n">powspec</span><span class="o">.</span><span class="n">Pk</span><span class="o">.</span><span class="n">units</span> <span class="o">*</span> <span class="n">powspec</span><span class="o">.</span><span class="n">k</span><span class="o">.</span><span class="n">units</span> <span class="o">**</span> <span class="mi">3</span>
        <span class="k">return</span> <span class="n">ax</span>

    <span class="k">if</span> <span class="n">arg_is_R</span><span class="p">:</span>
        <span class="n">R</span> <span class="o">=</span> <span class="n">M</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">R</span> <span class="o">=</span> <span class="n">f_filter</span><span class="o">.</span><span class="n">M_to_R</span><span class="p">(</span><span class="n">M</span><span class="p">)</span>

    <span class="n">integrand</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">k</span><span class="p">:</span> <span class="n">k</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">powspec</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">*</span> <span class="n">f_filter</span><span class="o">.</span><span class="n">Wk</span><span class="p">(</span><span class="n">k</span> <span class="o">*</span> <span class="n">R</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>
    <span class="n">integrand_ln_k</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">k</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">*</span> <span class="n">integrand</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">k</span><span class="p">))</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">integrate</span><span class="o">.</span><span class="n">romberg</span><span class="p">(</span><span class="n">integrand_ln_k</span><span class="p">,</span> <span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">powspec</span><span class="o">.</span><span class="n">min_k</span><span class="p">),</span> <span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
        <span class="mf">1.</span> <span class="o">/</span> <span class="n">R</span><span class="p">)</span> <span class="o">+</span> <span class="mi">3</span><span class="p">,</span> <span class="n">divmax</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">rtol</span><span class="o">=</span><span class="mf">1.e-4</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">v</span>


<span class="k">def</span> <span class="nf">estimate_neffm</span><span class="p">(</span><span class="n">M</span><span class="p">,</span> <span class="n">f_filter</span><span class="o">=</span><span class="n">TophatFilter</span><span class="p">,</span> <span class="n">powspec</span><span class="o">=</span><span class="n">PowerSpectrumCAMB</span><span class="p">,</span> <span class="n">arg_is_R</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="c1"># this routine is opaque and inefficient</span>
    <span class="n">dlnm</span> <span class="o">=</span> <span class="mf">0.01</span>  <span class="c1"># just needs to be small</span>

<span class="c1"># if hasattr(M,&#39;__len__&#39;) : ## why is this needed?</span>
<span class="c1">#        ax =  pynbody.array.SimArray([estimate_neffm(Mi, f_filter, powspec) for Mi in M])</span>
<span class="c1"># ax.units = powspec.Pk.units/ powspec.Pk.units * powspec.k.units**3 / powspec.k.units**3  # hopefully dimensionless</span>
<span class="c1">#        return ax</span>

    <span class="n">M2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">M</span><span class="p">)</span> <span class="o">+</span> <span class="n">dlnm</span><span class="p">)</span>
    <span class="n">sig</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">variance</span><span class="p">(</span><span class="n">M</span><span class="p">,</span> <span class="n">f_filter</span><span class="p">,</span> <span class="n">powspec</span><span class="p">))</span>
    <span class="n">sig2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">variance</span><span class="p">(</span><span class="n">M2</span><span class="p">,</span> <span class="n">f_filter</span><span class="p">,</span> <span class="n">powspec</span><span class="p">))</span>
    <span class="c1">#  neff = 6 dlnsigmainv / dlnm, eq. 13 reed et al. 2007</span>
    <span class="n">neff</span> <span class="o">=</span> <span class="mf">6.</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">sig</span> <span class="o">/</span> <span class="n">sig2</span><span class="p">))</span> <span class="o">/</span> <span class="n">dlnm</span> <span class="o">-</span> <span class="mf">3.</span>

    <span class="k">return</span> <span class="n">neff</span>


<span class="k">def</span> <span class="nf">get_neffm</span><span class="p">(</span><span class="n">mass</span><span class="p">,</span> <span class="n">sigma</span><span class="p">):</span>
            <span class="c1">#  neff = 6 dlnsigmainv / dlnm - 3, eq. 13 reed et al. 2007</span>
    <span class="n">dlnm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">mass</span><span class="p">))</span>
    <span class="n">dlnsigmainv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">1.</span> <span class="o">/</span> <span class="n">sigma</span><span class="p">))</span>
    <span class="n">neff</span> <span class="o">=</span> <span class="mf">6.</span> <span class="o">*</span> <span class="n">dlnsigmainv</span> <span class="o">/</span> <span class="n">dlnm</span> <span class="o">-</span> <span class="mf">3.</span>
    <span class="k">return</span> <span class="n">neff</span>


<span class="nd">@units</span><span class="o">.</span><span class="n">takes_arg_in_units</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;Mpc h^-1&quot;</span><span class="p">))</span>
<span class="k">def</span> <span class="nf">correlation</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">powspec</span><span class="o">=</span><span class="n">PowerSpectrumCAMB</span><span class="p">):</span>

    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="s1">&#39;__len__&#39;</span><span class="p">):</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">pynbody</span><span class="o">.</span><span class="n">array</span><span class="o">.</span><span class="n">SimArray</span><span class="p">([</span><span class="n">correlation</span><span class="p">(</span><span class="n">ri</span><span class="p">,</span>  <span class="n">powspec</span><span class="p">)</span> <span class="k">for</span> <span class="n">ri</span> <span class="ow">in</span> <span class="n">r</span><span class="p">])</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="n">powspec</span><span class="o">.</span><span class="n">Pk</span><span class="o">.</span><span class="n">units</span> <span class="o">*</span> <span class="n">powspec</span><span class="o">.</span><span class="n">k</span><span class="o">.</span><span class="n">units</span> <span class="o">**</span> <span class="mi">3</span>
        <span class="k">return</span> <span class="n">ax</span>

    <span class="c1"># Because sin kr becomes so highly oscilliatory, normal</span>
    <span class="c1"># quadrature is slow/inaccurate for this problem. The following</span>
    <span class="c1"># is the best way I could come up with to overcome that.</span>
    <span class="c1">#</span>
    <span class="c1"># For small kr, sin kr/kr is represented as a Taylor expansion and</span>
    <span class="c1"># each segment of the power spectrum is integrated over, summing</span>
    <span class="c1"># over the Taylor series to convergence.</span>
    <span class="c1">#</span>
    <span class="c1"># When the convergence of this starts to fail, each segment of the</span>
    <span class="c1"># power spectrum is still represented by a power law, but the</span>
    <span class="c1"># exact integral boils down to a normal incomplete gamma function</span>
    <span class="c1"># extended into the complex plane.</span>
    <span class="c1">#</span>
    <span class="c1"># Originally, we had:</span>
    <span class="c1">#</span>
    <span class="c1"># integrand = lambda k: k**2 * powspec(k) * (np.sin(k*r)/(k*r))</span>
    <span class="c1"># integrand_ln_k = lambda k: np.exp(k)*integrand(np.exp(k))</span>
    <span class="c1">#</span>

    <span class="n">tot</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">defer</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="n">k</span> <span class="o">=</span> <span class="n">powspec</span><span class="o">.</span><span class="n">k</span>

    <span class="n">gamma_method</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">for</span> <span class="n">k_bot</span><span class="p">,</span> <span class="n">k_top</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">k</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">k</span><span class="p">[</span><span class="mi">1</span><span class="p">:]):</span>

        <span class="k">if</span> <span class="n">k_bot</span> <span class="o">&gt;=</span> <span class="n">k_top</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="c1"># express segment as P(k) = P0*k^n</span>
        <span class="n">Pk_top</span> <span class="o">=</span> <span class="n">powspec</span><span class="p">(</span><span class="n">k_top</span><span class="p">)</span>
        <span class="n">Pk_bot</span> <span class="o">=</span> <span class="n">powspec</span><span class="p">(</span><span class="n">k_bot</span><span class="p">)</span>

        <span class="n">n</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">Pk_top</span> <span class="o">/</span> <span class="n">Pk_bot</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">k_top</span> <span class="o">/</span> <span class="n">k_bot</span><span class="p">)</span>
        <span class="n">P0</span> <span class="o">=</span> <span class="n">Pk_top</span> <span class="o">/</span> <span class="n">k_top</span> <span class="o">**</span> <span class="n">n</span>

        <span class="k">if</span> <span class="n">n</span> <span class="o">!=</span> <span class="n">n</span> <span class="ow">or</span> <span class="nb">abs</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="c1"># looks nasty in log space, so interpolate linearly instead</span>
            <span class="n">grad</span> <span class="o">=</span> <span class="p">(</span><span class="n">Pk_top</span> <span class="o">-</span> <span class="n">Pk_bot</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">k_top</span> <span class="o">-</span> <span class="n">k_bot</span><span class="p">)</span>
            <span class="n">segment</span> <span class="o">=</span> <span class="p">((</span><span class="o">-</span><span class="mi">2</span> <span class="o">*</span> <span class="n">grad</span> <span class="o">+</span> <span class="n">k_bot</span> <span class="o">*</span> <span class="n">Pk_bot</span> <span class="o">*</span> <span class="n">r</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">k_bot</span> <span class="o">*</span> <span class="n">r</span><span class="p">)</span> <span class="o">+</span>
                       <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">grad</span> <span class="o">-</span> <span class="n">k_top</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">grad</span> <span class="o">*</span> <span class="n">k_bot</span><span class="p">)</span> <span class="o">+</span> <span class="n">grad</span> <span class="o">*</span> <span class="n">k_top</span> <span class="o">+</span> <span class="n">Pk_bot</span><span class="p">)</span> <span class="o">*</span> <span class="n">r</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">k_top</span> <span class="o">*</span> <span class="n">r</span><span class="p">)</span> <span class="o">-</span>
                       <span class="p">(</span><span class="n">grad</span> <span class="o">*</span> <span class="n">k_bot</span> <span class="o">+</span> <span class="n">Pk_bot</span><span class="p">)</span> <span class="o">*</span> <span class="n">r</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">k_bot</span> <span class="o">*</span> <span class="n">r</span><span class="p">)</span> <span class="o">+</span>
                       <span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">grad</span> <span class="o">*</span> <span class="n">k_bot</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">grad</span> <span class="o">*</span> <span class="n">k_top</span> <span class="o">+</span> <span class="n">Pk_bot</span><span class="p">)</span> <span class="o">*</span> <span class="n">r</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">k_top</span> <span class="o">*</span> <span class="n">r</span><span class="p">))</span> <span class="o">/</span> <span class="n">r</span> <span class="o">**</span> <span class="mi">4</span>

        <span class="k">elif</span> <span class="n">k_top</span> <span class="o">*</span> <span class="n">r</span> <span class="o">&lt;</span> <span class="mf">6.0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">gamma_method</span><span class="p">:</span>
            <span class="c1"># approximate sin y/y as polynomial = \sum_m coeff_m y^m</span>

            <span class="n">segment</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">term</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="n">m</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">coeff</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">while</span> <span class="n">m</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">term</span> <span class="o">/</span> <span class="n">segment</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">1.e-7</span> <span class="ow">and</span> <span class="n">m</span> <span class="o">&lt;</span> <span class="mi">50</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">m</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">coeff</span> <span class="o">*=</span> <span class="p">(</span><span class="o">-</span><span class="mf">1.0</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">m</span> <span class="o">*</span> <span class="p">(</span><span class="n">m</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>

                <span class="c1"># integral is P0 * r^m * int_(k_bot)^(k_top) k^(2+n+m) dk = P0</span>
                <span class="c1"># r^m [k^(3+n+m)/(3+n+m)]</span>
                <span class="n">top_val</span> <span class="o">=</span> <span class="n">k_top</span> <span class="o">**</span> <span class="p">(</span><span class="mi">3</span> <span class="o">+</span> <span class="n">n</span> <span class="o">+</span> <span class="n">m</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">3</span> <span class="o">+</span> <span class="n">n</span> <span class="o">+</span> <span class="n">m</span><span class="p">)</span>
                <span class="n">bot_val</span> <span class="o">=</span> <span class="n">k_bot</span> <span class="o">**</span> <span class="p">(</span><span class="mi">3</span> <span class="o">+</span> <span class="n">n</span> <span class="o">+</span> <span class="n">m</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">3</span> <span class="o">+</span> <span class="n">n</span> <span class="o">+</span> <span class="n">m</span><span class="p">)</span>
                <span class="n">term</span> <span class="o">=</span> <span class="n">P0</span> <span class="o">*</span> <span class="p">(</span><span class="n">r</span> <span class="o">**</span> <span class="n">m</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">top_val</span> <span class="o">-</span> <span class="n">bot_val</span><span class="p">)</span> <span class="o">*</span> <span class="n">coeff</span>
                <span class="n">segment</span> <span class="o">+=</span> <span class="n">term</span>
                <span class="n">m</span> <span class="o">+=</span> <span class="mi">2</span>

            <span class="k">if</span> <span class="n">m</span> <span class="o">&gt;=</span> <span class="mi">50</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Convergence failure in sin y/y series integral&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">m</span> <span class="o">&gt;</span> <span class="mi">18</span><span class="p">:</span>
                <span class="n">gamma_method</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="c1"># experience suggests when you have to sum beyond m=18, it&#39;s faster</span>
                <span class="c1"># to switch to the method below</span>

        <span class="k">else</span><span class="p">:</span>

            <span class="c1"># now integral of this segment is exactly</span>
            <span class="c1"># P0 * int_(k_bot)^(k_top) k^(2+n) sin(kr)/(kr) = (P0/r^(n+3)) Im[ (i)^(-n-2) Gamma(n+2,i k_bot r, i k_top r)]</span>
            <span class="c1"># First we need to evaluate the Gamma integral sufficiently</span>
            <span class="c1"># accurately</span>

            <span class="n">top_val</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">gamma_inc</span><span class="p">(</span><span class="n">n</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="mf">1.0</span><span class="n">j</span><span class="p">)</span> <span class="o">*</span> <span class="n">r</span> <span class="o">*</span> <span class="n">k_top</span><span class="p">)</span>
            <span class="n">bot_val</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">gamma_inc</span><span class="p">(</span><span class="n">n</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="mf">1.0</span><span class="n">j</span><span class="p">)</span> <span class="o">*</span> <span class="n">r</span> <span class="o">*</span> <span class="n">k_bot</span><span class="p">)</span>
            <span class="n">segment</span> <span class="o">=</span> <span class="o">-</span> \
                <span class="p">((</span><span class="mf">1.0</span><span class="n">j</span><span class="p">)</span> <span class="o">**</span> <span class="p">(</span><span class="o">-</span><span class="n">n</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">P0</span> <span class="o">*</span>
                 <span class="p">(</span><span class="n">top_val</span> <span class="o">-</span> <span class="n">bot_val</span><span class="p">)</span> <span class="o">/</span> <span class="n">r</span> <span class="o">**</span> <span class="p">(</span><span class="n">n</span> <span class="o">+</span> <span class="mi">3</span><span class="p">))</span><span class="o">.</span><span class="n">imag</span>

        <span class="n">tot</span> <span class="o">+=</span> <span class="n">segment</span>

    <span class="n">tot</span> <span class="o">/=</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">tot</span>


<div class="viewcode-block" id="correlation_func"><a class="viewcode-back" href="../../../reference/analysis.html#pynbody.analysis.hmf.correlation_func">[docs]</a><span class="k">def</span> <span class="nf">correlation_func</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">log_r_min</span><span class="o">=-</span><span class="mi">3</span><span class="p">,</span> <span class="n">log_r_max</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">delta_log_r</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span>
                     <span class="n">pspec</span><span class="o">=</span><span class="n">PowerSpectrumCAMB</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    Calculate the linear density field correlation function.</span>

<span class="sd">    **Args**:</span>

<span class="sd">    *context* (SimSnap): The snapshot from which to pull the</span>
<span class="sd">        cosmological context (includes sigma8 normalization and growth</span>
<span class="sd">        function integrations, but does not currently affect transfer</span>
<span class="sd">        function)</span>

<span class="sd">    **Kwargs:**</span>

<span class="sd">      *log_r_min:* log10 of the minimum separation (Mpc h^-1) to</span>
<span class="sd">       consider</span>

<span class="sd">      *log_r_max:* log10 of the maximum separation (Mpc h^-1) to</span>
<span class="sd">       consider</span>

<span class="sd">      *delta_log_r:* The value spacing in dex</span>

<span class="sd">      *pspec:* A power spectrum object; default is a WMAP7 cosmology</span>
<span class="sd">        calculated by CAMB.</span>

<span class="sd">    **Returns:**</span>

<span class="sd">      *r:* Array of the r values (Mpc h^-1) for which the correlation</span>
<span class="sd">         function was evaluated.</span>

<span class="sd">      *Xi:* Array of the dimensionless correlation for each</span>
<span class="sd">       separation.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pspec</span><span class="p">,</span> <span class="nb">type</span><span class="p">):</span>
        <span class="n">pspec</span> <span class="o">=</span> <span class="n">pspec</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>

    <span class="n">r</span> <span class="o">=</span> <span class="p">(</span><span class="mf">10.0</span> <span class="o">**</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">log_r_min</span><span class="p">,</span> <span class="n">log_r_max</span> <span class="o">+</span> <span class="n">delta_log_r</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
                           <span class="n">delta_log_r</span><span class="p">))</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">pynbody</span><span class="o">.</span><span class="n">array</span><span class="o">.</span><span class="n">SimArray</span><span class="p">)</span>
    <span class="n">r</span><span class="o">.</span><span class="n">sim</span> <span class="o">=</span> <span class="n">context</span>
    <span class="n">r</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s2">&quot;Mpc h^-1 a&quot;</span>

    <span class="n">Xi_r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">correlation</span><span class="p">(</span><span class="n">ri</span><span class="p">,</span> <span class="n">pspec</span><span class="p">)</span>
                     <span class="k">for</span> <span class="n">ri</span> <span class="ow">in</span> <span class="n">r</span><span class="p">])</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">pynbody</span><span class="o">.</span><span class="n">array</span><span class="o">.</span><span class="n">SimArray</span><span class="p">)</span>
    <span class="n">Xi_r</span><span class="o">.</span><span class="n">sim</span> <span class="o">=</span> <span class="n">context</span>
    <span class="n">Xi_r</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

    <span class="k">return</span> <span class="n">r</span><span class="p">,</span> <span class="n">Xi_r</span></div>

<span class="c1">#######################################################################</span>
<span class="c1"># Default kernels for halo mass function</span>
<span class="c1">#######################################################################</span>


<div class="viewcode-block" id="f_press_schechter"><a class="viewcode-back" href="../../../reference/analysis.html#pynbody.analysis.hmf.f_press_schechter">[docs]</a><span class="k">def</span> <span class="nf">f_press_schechter</span><span class="p">(</span><span class="n">nu</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    The Press-Schechter kernel used by halo_mass_function</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">f</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">2.</span> <span class="o">/</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">*</span> <span class="n">nu</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">nu</span> <span class="o">*</span> <span class="n">nu</span> <span class="o">/</span> <span class="mf">2.</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">f</span></div>


<div class="viewcode-block" id="f_sheth_tormen"><a class="viewcode-back" href="../../../reference/analysis.html#pynbody.analysis.hmf.f_sheth_tormen">[docs]</a><span class="k">def</span> <span class="nf">f_sheth_tormen</span><span class="p">(</span><span class="n">nu</span><span class="p">,</span> <span class="n">Anorm</span><span class="o">=</span><span class="mf">0.3222</span><span class="p">,</span> <span class="n">a</span><span class="o">=</span><span class="mf">0.707</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="mf">0.3</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;   </span>
<span class="sd">    Sheth &amp; Tormen (1999) fit (see also Sheth Mo &amp; Tormen 2001)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1">#  Anorm: normalization, set so all mass is in halos (integral [f nu dn]=1)</span>
    <span class="c1">#  a: affects mainly the number of massive halo,</span>
    <span class="c1">#  a=0.75 is favored by Sheth &amp; Tormen (2002)</span>

    <span class="n">f</span> <span class="o">=</span> <span class="n">Anorm</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">2.</span> <span class="o">*</span> <span class="n">a</span> <span class="o">/</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">*</span> \
        <span class="p">(</span><span class="mf">1.</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">((</span><span class="mf">1.</span> <span class="o">/</span> <span class="n">a</span> <span class="o">/</span> <span class="n">nu</span> <span class="o">/</span> <span class="n">nu</span><span class="p">),</span> <span class="n">p</span><span class="p">))</span>
    <span class="n">f</span> <span class="o">*=</span> <span class="n">nu</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">a</span> <span class="o">*</span> <span class="n">nu</span> <span class="o">*</span> <span class="n">nu</span> <span class="o">/</span> <span class="mf">2.</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">f</span></div>


<span class="k">def</span> <span class="nf">f_jenkins</span><span class="p">(</span><span class="n">nu</span><span class="p">,</span> <span class="n">deltac</span><span class="o">=</span><span class="mf">1.68647</span><span class="p">):</span>
    <span class="c1"># Jenkins et al (2001) fit   ##  valid for  -1.2 &lt;&lt; ln(1/sigma) &lt;&lt; 1.05</span>
    <span class="n">sigma</span> <span class="o">=</span> <span class="n">deltac</span> <span class="o">/</span> <span class="n">nu</span>
    <span class="n">lnsigmainv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">1.</span> <span class="o">/</span> <span class="n">sigma</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">lnsigmainv</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mf">1.2</span><span class="p">))</span> <span class="ow">or</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">lnsigmainv</span> <span class="o">&gt;</span> <span class="mf">1.05</span><span class="p">))):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
            <span class="s2">&quot;Jenkins mass function is outsie of valid mass range.  Continuing calculations anyway.&quot;</span><span class="p">)</span>
    <span class="n">f</span> <span class="o">=</span> <span class="mf">0.315</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">fabs</span><span class="p">(</span><span class="n">lnsigmainv</span> <span class="o">+</span> <span class="mf">0.61</span><span class="p">)),</span> <span class="mf">3.8</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">f</span>


<span class="k">def</span> <span class="nf">f_warren</span><span class="p">(</span><span class="n">nu</span><span class="p">,</span> <span class="n">deltac</span><span class="o">=</span><span class="mf">1.68647</span><span class="p">):</span>
    <span class="c1">#  Warren et al. 2006  -- valid for (10**10 - 10**15 Msun/h)</span>
    <span class="n">sigma</span> <span class="o">=</span> <span class="n">deltac</span> <span class="o">/</span> <span class="n">nu</span>
    <span class="n">A</span> <span class="o">=</span> <span class="mf">0.7234</span>
    <span class="n">a</span> <span class="o">=</span> <span class="mf">1.625</span>
    <span class="n">b</span> <span class="o">=</span> <span class="mf">0.2538</span>
    <span class="n">c</span> <span class="o">=</span> <span class="mf">1.1982</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">A</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">sigma</span><span class="p">,</span> <span class="o">-</span><span class="n">a</span><span class="p">)</span> <span class="o">+</span> <span class="n">b</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">c</span> <span class="o">/</span> <span class="n">sigma</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">f</span>


<div class="viewcode-block" id="f_reed_no_z"><a class="viewcode-back" href="../../../reference/analysis.html#pynbody.analysis.hmf.f_reed_no_z">[docs]</a><span class="k">def</span> <span class="nf">f_reed_no_z</span><span class="p">(</span><span class="n">nu</span><span class="p">,</span> <span class="n">deltac</span><span class="o">=</span><span class="mf">1.68647</span><span class="p">):</span>  <span class="c1"># universal form</span>
    <span class="c1"># Reed et al. (2007) fit, eqn. 9 -- with no redshift depedence (simple</span>
    <span class="c1"># universal form)</span>
    <span class="sd">&quot;&quot;&quot; modified S-T fit  by the G1 gaussian term and c&quot;&quot;&quot;</span>
    <span class="n">sigma</span> <span class="o">=</span> <span class="n">deltac</span> <span class="o">/</span> <span class="n">nu</span>
    <span class="c1"># normalization that all mass is in halos not strictly conserved here</span>
    <span class="n">Anorm</span> <span class="o">=</span> <span class="mf">0.3222</span>
    <span class="n">a</span> <span class="o">=</span> <span class="mf">0.707</span>  <span class="c1"># affects mostly the number of massive halos</span>
    <span class="c1"># a=0.75    #  favored by Sheth &amp; Tormen (2002)</span>
    <span class="n">p</span> <span class="o">=</span> <span class="mf">0.3</span>
    <span class="n">c</span> <span class="o">=</span> <span class="mf">1.08</span>
    <span class="n">nu</span> <span class="o">=</span> <span class="n">deltac</span> <span class="o">/</span> <span class="n">sigma</span>
    <span class="n">lnsigmainv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">1.</span> <span class="o">/</span> <span class="n">sigma</span><span class="p">)</span>
    <span class="n">G1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">((</span><span class="n">lnsigmainv</span> <span class="o">-</span> <span class="mf">0.4</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mf">2.</span> <span class="o">*</span> <span class="mf">0.6</span> <span class="o">*</span> <span class="mf">0.6</span><span class="p">))</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">Anorm</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">2.</span> <span class="o">*</span> <span class="n">a</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">*</span> \
        <span class="p">(</span><span class="mf">1.</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">((</span><span class="mf">1.</span> <span class="o">/</span> <span class="n">a</span> <span class="o">/</span> <span class="n">nu</span> <span class="o">/</span> <span class="n">nu</span><span class="p">),</span> <span class="n">p</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.2</span> <span class="o">*</span> <span class="n">G1</span><span class="p">)</span>
    <span class="n">f</span> <span class="o">*=</span> <span class="n">nu</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">c</span> <span class="o">*</span> <span class="n">a</span> <span class="o">*</span> <span class="n">nu</span> <span class="o">*</span> <span class="n">nu</span> <span class="o">/</span> <span class="mf">2.</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">f</span></div>


<div class="viewcode-block" id="f_reed_z_evo"><a class="viewcode-back" href="../../../reference/analysis.html#pynbody.analysis.hmf.f_reed_z_evo">[docs]</a><span class="k">def</span> <span class="nf">f_reed_z_evo</span><span class="p">(</span><span class="n">nu</span><span class="p">,</span> <span class="n">neff</span><span class="p">,</span> <span class="n">deltac</span><span class="o">=</span><span class="mf">1.68647</span><span class="p">):</span>  <span class="c1"># non-universal form</span>
    <span class="c1"># Reed et al. (2007) fit, eqn. 11 -- with redshift depedence for accuracy</span>
    <span class="c1"># at z &gt;~ z_reion</span>
    <span class="sd">&quot;&quot;&quot; modified S-T fit  by the n_eff dependence and the G1 and G2 gaussian terms and c </span>
<span class="sd">    where   P(k) proportional to k_halo**(n_eff)  and  </span>
<span class="sd">    k_halo = Mhalo / r_halo_precollapse.  </span>
<span class="sd">    eqn 13 of Reed et al 2007   estimtes neff = 6 d ln(1/sigma(M))/ d ln M  - 3 &quot;&quot;&quot;</span>
    <span class="n">sigma</span> <span class="o">=</span> <span class="n">deltac</span> <span class="o">/</span> <span class="n">nu</span>
    <span class="c1"># normalization that all mass is in halos not strictly conserved here</span>
    <span class="n">Anorm</span> <span class="o">=</span> <span class="mf">0.3222</span>
    <span class="n">a</span> <span class="o">=</span> <span class="mf">0.707</span>  <span class="c1"># affects mostly the number of massive halos</span>
    <span class="c1"># a=0.75    #  favored by Sheth &amp; Tormen (2002)</span>
    <span class="n">p</span> <span class="o">=</span> <span class="mf">0.3</span>
    <span class="n">c</span> <span class="o">=</span> <span class="mf">1.08</span>
    <span class="n">nu</span> <span class="o">=</span> <span class="n">deltac</span> <span class="o">/</span> <span class="n">sigma</span>
    <span class="n">lnsigmainv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">1.</span> <span class="o">/</span> <span class="n">sigma</span><span class="p">)</span>
    <span class="n">G1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">((</span><span class="n">lnsigmainv</span> <span class="o">-</span> <span class="mf">0.4</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mf">2.</span> <span class="o">*</span> <span class="mf">0.6</span> <span class="o">*</span> <span class="mf">0.6</span><span class="p">))</span>
    <span class="n">G2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">((</span><span class="n">lnsigmainv</span> <span class="o">-</span> <span class="mf">0.75</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mf">2.</span> <span class="o">*</span> <span class="mf">0.2</span> <span class="o">*</span> <span class="mf">0.2</span><span class="p">))</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">Anorm</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">2.</span> <span class="o">*</span> <span class="n">a</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">+</span>
                                           <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">((</span><span class="mf">1.</span> <span class="o">/</span> <span class="n">a</span> <span class="o">/</span> <span class="n">nu</span> <span class="o">/</span> <span class="n">nu</span><span class="p">),</span> <span class="n">p</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.6</span> <span class="o">*</span> <span class="n">G1</span> <span class="o">+</span> <span class="mf">0.4</span> <span class="o">*</span> <span class="n">G2</span><span class="p">)</span>
    <span class="n">f</span> <span class="o">*=</span> <span class="n">nu</span> <span class="o">*</span> \
        <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">c</span> <span class="o">*</span> <span class="n">a</span> <span class="o">*</span> <span class="n">nu</span> <span class="o">*</span> <span class="n">nu</span> <span class="o">/</span> <span class="mf">2.</span> <span class="o">-</span> <span class="mf">0.03</span> <span class="o">/</span> <span class="p">(</span><span class="n">neff</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span>
               <span class="o">**</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">nu</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">f</span></div>


<span class="k">def</span> <span class="nf">f_bhattacharya</span><span class="p">(</span><span class="n">nu</span><span class="p">,</span> <span class="n">red</span><span class="p">,</span> <span class="n">deltac</span><span class="o">=</span><span class="mf">1.68647</span><span class="p">):</span>
    <span class="c1"># Bhattacharya et al. 2010  -- 6x10**11 - 310**15 Msun/h  z=0-2</span>
    <span class="n">sigma</span> <span class="o">=</span> <span class="n">deltac</span> <span class="o">/</span> <span class="n">nu</span>
    <span class="n">A</span> <span class="o">=</span> <span class="mf">0.333</span> <span class="o">/</span> <span class="nb">pow</span><span class="p">((</span><span class="mf">1.</span> <span class="o">+</span> <span class="n">red</span><span class="p">),</span> <span class="mf">0.11</span><span class="p">)</span>
    <span class="n">a</span> <span class="o">=</span> <span class="mf">0.788</span> <span class="o">/</span> <span class="nb">pow</span><span class="p">((</span><span class="mf">1.</span> <span class="o">+</span> <span class="n">red</span><span class="p">),</span> <span class="mf">0.01</span><span class="p">)</span>
    <span class="n">p</span> <span class="o">=</span> <span class="mf">0.807</span> <span class="o">/</span> <span class="nb">pow</span><span class="p">((</span><span class="mf">1.</span> <span class="o">+</span> <span class="n">red</span><span class="p">),</span> <span class="mf">0.0</span><span class="p">)</span>
    <span class="n">q</span> <span class="o">=</span> <span class="mf">1.795</span> <span class="o">/</span> <span class="nb">pow</span><span class="p">((</span><span class="mf">1.</span> <span class="o">+</span> <span class="n">red</span><span class="p">),</span> <span class="mf">0.0</span><span class="p">)</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">A</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">2.</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">((</span><span class="mf">1.</span> <span class="o">/</span> <span class="n">a</span> <span class="o">/</span> <span class="n">nu</span> <span class="o">/</span> <span class="n">nu</span><span class="p">),</span> <span class="n">p</span><span class="p">))</span>
    <span class="n">f</span> <span class="o">*=</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">nu</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">a</span><span class="p">),</span> <span class="n">q</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">a</span> <span class="o">*</span> <span class="n">nu</span> <span class="o">*</span> <span class="n">nu</span> <span class="o">/</span> <span class="mf">2.</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">f</span>


<span class="c1">#######################################################################</span>
<span class="c1"># Bias functions</span>
<span class="c1">#######################################################################</span>

<div class="viewcode-block" id="cole_kaiser_bias"><a class="viewcode-back" href="../../../reference/analysis.html#pynbody.analysis.hmf.cole_kaiser_bias">[docs]</a><span class="k">def</span> <span class="nf">cole_kaiser_bias</span><span class="p">(</span><span class="n">nu</span><span class="p">,</span> <span class="n">delta_c</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    The Cole-Kaiser (1989) bias function. Also in Mo &amp; White 1996.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="n">nu</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">delta_c</span></div>


<div class="viewcode-block" id="sheth_tormen_bias"><a class="viewcode-back" href="../../../reference/analysis.html#pynbody.analysis.hmf.sheth_tormen_bias">[docs]</a><span class="k">def</span> <span class="nf">sheth_tormen_bias</span><span class="p">(</span><span class="n">nu</span><span class="p">,</span> <span class="n">delta_c</span><span class="p">,</span>
                      <span class="n">a</span><span class="o">=</span><span class="mf">0.707</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="mf">0.6</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    The Sheth-Tormen (1999) bias function [eq 8]</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">root_a</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>

    <span class="k">return</span> <span class="mf">1.</span> <span class="o">+</span> <span class="p">(</span><span class="n">root_a</span> <span class="o">*</span> <span class="n">a</span> <span class="o">*</span> <span class="n">nu</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">root_a</span> <span class="o">*</span> <span class="n">b</span> <span class="o">*</span> <span class="p">(</span><span class="n">a</span> <span class="o">*</span> <span class="n">nu</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">**</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">c</span><span class="p">)</span>
                 <span class="o">-</span> <span class="p">(</span><span class="n">a</span> <span class="o">*</span> <span class="n">nu</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">**</span> <span class="n">c</span> <span class="o">/</span> <span class="p">((</span><span class="n">a</span> <span class="o">*</span> <span class="n">nu</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">**</span> <span class="n">c</span> <span class="o">+</span> <span class="n">b</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">c</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">c</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)))</span> \
        <span class="o">/</span> <span class="p">(</span><span class="n">root_a</span> <span class="o">*</span> <span class="n">delta_c</span><span class="p">)</span></div>

<span class="c1">#######################################################################</span>
<span class="c1"># The most useful function: halo_mass_function</span>
<span class="c1">#######################################################################</span>


<div class="viewcode-block" id="halo_mass_function"><a class="viewcode-back" href="../../../reference/analysis.html#pynbody.analysis.hmf.halo_mass_function">[docs]</a><span class="k">def</span> <span class="nf">halo_mass_function</span><span class="p">(</span><span class="n">context</span><span class="p">,</span>
                       <span class="n">log_M_min</span><span class="o">=</span><span class="mf">8.0</span><span class="p">,</span> <span class="n">log_M_max</span><span class="o">=</span><span class="mf">15.0</span><span class="p">,</span> <span class="n">delta_log_M</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
                       <span class="n">kern</span><span class="o">=</span><span class="s2">&quot;ST&quot;</span><span class="p">,</span>
                       <span class="n">pspec</span><span class="o">=</span><span class="n">PowerSpectrumCAMB</span><span class="p">,</span>
                       <span class="n">delta_crit</span><span class="o">=</span><span class="mf">1.686</span><span class="p">,</span>
                       <span class="n">no_h</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    Returns the halo mass function, dN/d log_{10} M in units of Mpc^-3</span>
<span class="sd">    h^3.</span>

<span class="sd">    **Args:**</span>

<span class="sd">    *context (SimSnap):* The snapshot from which to pull the</span>
<span class="sd">    cosmological context (includes sigma8 normalization and growth</span>
<span class="sd">    function integrations, but does not currently affect transfer</span>
<span class="sd">    function)</span>

<span class="sd">    **Kwargs:**</span>

<span class="sd">    *log_M_min:* The minimum halo mass (Msol h^-1) to consider</span>

<span class="sd">    *log_M_max:* The maximum halo mass (Msol h^-1) to consider</span>

<span class="sd">    *delta_log_M:* The bin spacing of halo masses (see warning below)</span>

<span class="sd">    *kern:* The kernel function which dictates what type of mass</span>
<span class="sd">    function to calculate; or a string (&quot;PS&quot; or &quot;ST&quot;) for one</span>
<span class="sd">    of the defaults</span>

<span class="sd">    *pspec:* A power spectrum object (which also defines the window</span>
<span class="sd">    function); default is a WMAP7 cosmology calculated by</span>
<span class="sd">    CAMB, and a top hat window</span>

<span class="sd">    *delta_crit:* The critical overdensity for collapse</span>

<span class="sd">    **Returns:**       </span>

<span class="sd">    *M:* The centre of the mass bins, in Msol h^-1</span>

<span class="sd">    *sigma:* The linear variance of the corresponding sphere</span>

<span class="sd">    *N:* The abundance of halos of that mass (Mpc^-3 h^3 comoving,</span>
<span class="sd">    per decade of mass)</span>

<span class="sd">    Because numerical derivatives are involved, the value of</span>
<span class="sd">    delta_log_M affects the accuracy. Numerical experiments suggest</span>
<span class="sd">    that delta_log_M=0.1 gives more than enough accuracy, but you</span>
<span class="sd">    should check for your own use case.</span>


<span class="sd">    Recommended m.f. for friends-of-friends linking length 0.2 particle sep.:</span>
<span class="sd">    z &lt;~ 2 : bhattacharya  </span>
<span class="sd">    z &gt;~ 5 : reed_universal (no redshift dependence)</span>
<span class="sd">    : or reed_evolving (w/redshift dependence for additional accuracy) </span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">kern</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">kern</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;PS&#39;</span><span class="p">:</span> <span class="n">f_press_schechter</span><span class="p">,</span>
                <span class="s1">&#39;ST&#39;</span><span class="p">:</span> <span class="n">f_sheth_tormen</span><span class="p">,</span>
                <span class="s1">&#39;J&#39;</span><span class="p">:</span> <span class="n">f_jenkins</span><span class="p">,</span>
                <span class="s1">&#39;W&#39;</span><span class="p">:</span> <span class="n">f_warren</span><span class="p">,</span>
                <span class="s1">&#39;REEDZ&#39;</span><span class="p">:</span> <span class="n">f_reed_z_evo</span><span class="p">,</span>
                <span class="c1"># Reed et al 2007 without redshift dependence</span>
                <span class="s1">&#39;REEDU&#39;</span><span class="p">:</span> <span class="n">f_reed_no_z</span><span class="p">,</span>
                <span class="s1">&#39;B&#39;</span><span class="p">:</span> <span class="n">f_bhattacharya</span><span class="p">}[</span><span class="n">kern</span><span class="p">]</span>

    <span class="n">rho_bar</span> <span class="o">=</span> <span class="n">cosmology</span><span class="o">.</span><span class="n">rho_M</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;Msol Mpc^-3 h^2&quot;</span><span class="p">)</span>
    <span class="n">red</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">]</span>  <span class="c1"># redshift is always set by simulation</span>

    <span class="n">M</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">log_M_min</span><span class="p">,</span> <span class="n">log_M_max</span><span class="p">,</span> <span class="n">delta_log_M</span><span class="p">)</span>
    <span class="n">M_mid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span>
        <span class="n">log_M_min</span> <span class="o">+</span> <span class="n">delta_log_M</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">log_M_max</span> <span class="o">-</span> <span class="n">delta_log_M</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">delta_log_M</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pspec</span><span class="p">,</span> <span class="nb">type</span><span class="p">):</span>
        <span class="n">pspec</span> <span class="o">=</span> <span class="n">pspec</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>

    <span class="n">sig</span> <span class="o">=</span> <span class="n">variance</span><span class="p">(</span><span class="mi">10</span> <span class="o">**</span> <span class="n">M</span><span class="p">,</span> <span class="n">pspec</span><span class="o">.</span><span class="n">_default_filter</span><span class="p">,</span> <span class="n">pspec</span><span class="p">)</span>  <span class="c1"># sigma(m)**2</span>

    <span class="n">nu</span> <span class="o">=</span> <span class="n">delta_crit</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">sig</span><span class="p">)</span>
    <span class="n">nu</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s2">&quot;1&quot;</span>

    <span class="n">nu_mid</span> <span class="o">=</span> <span class="p">(</span><span class="n">nu</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">+</span> <span class="n">nu</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span>

    <span class="n">d_ln_nu_d_ln_M</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">nu</span><span class="p">))</span> <span class="o">/</span> <span class="n">delta_log_M</span>

    <span class="n">dM</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="mi">10</span> <span class="o">**</span> <span class="n">M</span><span class="p">)</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">kern</span> <span class="o">==</span> <span class="n">f_reed_z_evo</span><span class="p">):</span>
        <span class="c1">##    neff = estimate_neffm(M)</span>
        <span class="n">neff</span> <span class="o">=</span> <span class="n">get_neffm</span><span class="p">(</span><span class="mf">10.</span> <span class="o">**</span> <span class="n">M</span><span class="p">,</span> <span class="n">sig</span> <span class="o">**</span> <span class="mf">0.5</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="p">(</span><span class="n">rho_bar</span> <span class="o">/</span> <span class="p">(</span><span class="mi">10</span> <span class="o">**</span> <span class="n">M_mid</span><span class="p">))</span> <span class="o">*</span> <span class="n">kern</span><span class="p">(</span><span class="n">nu_mid</span><span class="p">,</span> <span class="n">neff</span><span class="p">)</span> <span class="o">*</span> \
            <span class="n">d_ln_nu_d_ln_M</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">10.</span><span class="p">)</span> <span class="o">*</span> <span class="n">context</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">]</span> <span class="o">**</span> <span class="mi">3</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">kern</span> <span class="o">==</span> <span class="n">f_bhattacharya</span><span class="p">):</span>
       <span class="c1"># eq 7.46, Mo, van den Bosch and White</span>
        <span class="n">out</span> <span class="o">=</span> <span class="p">(</span><span class="n">rho_bar</span> <span class="o">/</span> <span class="p">(</span><span class="mi">10</span> <span class="o">**</span> <span class="n">M_mid</span><span class="p">))</span> <span class="o">*</span> <span class="n">kern</span><span class="p">(</span><span class="n">nu_mid</span><span class="p">,</span> <span class="n">red</span><span class="p">)</span> <span class="o">*</span> \
            <span class="n">d_ln_nu_d_ln_M</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">10.</span><span class="p">)</span> <span class="o">*</span> <span class="n">context</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">]</span> <span class="o">**</span> <span class="mi">3</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># eq 7.46, Mo, van den Bosch and White</span>
        <span class="n">out</span> <span class="o">=</span> <span class="p">(</span><span class="n">rho_bar</span> <span class="o">/</span> <span class="p">(</span><span class="mi">10</span> <span class="o">**</span> <span class="n">M_mid</span><span class="p">))</span> <span class="o">*</span> <span class="n">kern</span><span class="p">(</span><span class="n">nu_mid</span><span class="p">)</span> <span class="o">*</span> \
            <span class="n">d_ln_nu_d_ln_M</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">10.</span><span class="p">)</span> <span class="o">*</span> <span class="n">context</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">]</span> <span class="o">**</span> <span class="mi">3</span>
    <span class="n">out</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s2">&quot;Mpc^-3 h^3 a^-3&quot;</span>
    <span class="n">out</span><span class="o">.</span><span class="n">sim</span> <span class="o">=</span> <span class="n">context</span>

    <span class="n">M_mid</span> <span class="o">=</span> <span class="p">(</span><span class="mi">10</span> <span class="o">**</span> <span class="n">M_mid</span><span class="p">)</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">pynbody</span><span class="o">.</span><span class="n">array</span><span class="o">.</span><span class="n">SimArray</span><span class="p">)</span>
    <span class="n">M_mid</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s2">&quot;Msol h^-1&quot;</span>
    <span class="n">M_mid</span><span class="o">.</span><span class="n">sim</span> <span class="o">=</span> <span class="n">context</span>

    <span class="c1"># interpolate sigma for output checking purposes</span>
    <span class="n">sig</span> <span class="o">=</span> <span class="p">(</span><span class="n">sig</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">+</span> <span class="n">sig</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span>

    <span class="k">return</span> <span class="n">M_mid</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">sig</span><span class="p">),</span> <span class="n">out</span></div>


<div class="viewcode-block" id="halo_bias"><a class="viewcode-back" href="../../../reference/analysis.html#pynbody.analysis.hmf.halo_bias">[docs]</a><span class="nd">@units</span><span class="o">.</span><span class="n">takes_arg_in_units</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;Msol h^-1&quot;</span><span class="p">),</span> <span class="n">context_arg</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">halo_bias</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">kern</span><span class="o">=</span><span class="n">cole_kaiser_bias</span><span class="p">,</span> <span class="n">pspec</span><span class="o">=</span><span class="n">PowerSpectrumCAMB</span><span class="p">,</span>
              <span class="n">delta_crit</span><span class="o">=</span><span class="mf">1.686</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    Return the halo bias for the given halo mass.</span>

<span class="sd">    **Args:**</span>

<span class="sd">       *context (SimSnap):* The snapshot from which to pull the</span>
<span class="sd">        cosmological context</span>

<span class="sd">       *M:* float, unit or string describing the halo mass. If a</span>
<span class="sd">        float, units are Msol h^-1.</span>

<span class="sd">    **Kwargs:**</span>

<span class="sd">       *kern:* The kernel function describing the halo bias (default</span>
<span class="sd">        Cole-Kaiser).</span>

<span class="sd">       *pspec:* A power spectrum object (which also defines the window</span>
<span class="sd">              function); default is a WMAP7 cosmology calculated by</span>
<span class="sd">              CAMB, and a top hat window</span>

<span class="sd">       *delta_crit:* The critical overdensity for collapse</span>

<span class="sd">    **Returns:**</span>

<span class="sd">       The halo bias (single float)</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pspec</span><span class="p">,</span> <span class="nb">type</span><span class="p">):</span>
        <span class="n">pspec</span> <span class="o">=</span> <span class="n">pspec</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>

    <span class="n">sig</span> <span class="o">=</span> <span class="n">variance</span><span class="p">(</span><span class="n">M</span><span class="p">,</span> <span class="n">pspec</span><span class="o">.</span><span class="n">_default_filter</span><span class="p">,</span> <span class="n">pspec</span><span class="p">)</span>
    <span class="n">nu</span> <span class="o">=</span> <span class="n">delta_crit</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">sig</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">kern</span><span class="p">(</span><span class="n">nu</span><span class="p">,</span> <span class="n">delta_crit</span><span class="p">)</span></div>


<div class="viewcode-block" id="simulation_halo_mass_function"><a class="viewcode-back" href="../../../reference/analysis.html#pynbody.analysis.hmf.simulation_halo_mass_function">[docs]</a><span class="k">def</span> <span class="nf">simulation_halo_mass_function</span><span class="p">(</span><span class="n">snapshot</span><span class="p">,</span>
                                  <span class="n">log_M_min</span><span class="o">=</span><span class="mf">8.0</span><span class="p">,</span> <span class="n">log_M_max</span><span class="o">=</span><span class="mf">15.0</span><span class="p">,</span> <span class="n">delta_log_M</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
                                  <span class="n">masses</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mass_def</span><span class="o">=</span><span class="s2">&quot;halo_finder&quot;</span><span class="p">,</span> <span class="n">calculate_err</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                  <span class="n">subsample_catalogue</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    Construct the halo mass function from a halo catalogue by binning haloes in mass and counting them.</span>
<span class="sd">    This allows direct plotting of the simulation HMF against the theory HMF.</span>

<span class="sd">    **Args:**</span>

<span class="sd">       *snapshot (SimSnap):* The snapshot from which to calculate halo masses</span>

<span class="sd">    **Kwargs:**</span>

<span class="sd">        *log_M_min:* The minimum halo mass (Msol h^-1) to consider</span>

<span class="sd">        *log_M_max:* The maximum halo mass (Msol h^-1) to consider</span>

<span class="sd">        *delta_log_M:* The bin spacing of halo masses</span>

<span class="sd">        *masses: Provide array of halo masses in Msol h**-1. If none, this is calculated from the snapshot.</span>

<span class="sd">        *mass_def: Definition of the mass of a halo. Possible extensions could be M200_crit, M200_matter, Mvir etc...</span>

<span class="sd">        *err: If true, calculates error bars according to Poisson process.</span>

<span class="sd">        *subsample_catalogue: Sample the halo catalogue every int value. Mostly for speed and debugging issues.</span>
<span class="sd">        WARNING: If your halo catalogue is ordered, this method does not take responsability in randomising the catalogue so</span>
<span class="sd">        you might not recover the true HMF.</span>

<span class="sd">    **Returns:**</span>

<span class="sd">       The binned number density of haloes in this snapshot in comoving Mpc**-3 h**3 per decade of mass</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1">#Check that the mass resolution is uniform, this method does not handle otherwise</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">snapshot</span><span class="o">.</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;mass&#39;</span><span class="p">]))</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span> <span class="s2">&quot;The mass resolution of the snapshot is not uniform (e.g. zooms). This method&quot;</span>
                       <span class="s2">&quot;will not generate a correct HMF in this case.&quot;</span><span class="p">)</span>

    <span class="n">nbins</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="n">log_M_max</span> <span class="o">-</span> <span class="n">log_M_min</span><span class="p">)</span><span class="o">/</span><span class="n">delta_log_M</span><span class="p">)</span>
    <span class="n">bins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="n">log_M_min</span><span class="p">,</span> <span class="n">log_M_max</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="n">nbins</span><span class="p">,</span> <span class="n">base</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
    <span class="n">bin_centers</span> <span class="o">=</span> <span class="p">(</span><span class="n">bins</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">bins</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span> <span class="o">/</span> <span class="mi">2</span>

    <span class="k">if</span> <span class="n">subsample_catalogue</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">halo_catalogue</span> <span class="o">=</span> <span class="n">snapshot</span><span class="o">.</span><span class="n">halos</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">halo_catalogue</span> <span class="o">=</span> <span class="n">snapshot</span><span class="o">.</span><span class="n">halos</span><span class="p">()[::</span><span class="n">subsample_catalogue</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">masses</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Halo finder masses not provided. Calculating them (might take a while...)&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">mass_def</span><span class="o">==</span><span class="s2">&quot;halo_finder&quot;</span><span class="p">:</span>
            <span class="n">masses</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">h</span><span class="p">[</span><span class="s1">&#39;mass&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">in_units</span><span class="p">(</span><span class="s1">&#39;1 h**-1 Msol&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">halo_catalogue</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s2">&quot;Only halo finder mass is supported in this calculation for now&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">masses</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="o">**</span><span class="n">log_M_max</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">amin</span><span class="p">(</span><span class="n">masses</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="o">**</span><span class="n">log_M_min</span> <span class="p">:</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Your bin range does not encompass the full range of halo masses&quot;</span><span class="p">)</span>

    <span class="c1"># Calculate number of halos in each bin</span>
    <span class="n">num_halos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">masses</span><span class="p">,</span> <span class="n">bins</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">normalisation</span> <span class="o">=</span> <span class="p">(</span><span class="n">snapshot</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s1">&#39;boxsize&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">in_units</span><span class="p">(</span><span class="s1">&#39; a h**-1 Mpc&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">snapshot</span><span class="o">.</span><span class="n">conversion_context</span><span class="p">())</span> <span class="o">**</span> <span class="mi">3</span><span class="p">)</span>\
                    <span class="o">*</span> <span class="n">delta_log_M</span>

    <span class="k">if</span> <span class="n">calculate_err</span><span class="p">:</span>
        <span class="c1"># Calculate error bars assuming Poisson distribution in each bin</span>
        <span class="n">err</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">num_halos</span> <span class="p">)</span><span class="o">/</span><span class="n">normalisation</span>

    <span class="n">num_halos</span> <span class="o">=</span> <span class="n">num_halos</span>  <span class="o">/</span> <span class="n">normalisation</span>


    <span class="c1"># Make sure units are consistent</span>
    <span class="n">bin_centers</span> <span class="o">=</span> <span class="n">bin_centers</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">pynbody</span><span class="o">.</span><span class="n">array</span><span class="o">.</span><span class="n">SimArray</span><span class="p">)</span>
    <span class="n">bin_centers</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s2">&quot;Msol h**-1&quot;</span>
    <span class="n">bin_centers</span><span class="o">.</span><span class="n">context</span> <span class="o">=</span> <span class="n">snapshot</span>

    <span class="n">num_halos</span> <span class="o">=</span> <span class="n">num_halos</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">pynbody</span><span class="o">.</span><span class="n">array</span><span class="o">.</span><span class="n">SimArray</span><span class="p">)</span>
    <span class="n">num_halos</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s2">&quot;a**-3 Mpc**-3 h**3&quot;</span>
    <span class="n">num_halos</span><span class="o">.</span><span class="n">context</span> <span class="o">=</span> <span class="n">snapshot</span>

    <span class="k">if</span> <span class="n">calculate_err</span><span class="p">:</span>
        <span class="n">err</span> <span class="o">=</span> <span class="n">err</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">pynbody</span><span class="o">.</span><span class="n">array</span><span class="o">.</span><span class="n">SimArray</span><span class="p">)</span>
        <span class="n">err</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s2">&quot;a**-3 Mpc**-3 h**3&quot;</span>
        <span class="n">err</span><span class="o">.</span><span class="n">context</span> <span class="o">=</span> <span class="n">snapshot</span>
        <span class="k">return</span> <span class="n">bin_centers</span><span class="p">,</span> <span class="n">num_halos</span><span class="p">,</span> <span class="n">err</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">bin_centers</span><span class="p">,</span> <span class="n">num_halos</span></div>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<p class="logo">
  <a href="../../../index.html">
    <img class="logo" src="../../../_static/logo.svg" alt="Logo"/>
    
  </a>
</p>








<h3>Navigation</h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorials/tutorials.html">Tutorials &amp; walkthroughs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../reference/index.html">Reference</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../index.html">Documentation overview</a><ul>
  <li><a href="../../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2011-20, pynbody team.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 3.1.2</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>