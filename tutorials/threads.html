
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Use of multiple processors by pynbody &#8212; pynbody 1.0.0 documentation</title>
    <link rel="stylesheet" href="../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/graphviz.css" />
    <script id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Pynbody reference documentation" href="../reference/index.html" />
    <link rel="prev" title="Configuring pynbody" href="configuration.html" />

   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

<link href="https://fonts.googleapis.com/css?family=Quicksand" rel="stylesheet">
<link href="_static/customise.css" rel="stylesheet">
<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-38063425-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <div class="section" id="use-of-multiple-processors-by-pynbody">
<span id="threads"></span><h1>Use of multiple processors by pynbody<a class="headerlink" href="#use-of-multiple-processors-by-pynbody" title="Permalink to this headline">¶</a></h1>
<p>A large amount of the code in pynbody is designed to run on multiple processors
on a single shared-memory machine. There are three distinct ways in which
parallelization works in pynbody.</p>
<ol class="arabic simple">
<li><p><em>Native threading</em>, using the <cite>python</cite> module <code class="docutils literal notranslate"><span class="pre">threading</span></code>, or in C code,
the POSIX standard <code class="docutils literal notranslate"><span class="pre">pthread</span></code> library. On any modern Mac and Linux machine,
this “just works”. This is mainly used in the SPH module where we have
gone to some lengths to create algorithms that scale well to moderately
large numbers of cores (16 certainly, often 32) that you’d fine on a
typical analysis workstation.</p></li>
<li><p><em>OpenMP threading</em>. This is used by a large number of parts of the library,
for example some of the halo analysis code, where simple, inexpensive
parallelization is possible. If you have an OpenMP compiler this will also
“just work”. However, you might not do - <a class="reference internal" href="#openmp-fix"><span class="std std-ref">see below</span></a>.</p></li>
<li><p><em>Process threading</em>. This is currently used only by the ramses loader to
get around problems with the python GIL. It requires shared memory support,
for which you need the <a class="reference internal" href="#posix-ipc"><span class="std std-ref">the appropriate python module</span></a>.</p></li>
</ol>
<p>In cases (2) and (3), you may have to do some work to get everything working.
For (1), it should just work out the box.</p>
<div class="section" id="limiting-the-number-of-cpus-used-by-pynbody">
<h2>Limiting the number of CPUs used by pynbody<a class="headerlink" href="#limiting-the-number-of-cpus-used-by-pynbody" title="Permalink to this headline">¶</a></h2>
<p>In most cases, one just wants the code to be as responsive as possible and
so by default pynbody uses all CPUs on your machine.  However, sometimes this
is not so desirable - perhaps you need to leave resources for other users,
or for other processes you are running.</p>
<p>Therefore you can limit the number of processors used by pynbody, either
during a session or permanently. During a python session, you can type</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">pynbody</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;number_of_threads&#39;</span><span class="p">]</span><span class="o">=</span><span class="mi">2</span>
</pre></div>
</div>
<p>which, as an example, limits the number of CPUs in use to 2. To make the
change permanent, create a <code class="docutils literal notranslate"><span class="pre">.pynbodyrc</span></code> file in your home directory
with the following section:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>[general]
number-of-threads: 2
</pre></div>
</div>
<p>More information on the pynbody configuration system is
<a class="reference internal" href="configuration.html#configuration"><span class="std std-ref">available here</span></a>.</p>
</div>
<div class="section" id="checking-and-fixing-openmp-support">
<span id="openmp-fix"></span><h2>Checking and fixing OpenMP support<a class="headerlink" href="#checking-and-fixing-openmp-support" title="Permalink to this headline">¶</a></h2>
<p>If pynbody is installed on a machine without OpenMP support, it’ll normally
throw up some complaint during the installation procedure. The installation
will succeed, but many parallel procedures will run only on one core.</p>
<p>To check if this has happened to you, try the following commands</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [1]: </span><span class="kn">import</span> <span class="nn">pynbody</span>

<span class="gp">In [2]: </span><span class="n">pynbody</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;number_of_threads&#39;</span><span class="p">]</span>
<span class="gh">Out[2]: </span><span class="go">8</span>
</pre></div>
</div>
<p>So far, we can see that the main pynbody configuration has seen more than
one core on the machine. But let’s see how many cores OpenMP can see:</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [3]: </span><span class="n">pynbody</span><span class="o">.</span><span class="n">openmp</span><span class="o">.</span><span class="n">get_cpus</span><span class="p">()</span>
<span class="gh">Out[3]: </span><span class="go">1</span>
</pre></div>
</div>
<p>If this number is larger than one, OpenMP support is enabled and you don’t
need to do anything more. If it’s 1, however, OpenMP support is disabled
and you’re losing out.</p>
<p>This happens when, during setup, pynbody could not find the OpenMP library.
The most common scenario where this happens is on a Mac - Apple’s default
compilers do not support OpenMP. A fast solution is to download
the latest GNU compilers <a class="reference external" href="http://hpc.sourceforge.net">http://hpc.sourceforge.net</a>, install them, and
point the setup procedure to gcc. At your shell, something like this would do
it -</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ <span class="nb">export</span> <span class="nv">CC</span><span class="o">=</span><span class="s1">&#39;/usr/local/bin/gcc&#39;</span>
$ <span class="nb">cd</span> pynbody
$ rm -rf build/
$ pip install .
</pre></div>
</div>
<p>Now, with luck, you’ll see that OpenMP is enabled.</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [1]: </span><span class="kn">import</span> <span class="nn">pynbody</span>

<span class="gp">In [2]: </span><span class="n">pynbody</span><span class="o">.</span><span class="n">openmp</span><span class="o">.</span><span class="n">get_cpus</span><span class="p">()</span>
<span class="gh">Out[2]: </span><span class="go">8</span>
</pre></div>
</div>
<p>If you’re still having trouble, you can try
<a class="reference internal" href="../index.html#getting-help"><span class="std std-ref">asking us for further help</span></a>.</p>
</div>
<div class="section" id="parallel-ramses-reader-support">
<span id="posix-ipc"></span><h2>Parallel ramses reader support<a class="headerlink" href="#parallel-ramses-reader-support" title="Permalink to this headline">¶</a></h2>
<p>The ramses reader speeds up load times by using multiple concurrent
processes to read files. There are two differences between this and the
standard threading techniques used above.</p>
<p>First, the correct number of processes to use may not be the number of CPUs
on your machine - it’s tied more to IO performance than to raw computing power.
Second, for technical reasons related to the
<a class="reference external" href="https://wiki.python.org/moin/GlobalInterpreterLock">Python GIL</a>
you need an extra module to make this work. The module is known as <code class="docutils literal notranslate"><span class="pre">posix_ipc</span></code>,
and it normally compiles very straight-forwardly on Linux or Mac OS. At your
standard command prompt just type:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ easy_install posix_ipc
</pre></div>
</div>
<p>and you should be done. There’s not even any need to reinstall pynbody.</p>
<p>As explained above, you may well want to change the number of
processes used for the reading process. This can be done using pynbody’s
standard <a class="reference internal" href="configuration.html#configuration"><span class="std std-ref">configuration</span></a> system; for instance, create a
<code class="docutils literal notranslate"><span class="pre">.pynbodyrc</span></code> file in your home directory with the following
section:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>[ramses]
parallel-read: 4
</pre></div>
</div>
<p>This specifies 4 processes. You can experiment with this number to
see what works best on your system, which depends on a combination
of CPU and IO performance.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Many systems limit the amount of shared memory available,
which can cause problems once you enable parallel-reading. See
<a class="reference internal" href="../pitfalls.html#pitfall-ramses-sharedmem"><span class="std std-ref">our separate note on this issue</span></a>.</p>
</div>
</div>
</div>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<p class="logo">
  <a href="../index.html">
    <img class="logo" src="../_static/logo.svg" alt="Logo"/>
    
  </a>
</p>








<h3>Navigation</h3>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../installation.html">Installation</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="tutorials.html">Tutorials &amp; walkthroughs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/index.html">Reference</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../index.html">Documentation overview</a><ul>
  <li><a href="tutorials.html">Pynbody Tutorials</a><ul>
      <li>Previous: <a href="configuration.html" title="previous chapter">Configuring pynbody</a></li>
      <li>Next: <a href="../reference/index.html" title="next chapter">Pynbody reference documentation</a></li>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2011-20, pynbody team.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 3.1.2</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="../_sources/tutorials/threads.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>